# 関心の分離について - Hidariude プロジェクト分析（実装マッピング付き）

## 概要

このドキュメントは、Hidariude Java Web アプリケーションの関心の分離（Separation of Concerns）を、実際のディレクトリ構成・クラス分割・URL ルーティング・画面（JSP）までひも付けて説明します。

## プロジェクト概要

-   **技術スタック**: Java 24, Jakarta Servlet 6.x, JSP/JSTL, PostgreSQL
-   **アーキテクチャ**: レイヤードアーキテクチャ（Controller / Service / DAO / Domain / DTO / Validation / View）
-   **業務領域**: 顧客管理・秘書管理・アサイン管理・タスク管理・請求/支払サマリー

## アーキテクチャ概観

```
┌─────────────────────────────────────┐
│        Presentation Layer           │ ← JSP/JSPF（/WEB-INF/jsp/...）
│             (View)                  │
├─────────────────────────────────────┤
│         Controller Layer            │ ← FrontController（単一入口）
├─────────────────────────────────────┤
│         Service Layer               │ ← 業務ロジック/トランザクション
├─────────────────────────────────────┤
│        Validation Layer             │ ← 入力検証/エラー蓄積
├─────────────────────────────────────┤
│           DTO Layer                 │ ← DB行/転送用構造
├─────────────────────────────────────┤
│          Domain Layer               │ ← 画面/業務向けエンティティ
├─────────────────────────────────────┤
│           DAO Layer                 │ ← SQL実行/ResultSet→DTO
└─────────────────────────────────────┘
```

## ディレクトリと責務の分割

-   `src/main/java/controller`

    -   `FrontController.java`: 単一エントリポイント（@WebServlet）。ロール別で `adminExecute` / `secretaryExecute` / `customerExecute` にディスパッチ。共通セッションチェックと forward/redirect 制御。

-   `src/main/java/service`

    -   業務単位のサービスに分割：`CommonService` / `CustomerService` / `SecretaryService` / `AssignmentService` / `TaskService` / `InvoiceService` / `SalesCostSummaryService` / `SystemAdminService` / `ProfileService` など。
    -   `BaseService`: `HttpServletRequest` と `Validation` を保持。`REDIRECT_ERROR` をロール別エラーページに合わせて設定。
    -   トランザクションは各メソッド内で `try (TransactionManager tm = new TransactionManager()) { ... tm.commit(); }` のパターンで境界を張る。

-   `src/main/java/dao`

    -   エンティティ/用途ごとに DAO を分割：`CustomerDAO` / `SecretaryDAO` / `AssignmentDAO` / `TaskDAO` / `InvoiceDAO` / `CustomerMonthlyInvoiceDAO` / `TaskRankDAO` / `ProfileDAO` など。
    -   `BaseDAO`: DAO 共通で `Connection` を保持。
    -   `TransactionManager`: AutoCloseable・明示 `commit()`/`rollback()`・close 時に確定/破棄。
    -   `SqlLoader`: クラスパス上の `.sql` 読込ユーティリティ（キャッシュ付）。

-   `src/main/java/domain`

    -   画面/サービスが扱うビジネスオブジェクト（`Customer` / `Secretary` / `Assignment` / `Task` / ほか集計系）。

-   `src/main/java/dto`

    -   DB 行/結合結果を運ぶ転送用構造体（JDBC 型含む）。
    -   `service.Converter` が DTO→Domain（および必要に応じ Domain→DTO）を担当。

-   `src/main/java/validation`

    -   `Validation`: 必須/形式（UUID, yearMonth, email, phone, postal）/金額検証、エラーメッセージの蓄積。

-   `src/main/webapp/WEB-INF/jsp`
    -   ロール・機能ごとにディレクトリ分割：
        -   `common/{admin,secretary,customer}`（ログイン/ホーム/エラー）
        -   `customer/admin`, `secretary/admin`, `systemadmin/admin`, `assignment/admin`, `task/{admin,secretary,customer}` など
        -   `invoice/{admin,secretary,customer}`（サマリー・Excel テンプレは `WEB-INF/templates/invoice.xlsx`）
    -   共通部品 `_parts/{admin,secretary,customer}/navbar.jspf` など。

## ルーティング → サービス → JSP の対応（抜粋）

-   入口: `/admin/*`, `/secretary/*`, `/customer/*` を `FrontController` が受ける。ルート（末尾なし）は `web.xml` の exact mapping で同一サーブレットに到達。
-   ロール別 `switch(pathInfo)` でサービス呼出し、戻り値の文字列で JSP を forward（`/WEB-INF/jsp/${nextPath}.jsp`）。先頭 `/` の場合は redirect。

-   管理者（/admin）

    -   顧客一覧: `CustomerService#customerList()` → `customer/admin/home`
    -   顧客詳細: `CustomerService#customerDetail()` → `customer/admin/detail`
    -   顧客登録/編集/削除: `CustomerService#customerRegister*() / #customerEdit*() / #customerDelete()`
    -   秘書一覧/登録/編集/削除: `SecretaryService` → `secretary/admin/*`
    -   アサイン一覧/登録/PM 登録/引継/継続単価編集/削除: `AssignmentService` → `assignment/admin/*`
    -   タスク一覧（全件/承認済/未承認/差戻）・一括承認/取消/差戻/アラート: `TaskService` → `task/admin/*`
    -   サマリー（売上/支払）: `InvoiceService#adminInvoiceSummary()` → `invoice/admin/sales`, `InvoiceService#secretaryInvoiceSummary()` → `invoice/admin/costs`

-   秘書（/secretary）

    -   タスク登録/編集/削除/一覧: `TaskService` → `task/secretary/*`
    -   マイページ閲覧/編集: `SecretaryService#myPage*()` → `mypage/secretary/*`
    -   自身の請求サマリー表示/Excel 発行: `InvoiceService#invoiceSummery()` → `invoice/secretary/summary`, `#issueInvoiceExcel(res)` はダウンロード応答で forward しない

-   顧客（/customer）
    -   顧客担当者の登録/編集/削除: `ContactService` → `contact/admin/*`（顧客側入口は `FrontController#customerExecute`）
    -   請求サマリー: `InvoiceService#customerInvoiceSummary()` → `invoice/customer/summary`
    -   委託先一覧/秘書プロフィール: `AssignmentService#outsourceList()`, `#secretaryProfile()` → `assignment/customer/*`
    -   タスク一覧/確認申請（アラート）: `TaskService#customerTaskList()`, `#customerTaskAlert()` → `task/customer/*`

## サービス層の典型パターン

-   入力検証: `Validation` で `isUuid`/`isYearMonth`/`isEmail`/`mustBeMoneyOrZero` 等を実施し、エラーは `errorMsg` に蓄積して JSP に渡す。
-   トランザクション: `try (TransactionManager tm = new TransactionManager()) { DAO呼出し; tm.commit(); }`。例外時は `RuntimeException` を握ってエラー遷移。
-   画面遷移: ビュー名や属性キーは定数化（例: `VIEW_*`, `A_*`, `P_*`）。`BaseService.REDIRECT_ERROR` はロール別の `/common/*/error` を指す。
-   変換: DAO が返す DTO を `Converter` で Domain に詰替えて JSP に渡す（合計/分数計算やグルーピングもサービスで実施）。

## DAO 層の典型パターン

-   `BaseDAO` で `Connection` を受け取り保持。各 DAO は SQL 実行と ResultSet→DTO 変換に専念。
-   代表的なメソッド例：
    -   `SecretaryDAO.selectAll()/selectAllPM()/mailCheckExceptId(...)`
    -   `AssignmentDAO.selectAllByMonthFiltered(...)/existsDuplicate(...)/updateIncentivesByPairAndMonth(...)`
    -   `TaskDAO.selectByMonth(...)/approve(...)/unapprove(...)/remand(...)/alertDelete(...)`
    -   `InvoiceDAO.selectAdminLines(...)/selectTasksByMonthAndCustomer(...)/upsertSecretaryMonthlySummary(...)`

## JSP（Presentation）構成

-   共通: `_parts/{role}/navbar.jspf` を `include`。
-   ロール × 機能でディレクトリ分割し、サービスの戻り値（例: `task/admin/list_unapproved`）がそのまま JSP 相対パスとなる設計。

## 代表的フロー（具体例）

-   管理者がアサイン登録（通常）

    1. `/admin/assignment/register?id=...&companyName=...` → `AssignmentService#assignmentRegister()`
    2. `ProfileDAO` で候補抽出 → `assignment/admin/register` 表示
    3. POST → `assignmentRegisterCheck()` → 表示用名称の解決
    4. POST → `assignmentRegisterDone()` → 重複検査 → `dao.insert()` → `tm.commit()` → `assignment/admin/register_done`

-   秘書がタスク登録

    1. `/secretary/task/register` → 当月の自分 × 全顧客アサインを付与
    2. POST `taskRegisterDone()` → 分計算, YM 整合チェック → `TaskDAO.insert()` → `tm.commit()` → 未承認一覧へ PRG

-   顧客が請求サマリー閲覧
    1. `/customer/invoice` → `InvoiceService#customerInvoiceSummary()`
    2. `InvoiceDAO` で明細+集計取得 → 合計算出 → `invoice/customer/summary`

## 優れている点

-   **単一入口のルーティング**: `FrontController` に集約、`web.xml` の exact mapping と注釈の併用でルート/ワイルドカードをカバー。
-   **明確な分割**: Service は業務単位・DAO はテーブル/機能単位に分離。DTO/Domain/Converter で型・責務を整理。
-   **一貫した Tx/Validation**: 例外時のエラー遷移、ビュー/属性キーの定数化で可読性・保守性が高い。

## 改善ポイント（実装に基づく具体化）

-   **Controller の肥大化**: `FrontController` の `switch` が長大。コマンド/アクションのテーブル化やサブコントローラ導入で縮減可能。
-   **Service での画面別定数の重複**: ビュー名・属性キーが各クラスに散在。共通のナビゲーション/キー定義クラスで集中管理可。
-   **例外型の粒度**: `RuntimeException` 握りが多い。DAO/Service で粒度の揃った例外を定義し、ハンドリング方針を明示。
-   **DI/テスト**: `new TransactionManager()`/`new XXXDAO(conn)` 直書き依存。コンストラクタインジェクション導入で単体テストしやすく。

---

最終更新: 2025-10-22（実装走査に基づく更新）
分析対象: Hidariude Java Web Application
