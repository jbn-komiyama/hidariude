# 43_ランク一覧表示（A07_01）

## 機能概要

業務ランク（task_ranks）と秘書ランク（secretary_ranks）の一覧を表示する機能です。各ランクの基本単価、増額単価、説明を確認できます。マスタデータの参照専用機能として実装されています。

## 実装状況

**未実装**

**注意**: 本機能はマスタ管理の一部として必要な機能ですが、現時点では専用の画面・サービスは実装されていません。以下は実装時の設計指針を示したものです。

## URL一覧（実装時の想定）

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/master/ranks` | ランク一覧表示 | 業務ランクと秘書ランクの一覧を表示 |

## 画面フロー（実装時の想定）

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ マスタ管理 → ランク一覧リンククリック
    ↓ GET /admin/master/ranks
    ↓
[ランク一覧画面]
    - 業務ランク一覧
      - ランク名（A/B/C/D/E/PM）
      - 顧客向け基本単価
      - 秘書向け基本単価
    - 秘書ランク一覧
      - ランク名（シニア/エキスパート/マスター）
      - 顧客向け増額単価
      - 秘書向け増額単価
      - 説明
    ↓
    └─ 参照のみ（編集・削除機能は無し）
```

## バックエンド処理詳細（実装時の想定）

### サービスクラス

- **クラス**: RankService.java（未実装）
- **メソッド**: `listRanks()`（想定）: ランク一覧表示

### 処理フロー（実装時の想定）

#### 1. ランク一覧表示（GET `/admin/master/ranks`）

1. **業務ランク取得**
   - `TaskRankDAO.selectAll()` で全業務ランクを取得
   - 論理削除されていないランクのみ取得（`deleted_at IS NULL`）
   - 戻り値: `List<TaskRankDTO>`

2. **秘書ランク取得**
   - `SecretaryRankDAO.selectAll()` で全秘書ランクを取得（未実装）
   - 論理削除されていないランクのみ取得（`deleted_at IS NULL`）
   - 戻り値: `List<SecretaryRankDTO>`

3. **DTO→Domain変換**
   - `TaskRankDTO` → `TaskRank`
   - `SecretaryRankDTO` → `SecretaryRank`

4. **画面用属性設定**
   - `taskRanks`: 業務ランク一覧（List<TaskRank>）
   - `secretaryRanks`: 秘書ランク一覧（List<SecretaryRank>）

5. **ビューへフォワード**
   - ランク一覧ビュー（`master/admin/ranks`）へフォワード

### トランザクション管理（実装時の想定）

```java
public String listRanks() {
    try (TransactionManager tm = new TransactionManager()) {
        TaskRankDAO taskRankDao = new TaskRankDAO(tm.getConnection());
        SecretaryRankDAO secretaryRankDao = new SecretaryRankDAO(tm.getConnection());

        /** 業務ランク取得 */
        List<TaskRankDTO> taskRankDTOs = taskRankDao.selectAll();
        List<TaskRank> taskRanks = taskRankDTOs.stream()
            .map(dto -> conv.toDomain(dto))
            .collect(Collectors.toList());

        /** 秘書ランク取得 */
        List<SecretaryRankDTO> secretaryRankDTOs = secretaryRankDao.selectAll();
        List<SecretaryRank> secretaryRanks = secretaryRankDTOs.stream()
            .map(dto -> conv.toDomain(dto))
            .collect(Collectors.toList());

        /** JSP 属性 */
        req.setAttribute("taskRanks", taskRanks);
        req.setAttribute("secretaryRanks", secretaryRanks);

        return VIEW_RANKS;  // "master/admin/ranks"

    } catch (RuntimeException e) {
        e.printStackTrace();
        return req.getContextPath() + req.getServletPath() + "/error";
    }
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

### DAO呼び出し

- **TaskRankDAO**（実装済み）
  - `selectAll()`: 全業務ランクを取得（48行目）
    - SQL: `SQL_SELECT_BASE`（24行目）
    - WHERE: `deleted_at IS NULL`
    - 取得項目: `id, rank_name, base_pay_customer, base_pay_secretary, created_at, updated_at, deleted_at`

- **SecretaryRankDAO**（未実装）
  - `selectAll()`: 全秘書ランクを取得（想定）
    - SQL: `SELECT id, rank_name, description, increase_base_pay_customer, increase_base_pay_secretary, created_at, updated_at, deleted_at FROM secretary_ranks WHERE deleted_at IS NULL`
    - 取得項目: `id, rank_name, description, increase_base_pay_customer, increase_base_pay_secretary, created_at, updated_at, deleted_at`

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **論理削除フィルタ**: 削除済みランクは表示されない（`deleted_at IS NULL`）
- **参照専用**: 編集・削除機能は提供しない（マスタデータの保護）

## ビューファイル（実装時の想定）

- **ランク一覧画面**: /WEB-INF/jsp/master/admin/ranks.jsp（未実装）

### 画面表示項目（実装時の想定）

#### 業務ランク一覧

リクエスト属性 `taskRanks` (List<TaskRank>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **ランク名** | 業務ランク名（A/B/C/D/E/PM） |
| **顧客向け基本単価** | 顧客に請求する基本時給（basePayCustomer） |
| **秘書向け基本単価** | 秘書に支払う基本時給（basePaySecretary） |
| **登録日時** | レコード作成日時（createdAt） |
| **更新日時** | レコード更新日時（updatedAt） |

#### 秘書ランク一覧

リクエスト属性 `secretaryRanks` (List<SecretaryRank>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **ランク名** | 秘書ランク名（シニア/エキスパート/マスター） |
| **説明** | ランクの説明（description） |
| **顧客向け増額単価** | 顧客請求に追加される時給増額（increaseBasePayCustomer） |
| **秘書向け増額単価** | 秘書支払に追加される時給増額（increaseBasePaySecretary） |
| **登録日時** | レコード作成日時（createdAt） |
| **更新日時** | レコード更新日時（updatedAt） |

### 画面アクション

- **参照のみ**: 編集・削除機能は提供しない

## データモデル

### 使用するDTO

- **TaskRankDTO** ([dto/TaskRankDTO.java](../../../src/main/java/dto/TaskRankDTO.java))（実装済み）
  - 業務ランク情報
  - `id`: ランクID（UUID）
  - `rankName`: ランク名（String）
  - `basePayCustomer`: 顧客向け基本単価（BigDecimal）
  - `basePaySecretary`: 秘書向け基本単価（BigDecimal）
  - `createdAt`: 登録日時（Timestamp）
  - `updatedAt`: 更新日時（Timestamp）
  - `deletedAt`: 論理削除日時（Timestamp）

- **SecretaryRankDTO** ([dto/SecretaryRankDTO.java](../../../src/main/java/dto/SecretaryRankDTO.java))（実装済み）
  - 秘書ランク情報
  - `id`: ランクID（UUID）
  - `rankName`: ランク名（String）
  - `description`: 説明（String）
  - `increaseBasePayCustomer`: 顧客向け増額単価（BigDecimal）
  - `increaseBasePaySecretary`: 秘書向け増額単価（BigDecimal）
  - `createdAt`: 登録日時（Timestamp）
  - `updatedAt`: 更新日時（Timestamp）
  - `deletedAt`: 論理削除日時（Timestamp）

### 使用するDomainオブジェクト

- **TaskRank** ([domain/TaskRank.java](../../../src/main/java/domain/TaskRank.java))（未実装）
  - 業務ランク情報（ビュー層用）
  - フィールド構成はTaskRankDTOと同様（Date型を使用）

- **SecretaryRank** ([domain/SecretaryRank.java](../../../src/main/java/domain/SecretaryRank.java))（実装済み）
  - 秘書ランク情報（ビュー層用）
  - フィールド構成はSecretaryRankDTOと同様（Date型を使用）

### リクエスト属性（実装時の想定）

- **taskRanks** (List<TaskRank>): 業務ランク一覧
- **secretaryRanks** (List<SecretaryRank>): 秘書ランク一覧

### データベーステーブル

#### task_ranks（業務ランク）

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | UUID | 主キー |
| rank_no | INTEGER | ランク番号（並び順） |
| rank_name | VARCHAR | ランク名（A/B/C/D/E/PM） |
| base_pay_customer | NUMERIC(10,2) | 顧客向け基本単価 |
| base_pay_secretary | NUMERIC(10,2) | 秘書向け基本単価 |
| created_at | TIMESTAMP | 登録日時 |
| updated_at | TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMP | 論理削除日時 |

#### secretary_ranks（秘書ランク）

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | UUID | 主キー |
| rank_name | VARCHAR | ランク名（シニア/エキスパート/マスター） |
| description | TEXT | ランクの説明 |
| increase_base_pay_customer | NUMERIC(10,2) | 顧客向け増額単価 |
| increase_base_pay_secretary | NUMERIC(10,2) | 秘書向け増額単価 |
| created_at | TIMESTAMP | 登録日時 |
| updated_at | TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMP | 論理削除日時 |

## エラーハンドリング（実装時の想定）

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）

## 備考

### マスタデータとしてのランク

- **業務ランク**: タスクの難易度・専門性によるランク
  - A: 高度な専門業務
  - B: 専門業務
  - C: 標準業務
  - D: 軽作業
  - E: 簡易作業
  - PM: プロジェクトマネジメント業務

- **秘書ランク**: 秘書の経験・スキルによるランク
  - シニア: ベテラン秘書（増額単価あり）
  - エキスパート: 専門秘書（増額単価あり）
  - マスター: トップクラス秘書（増額単価あり）
  - （無ランク: 通常秘書、増額単価なし）

### ランクの使用箇所

1. **アサイン登録**: 顧客×秘書×業務ランクを紐付け
2. **単価計算**:
   - 顧客請求額 = 業務ランク基本単価 + 秘書ランク増額単価 + インセンティブ
   - 秘書支払額 = 業務ランク基本単価 + 秘書ランク増額単価 + インセンティブ
3. **業務登録**: 業務ランクを指定してタスクを登録
4. **請求・支払**: ランク情報を含めて集計

### マスタ管理の位置づけ

- **参照専用**: 編集・削除機能は提供しない
- **理由**: ランクマスタの変更は既存アサイン・タスクに影響するため、慎重な運用が必要
- **変更方法**: データベース直接更新またはマイグレーションファイルで管理

### 初期データ

初期データは `DatabaseInitListener` で自動投入されます。

**業務ランク（task_ranks）**:
- A: 顧客10,000円/秘書8,000円
- B: 顧客8,000円/秘書6,400円
- C: 顧客6,000円/秘書4,800円
- D: 顧客4,000円/秘書3,200円
- E: 顧客2,000円/秘書1,600円
- PM: 顧客12,000円/秘書9,600円

**秘書ランク（secretary_ranks）**:
- シニア: 顧客+1,000円/秘書+800円
- エキスパート: 顧客+2,000円/秘書+1,600円
- マスター: 顧客+3,000円/秘書+2,400円

### 実装優先度

- **優先度**: 低
- **理由**:
  - マスタデータの参照はアサイン登録画面などで行われている
  - 専用の一覧画面がなくても業務に支障はない
  - 変更頻度が低いため、参照専用画面の必要性は低い

### 実装時の注意点

1. **SecretaryRankDAO.selectAll()** の実装が必要
2. **TaskRank ドメインクラス** の作成が必要
3. **DTO→Domain変換ロジック** の実装が必要
4. **JSPビュー** の作成が必要
5. **FrontController** へのルーティング追加が必要

### 使用場面（実装時の想定）

- ランクマスタの確認
- 新規秘書・顧客へのランク説明
- 単価体系の確認
- アサイン登録時の参照

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): ランク情報を使用
- **秘書アサイン登録** (25_秘書アサイン登録.md): 業務ランクを選択
- **業務登録** (17_業務登録.md): 業務ランクを選択
- **請求サマリー表示** (39_請求サマリー表示.md): ランク別集計
