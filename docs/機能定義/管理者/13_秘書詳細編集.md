# 13_秘書詳細編集（A04_08）

## 機能概要

既存の秘書情報を編集する機能です。入力→確認→確定の3画面構成で、基本情報、連絡先、秘書情報（PM対応、ランク）を編集できます。メールアドレスと秘書コードの重複チェック（自ID除外）を実施します。口座情報は本機能では編集できません（秘書本人のマイページ編集で可能）。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/secretary/edit?id={秘書ID}` | 編集フォーム表示 | 指定IDの秘書情報を取得し、編集フォームを表示 |
| POST | `/admin/secretary/edit_check` | 編集確認 | 入力内容をバリデーション後、確認画面を表示 |
| POST | `/admin/secretary/edit_done` | 編集確定 | データベースを更新し、完了画面を表示 |

## 画面フロー

```
[秘書一覧画面] または [秘書詳細画面]
    ↓ 編集ボタンをクリック
    ↓ GET /admin/secretary/edit?id={UUID}
    ↓ データベースから既存情報を取得
    ↓ 秘書ランク一覧を取得
    ↓
[編集入力画面] - 現在の情報が初期表示
    ↓ 基本情報、連絡先、秘書情報を編集
    ↓ POST /admin/secretary/edit_check
    |
    ├─ バリデーションエラー → [編集入力画面] へ戻る
    ├─ メール重複エラー → [編集入力画面] へ戻る
    ├─ 秘書コード重複エラー → [編集入力画面] へ戻る
    └─ バリデーションOK → [編集確認画面] へ遷移
        ↓ 確定ボタンをクリック
        ↓ POST /admin/secretary/edit_done
        |
        ├─ メール重複エラー → [編集入力画面] へ戻る
        ├─ 秘書コード重複エラー → [編集入力画面] へ戻る
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 更新成功 → [編集完了画面] を表示
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SecretaryService.java](../../../src/main/java/service/SecretaryService.java)
- **メソッド**:
  - `secretaryEdit()` (356行目): 編集フォーム表示
  - `secretaryEditCheck()` (389行目): 編集確認
  - `secretaryEditDone()` (433行目): 編集確定

### 処理フロー

#### 1. 編集フォーム表示（GET `/admin/secretary/edit?id={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 編集対象の秘書ID（UUID形式）
   - `validation.isUuid(uuidStr)` でUUID形式チェック
   - 不正な形式の場合: "不正なIDが指定されました。" エラー

2. **既存データ取得**
   - `SecretaryDAO.selectByUUIdWithBank(id)` で秘書情報を取得（口座情報含む）
   - 存在しない場合: NULLまたは空のDTO
   - DTO → Domainオブジェクトに変換

3. **秘書ランク一覧取得**
   - `SecretaryDAO.selectRankAll()` で秘書ランク一覧を取得
   - DTO → Domainオブジェクトのリストに変換

4. **フォーム表示**
   - `secretary` 属性に既存データを設定
   - `ranks` 属性にランク一覧を設定
   - 編集ビュー（`secretary/admin/edit`）へフォワード

#### 2. 編集確認（POST `/admin/secretary/edit_check`）

1. **入力パラメータ取得**
   - `id`: 秘書ID（hidden）
   - `secretaryCode`: 秘書コード（任意）
   - `name`: 氏名（必須）
   - `mail`: メールアドレス（必須）
   - `phone`: 電話番号（任意）
   - `postalCode`: 郵便番号（任意）

2. **バリデーション（必須・形式チェック）**
   - 必須チェック:
     - `validation.isNull("名前", name)`
     - `validation.isNull("メールアドレス", mail)`
   - 形式チェック（入力がある場合のみ）:
     - `validation.isPostalCode(postalCode)` - 郵便番号形式
     - `validation.isPhoneNumber(phone)` - 電話番号形式
     - `validation.isEmail(mail)` - メールアドレス形式

3. **重複チェック（自ID除外）**
   - バリデーションエラーがない場合のみ実施
   - `SecretaryDAO.mailCheckExceptId(mail, id)` で自ID以外でメール重複確認
   - 重複時: "登録いただいたメールアドレスはすでに使われています。" エラー
   - `SecretaryDAO.secretaryCodeCheckExceptId(secretaryCode, id)` で自ID以外で秘書コード重複確認
   - 重複時: "登録いただいた秘書コードはすでに使われています。" エラー

4. **エラー時の処理**
   - `errorMsg` 属性にエラーメッセージを設定
   - ID、入力値を属性に戻す（フォーム再表示用）
   - 編集入力画面へ戻る

5. **成功時の処理**
   - ID、入力値を属性に設定
   - 確認画面（`secretary/admin/edit_check`）へフォワード

#### 3. 編集確定（POST `/admin/secretary/edit_done`）

1. **入力パラメータ取得・バリデーション**
   - 確認画面と同じパラメータを再取得
   - 追加パラメータ:
     - `nameRuby`: ふりがな（任意）
     - `address1`: 住所1（任意）
     - `address2`: 住所2（任意）
     - `building`: 建物名（任意）
     - `pmSecretary`: PM秘書フラグ（true/false）
     - `secretaryRankId`: 秘書ランクID（必須）
   - 必須チェック:
     - `validation.isNull("ID", idStr)`
     - `validation.isNull("名前", name)`
     - `validation.isNull("メールアドレス", mail)`
   - 形式チェック（入力がある場合のみ）
   - 秘書ランク選択チェック: 未選択の場合 "秘書ランクを選択してください。" エラー

2. **重複チェック（再実行）**
   - `SecretaryDAO.mailCheckExceptId(mail, id)` で自ID以外でメール重複チェック
   - `SecretaryDAO.secretaryCodeCheckExceptId(secretaryCode, id)` で自ID以外で秘書コード重複チェック
   - 重複時: エラーメッセージを設定して編集入力画面へ戻る

3. **エラー時の処理**
   - `errorMsg` 属性にエラーメッセージを設定
   - ID、入力値を属性に戻す（フォーム再表示用）
   - 編集入力画面へ戻る

4. **更新データ作成**
   - DTOオブジェクトに新しい値を設定:
     - `id`: 秘書ID（UUID）
     - `secretaryCode`: 秘書コード
     - `name`: 氏名
     - `nameRuby`: ふりがな
     - `mail`: メールアドレス
     - `phone`: 電話番号
     - `postalCode`: 郵便番号
     - `address1`: 住所1
     - `address2`: 住所2
     - `building`: 建物名
     - `pmSecretary`: PM秘書フラグ（Boolean）
     - `secretaryRankId`: 秘書ランクID（UUID）

5. **データベース更新**
   - `SecretaryDAO.update(dto)` で更新実行
   - トランザクションコミット

6. **完了画面表示**
   - `message` 属性に "更新が完了しました（件数:1）" を設定
   - 完了画面（`secretary/admin/edit_done`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    SecretaryDAO dao = new SecretaryDAO(tm.getConnection());
    UUID id = UUID.fromString(idStr);

    /** 念のため再チェック */
    if (notBlank(mail) && dao.mailCheckExceptId(mail, id)) {
        validation.addErrorMsg("登録いただいたメールアドレスはすでに使われています。");
    }
    if (notBlank(secretaryCode) && dao.secretaryCodeCheckExceptId(secretaryCode, id)) {
        validation.addErrorMsg("登録いただいた秘書コードはすでに使われています。");
    }
    if (validation.hasErrorMsg()) {
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        req.setAttribute(P_ID, idStr);
        pushFormBackToRequest();
        return VIEW_EDIT;
    }

    SecretaryDTO dto = new SecretaryDTO();
    dto.setId(id);
    dto.setSecretaryCode(secretaryCode);
    dto.setName(name);
    dto.setNameRuby(nameRuby);
    dto.setMail(mail);
    dto.setPhone(phone);
    dto.setPostalCode(postalCode);
    dto.setAddress1(address1);
    dto.setAddress2(address2);
    dto.setBuilding(building);
    dto.setPmSecretary(Boolean.parseBoolean(pmSecretaryStr));
    dto.setSecretaryRankId(UUID.fromString(secretaryRankId));

    int num = dao.update(dto);
    tm.commit();

    req.setAttribute(A_MESSAGE, "更新が完了しました（件数:" + num + "）");
    return VIEW_EDIT_DONE;

} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **SecretaryDAO**
  - `selectByUUIdWithBank(UUID id)`: 秘書情報を取得（口座情報含む）
    - SQL: `SELECT s.*, b.* FROM secretaries s LEFT JOIN bank_accounts b ON s.id = b.secretary_id WHERE s.deleted_at IS NULL AND s.id = ?`
  - `selectRankAll()`: 秘書ランク一覧を取得
    - SQL: `SELECT * FROM secretary_ranks ORDER BY rank_name`
  - `mailCheckExceptId(String mail, UUID exceptId)`: 自ID以外でメール重複チェック
    - SQL: `SELECT COUNT(*) FROM secretaries WHERE mail = ? AND id != ? AND deleted_at IS NULL`
  - `secretaryCodeCheckExceptId(String code, UUID exceptId)`: 自ID以外で秘書コード重複チェック
    - SQL: `SELECT COUNT(*) FROM secretaries WHERE secretary_code = ? AND id != ? AND deleted_at IS NULL`
  - `update(SecretaryDTO dto)`: 秘書情報を更新（口座情報は含まない）
    - SQL:
      ```sql
      UPDATE secretaries
      SET secretary_code = ?, mail = ?, secretary_rank_id = ?, is_pm_secretary = ?,
          name = ?, name_ruby = ?, phone = ?,
          postal_code = ?, address1 = ?, address2 = ?, building = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
      ```

### セキュリティ

- **メール重複チェック**: 自分以外のアカウントとの重複を防止
  - 確認画面と確定処理の両方で実施（二重チェック）
- **秘書コード重複チェック**: 自分以外のアカウントとの重複を防止
  - 確認画面と確定処理の両方で実施（二重チェック）
- **二重バリデーション**: 確認画面と確定処理で2回検証（改ざん対策）
- **UUID検証**: 不正なID形式をエラーとして処理

## ビューファイル

- **編集入力画面**: [/WEB-INF/jsp/secretary/admin/edit.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/edit.jsp)
- **編集確認画面**: [/WEB-INF/jsp/secretary/admin/edit_check.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/edit_check.jsp)
- **編集完了画面**: [/WEB-INF/jsp/secretary/admin/edit_done.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/edit_done.jsp)

### 画面表示項目（編集入力画面）

#### 基本情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **ID** | - | 秘書ID（hidden、変更不可） |
| **秘書コード** | - | 秘書を識別するコード（任意、空白可） |
| **氏名** | ○ | 秘書の氏名 |
| **ふりがな** | - | 氏名のふりがな |
| **メールアドレス** | ○ | ログインIDとして使用、重複不可（自ID除く） |

#### 連絡先

| 項目 | 必須 | 説明 |
|-----|------|------|
| **電話番号** | - | 連絡先電話番号 |
| **郵便番号** | - | 郵便番号（形式チェックあり） |
| **住所1** | - | 都道府県・市区町村 |
| **住所2** | - | 番地 |
| **建物名・部屋番号** | - | 建物名・部屋番号 |

#### 秘書情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **PM対応** | - | PM秘書かどうか（チェックボックス） |
| **秘書ランク** | ○ | 秘書ランク（A/B/C/D/E から選択） |

**注意**: 口座情報は本機能では編集できません（秘書本人のマイページ編集で可能）

### 画面アクション

- **確認ボタン**: POST `/admin/secretary/edit_check` でバリデーション実行
- **戻るボタン**: 一覧画面または詳細画面へ戻る

## データモデル

### 使用するDTO

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - `id` (UUID): 秘書ID（変更不可）
  - `secretaryCode` (String): 秘書コード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `mail` (String): メールアドレス
  - `phone` (String): 電話番号
  - `postalCode` (String): 郵便番号
  - `address1` (String): 住所1
  - `address2` (String): 住所2
  - `building` (String): 建物名・部屋番号
  - `pmSecretary` (Boolean): PM秘書フラグ
  - `secretaryRankId` (UUID): 秘書ランクID
  - `updatedAt` (Timestamp): 更新日時（自動更新）

- **SecretaryRankDTO** ([dto/SecretaryRankDTO.java](../../../src/main/java/dto/SecretaryRankDTO.java))
  - `id` (UUID): ランクID
  - `rankName` (String): ランク名（A/B/C/D/E）
  - `description` (String): 説明
  - `increaseBasePayCustomer` (Integer): 顧客向け基本単価増額
  - `increaseBasePaySecretary` (Integer): 秘書向け基本単価増額

### 使用するDomainオブジェクト

- **Secretary** ([domain/Secretary.java](../../../src/main/java/domain/Secretary.java))
  - SecretaryRankオブジェクトを含むネスト構造

- **SecretaryRank** ([domain/SecretaryRank.java](../../../src/main/java/domain/SecretaryRank.java))
  - ランク情報

### リクエスト属性

- **secretary** (Secretary): 編集対象の秘書情報（初期表示用）
- **ranks** (List<SecretaryRank>): 秘書ランク一覧（セレクトボックス用）
- **errorMsg** (String): バリデーションエラーメッセージ
- **message** (String): 更新完了メッセージ
- **id** (String): 秘書ID（hidden用）
- **入力値の属性**（エラー時の再表示用）

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: "名前 を入力してください" など
- **メール形式エラー**: "メールアドレス の形式が正しくありません"
- **郵便番号形式エラー**: "郵便番号 の形式が正しくありません"
- **電話番号形式エラー**: "電話番号 の形式が正しくありません"
- **秘書ランク未選択エラー**: "秘書ランクを選択してください。"

### ビジネスロジックエラー

- **メール重複エラー**: "登録いただいたメールアドレスはすでに使われています。"
  - 編集入力画面へ戻り、入力値を保持
- **秘書コード重複エラー**: "登録いただいた秘書コードはすでに使われています。"
  - 編集入力画面へ戻り、入力値を保持
- **ID形式エラー**: "不正なIDが指定されました。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

- 更新日時（`updated_at`）は自動更新される
- 作成日時（`created_at`）、削除日時（`deleted_at`）は変更されない
- 最終ログイン日時（`last_login_at`）は変更されない
- パスワードは本機能では変更できない（秘書本人のマイページ編集で可能）
- 口座情報は本機能では編集できない（秘書本人のマイページ編集で可能）
- 編集完了後、一覧画面へ戻るリンクが表示される
- メールアドレス変更時、既存のパスワードは維持される
- 秘書コードは空白にすることも可能（任意項目）
- PM秘書フラグはチェックボックスで変更可能
- 秘書ランクは必須項目で、A/B/C/D/Eから選択
- 秘書ランク変更時、既存のアサインには影響しない（過去データは保持）
