# 33_業務差戻し（A05_22）

## 機能概要

タスクを差戻す機能です。承認を保留し、秘書に修正・再提出を促します。差戻し時にはコメント入力が必須です。差戻されたタスクは `remanded_at` タイムスタンプが設定され、承認情報はクリアされます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| POST | `/admin/task/remand_done?taskId={タスクID}&remandComment={コメント}&yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 差戻し実行 | 指定されたタスクを差戻す |

## 画面フロー

```
[業務一覧画面（全件タブ）]
    ↓ 差戻しボタンクリック
    ↓ ダイアログ表示（コメント入力）
    ↓ POST /admin/task/remand_done
    |   - taskId: タスクID
    |   - remandComment: 差戻しコメント（任意）
    |   - yearMonth: 対象月
    |   - sec: 秘書名検索値（絞込維持用）
    |   - cust: 顧客名検索値（絞込維持用）
    ↓
[差戻し処理実行]
    - remanded_at に現在時刻を設定
    - remanded_by に差戻し実行者（管理者）IDを設定
    - remand_comment に入力されたコメントを設定
    - approved_at, approved_by をクリア（承認情報を削除）
    ↓
    ├─ コメント未入力
    |   └─ エラーにならない（コメントは任意）
    |
    └─ 正常処理
        ↓ トランザクションコミット
        ↓ GET /admin/task/list_all?yearMonth={年月}&sec={秘書名}&cust={顧客名}
        ↓
        [業務一覧画面（全件タブ）]（差戻し後、絞込条件維持）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**: `adminTaskRemandDone()` (770行目): 差戻し実行

### 処理フロー

#### 1. 差戻し実行（POST `/admin/task/remand_done`）

1. **パラメータ取得**
   - `taskId`: タスクID（UUID形式、必須）
   - `remandComment`: 差戻しコメント（任意、空文字可）
   - `yearMonth`: 対象月（yyyy-MM形式、任意）
   - `sec`: 秘書名検索値（任意、絞込維持用）
   - `cust`: 顧客名検索値（任意、絞込維持用）

2. **バリデーション**
   - `taskId` の UUID形式チェック
   - エラー時: エラーページへリダイレクト
   - エラーメッセージ: "差戻対象IDが不正です。"

3. **差戻し実行者ID取得**
   - セッションから `LoginUser` を取得
   - `LoginUser.getSystemAdmin().getId()` で差戻し実行者IDを取得
   - セッションがない場合は差戻し実行者IDを null に設定

4. **差戻し処理**
   - `TaskDAO.remand(taskId, remanderId, comment)` で差戻し処理
   - SQL: `UPDATE tasks SET remanded_at = NOW(), remanded_by = ?, remand_comment = ?, approved_at = NULL, approved_by = NULL, updated_at = NOW() WHERE id = ? AND deleted_at IS NULL`
   - 処理内容:
     - `remanded_at`: 現在時刻を設定
     - `remanded_by`: 差戻し実行者IDを設定
     - `remand_comment`: 入力されたコメントを設定
     - `approved_at`, `approved_by`: NULL に設定（承認情報をクリア）
     - `updated_at`: 現在時刻を設定

5. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

6. **リダイレクト**
   - 全件一覧へリダイレクト（絞込条件を維持）
   - リダイレクト先: `/admin/task/list_all?yearMonth={年月}&sec={秘書名}&cust={顧客名}`

### トランザクション管理

```java
public String adminTaskRemandDone() {
    final String idStr   = req.getParameter("taskId");
    final String comment = Optional.ofNullable(req.getParameter("remandComment")).orElse("");
    final String ym      = Optional.ofNullable(req.getParameter(P_YEAR_MONTH)).orElse("");
    final String sec     = Optional.ofNullable(req.getParameter(P_SEC_NAME)).orElse("");
    final String cust    = Optional.ofNullable(req.getParameter(P_CUST_NAME)).orElse("");

    if (!validation.isUuid(idStr)) {
        validation.addErrorMsg("差戻対象IDが不正です。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return req.getContextPath() + req.getServletPath() + "/error";
    }

    UUID remanderId = null;
    HttpSession session = req.getSession(false);
    if (session != null) {
        LoginUser lu = (LoginUser) session.getAttribute(ATTR_LOGIN_USER);
        if (lu != null && lu.getSystemAdmin() != null) remanderId = lu.getSystemAdmin().getId();
    }

    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        dao.remand(UUID.fromString(idStr), remanderId, comment);
        tm.commit();  // 明示的コミット
    } catch (RuntimeException e) {
        validation.addErrorMsg("差戻に失敗しました。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return req.getContextPath() + req.getServletPath() + "/error";
    }
    return req.getContextPath() + "/admin/task/list_all?yearMonth=" + urlEnc(ym)
            + "&sec=" + urlEnc(sec) + "&cust=" + urlEnc(cust);
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- URLエンコードでクエリパラメータを安全に処理

### DAO呼び出し

- **TaskDAO**
  - `remand(UUID taskId, UUID remandedBy, String comment)`: タスク差戻し
    - SQL: 動的SQL（1142行目）
    - 処理:
      - `remanded_at = NOW()`: 現在時刻を設定
      - `remanded_by = ?`: 差戻し実行者IDを設定
      - `remand_comment = ?`: コメントを設定
      - `approved_at = NULL`, `approved_by = NULL`: 承認情報をクリア
      - `updated_at = NOW()`: 現在時刻を設定
    - 条件: `id = ? AND deleted_at IS NULL`
    - 影響行数を返す

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なIDを拒否
- **論理削除フィルタ**: 削除済みタスクは差戻しできない
- **URLエンコーディング**: クエリパラメータの安全な処理
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **全件一覧画面**: [/WEB-INF/jsp/task/admin/list_all.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_all.jsp)

### 画面表示項目

#### 差戻しボタン

| 項目 | 説明 |
|-----|------|
| **差戻しボタン** | 各タスク行に表示 |
| **ダイアログ** | コメント入力欄を含むモーダルダイアログ |
| **コメント入力欄** | 差戻し理由を入力（任意） |

### 画面アクション

- **差戻しボタン**: タスクを差戻す（`/admin/task/remand_done`）
  - POST メソッドでリクエスト
  - ダイアログでコメント入力
  - 実行後は全件一覧へリダイレクト（絞込条件を維持）

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `remanded_at`: 差戻し日時
  - `remanded_by`: 差戻し実行者ID
  - `remand_comment`: 差戻しコメント
  - `approved_at`: 承認日時（差戻し時にクリア）
  - `approved_by`: 承認者ID（差戻し時にクリア）

### URLパラメータ

- **taskId** (String): タスクID（UUID形式）
- **remandComment** (String): 差戻しコメント（任意）
- **yearMonth** (String): 対象月（yyyy-MM形式、絞込維持用）
- **sec** (String): 秘書名検索値（絞込維持用）
- **cust** (String): 顧客名検索値（絞込維持用）

## エラーハンドリング

### バリデーションエラー

- **UUID形式エラー**: UUID形式以外のIDが指定された場合
  - エラーページへリダイレクト
  - エラーメッセージ: "差戻対象IDが不正です。"

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- **差戻し失敗**: エラーメッセージ "差戻に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- コメントが空文字の場合でも正常に処理（コメントは任意）
- 既に差戻し済みのタスクでも再度差戻し可能（上書き）

## 備考

### 差戻しの仕様

- **差戻し日時**: `remanded_at` に現在時刻（NOW()）を設定
- **差戻し実行者**: `remanded_by` に差戻し実行者（管理者）IDを設定
- **差戻しコメント**: `remand_comment` に入力されたコメントを設定（空文字可）
- **承認情報のクリア**: `approved_at`, `approved_by` を NULL に設定
- **更新日時**: `updated_at` に現在時刻を設定

### 承認情報のクリア

- 差戻し処理により、承認情報（`approved_at`, `approved_by`）がクリアされる
- 承認済みタスクを差戻すことで、未承認状態に戻る
- 再度承認が必要になる

### コメントの扱い

- コメントは任意（空文字可）
- 画面のダイアログで入力を促すが、必須ではない
- 秘書への修正指示として利用される

### 差戻し実行者IDの設定

- セッションから取得した管理者IDを設定
- セッションがない場合は null を設定（差戻し実行者不明として記録）

### 絞込条件の維持

- 差戻し後のリダイレクト時、元の絞込条件（yearMonth, sec, cust）を維持
- URLエンコードで安全に処理

### リダイレクト先

- 差戻し後は全件一覧へリダイレクト
- 差戻しタブではなく全件タブへ遷移（差戻し結果を確認しやすい）

### 使用場面

- 業務内容の確認
- 不備のある業務の修正依頼
- 承認保留
- 秘書への再提出依頼

### 秘書側の対応

- 差戻されたタスクは秘書の「差戻しタブ」に表示される
- 秘書は差戻しコメントを確認して修正・再提出する
- 編集画面で「差戻し解除」チェックを付けることで、`remanded_at` をクリア可能

### 関連機能

- **業務一覧表示** (30_業務一覧表示.md): 差戻しタスクの一覧表示
- **業務承認** (32_業務承認.md): 差戻しの代わりに承認
- **承認済み業務取消し** (34_承認済み業務取消し.md): 承認の取消
