# 41_売上サマリー表示（A06_81）

## 機能概要

顧客×月のピボット形式で売上サマリーを表示する機能です。会計年度（4月開始）の12ヶ月分の売上額を一覧表示し、月別の列合計と行別の合計、総合計を確認できます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/summary/sales?fy={年度}` | 売上サマリー表示 | 顧客×月の売上をピボット表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 売上サマリーリンククリック
    ↓ GET /admin/summary/sales?fy={年度}
    ↓ クエリパラメータで制御：
    |   - fy: 会計年度（4月開始、省略時は今日から推定）
    ↓
[売上サマリー画面] (sales.jsp)
    - 会計年度表示（例: 2025年度 = 2025-04 ～ 2026-03）
    - ピボットテーブル
      - 行: 顧客名
      - 列: 12ヶ月（4月～翌3月）
      - セル: 売上金額
      - 行合計: 各顧客の年間売上
      - 列合計: 各月の全顧客売上
      - 総合計: 年間総売上
    ↓
    └─ 年度変更: プルダウンで年度を選択して表示更新
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SalesCostSummaryService.java](../../../src/main/java/service/SalesCostSummaryService.java)
- **メソッド**: `salesSummary()` (91行目): 売上サマリー表示

### 処理フロー

#### 1. 売上サマリー表示（GET `/admin/summary/sales`）

1. **パラメータ取得・会計年度決定**
   - `fy`: 会計年度（4月開始）
   - 省略時または不正値の場合: 今日から推定
     - 4～12月: その年がFY
     - 1～3月: 前年がFY
   - `resolveFiscalYear()` ヘルパーメソッドで処理（178行目）

2. **12ヶ月のリスト生成**
   - `buildFiscalMonths(fy)` で対象FYの12ヶ月を生成（197行目）
   - 例: FY=2025 → ["2025-04", "2025-05", ..., "2026-03"]
   - yyyy-MM形式の文字列リスト

3. **期間範囲の確定**
   - `fromYm`: months[0]（最初の月、例: 2025-04）
   - `toYm`: months[11]（最後の月、例: 2026-03）

4. **売上データ取得**
   - `CustomerMonthlyInvoiceDAO.selectSalesByCustomerMonth(fromYm, toYm, months)` を呼び出し
   - `customer_monthly_invoices` テーブルから集計
   - 顧客×月の売上をピボット形式で取得
   - 戻り値: `List<PivotRowDTO>`
     - 各行は1顧客を表す
     - `label`: 顧客名
     - `amountByYm`: Map<年月, 金額>（12ヶ月分）
     - `rowTotal`: 行合計

5. **列合計・総合計の計算**
   - `calcColTotals(months, rows)` で各月の列合計を計算（214行目）
   - `calcGrand(colTotals)` で総合計を計算（232行目）
   - Map<年月, 金額> と BigDecimal で管理

6. **画面用属性設定**
   - `fy`: 会計年度（int）
   - `months`: 12ヶ月のリスト（List<String>）
   - `rows`: ピボット行（List<PivotRowDTO>）
   - `colTotals`: 列合計（Map<String, BigDecimal>）
   - `grandTotal`: 総合計（BigDecimal）

7. **ビューへフォワード**
   - 売上サマリービュー（`summary/admin/sales`）へフォワード

### トランザクション管理

```java
public String salesSummary() {
    try (TransactionManager tm = new TransactionManager()) {
        final int fy = resolveFiscalYear(req.getParameter(P_FY));
        final List<String> months = buildFiscalMonths(fy);

        /** 期間（最初と最後のYM） */
        final String fromYm = months.get(0);
        final String toYm   = months.get(months.size() - 1);

        /** DAO 呼び出し：顧客×月の売上ピボット */
        CustomerMonthlyInvoiceDAO dao = new CustomerMonthlyInvoiceDAO(tm.getConnection());
        List<PivotRowDTO> rows = dao.selectSalesByCustomerMonth(fromYm, toYm, months);

        /** 列合計・総合計 */
        Map<String, BigDecimal> colTotals = calcColTotals(months, rows);
        BigDecimal grand = calcGrand(colTotals);

        /** JSP へ */
        req.setAttribute(A_FY, fy);
        req.setAttribute(A_MONTHS, months);
        req.setAttribute(A_ROWS, rows);
        req.setAttribute(A_COLTOTAL, colTotals);
        req.setAttribute(A_GRAND, grand);

        return VIEW_SALES;

    } catch (RuntimeException e) {
        /** 例外時は既存のキー "errorMsg" でエラーメッセージを渡す（他画面と統一） */
        validation.addErrorMsg("データベースに不正な操作が行われました");
        req.setAttribute("errorMsg", validation.getErrorMsg());
        return req.getContextPath() + req.getServletPath() + "/error";
    }
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ
- エラー時はエラーページへリダイレクト

### DAO呼び出し

- **CustomerMonthlyInvoiceDAO**
  - `selectSalesByCustomerMonth(String fromYm, String toYm, List<String> months)`: 売上ピボット取得（153行目）
    - SQL: `SQL_SALES_BY_CUSTOMER_MONTH`（35行目）
    - JOIN: `customer_monthly_invoices → customers`
    - WHERE: `deleted_at IS NULL AND target_year_month BETWEEN ? AND ?`
    - GROUP BY: `customer_id, company_name, target_year_month`
    - ORDER BY: `company_name, target_year_month`
    - Java側でピボット整形
      - 顧客IDごとに行を作成
      - 存在しない月は0で埋める
      - 行合計を計算

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **論理削除フィルタ**: 削除済み顧客・請求データは表示されない（`deleted_at IS NULL`）
- **会計年度の範囲制限**: 年度パラメータは2000～2100年の範囲で入力可能（JSP側で制限）

## ビューファイル

- **売上サマリー画面**: [/WEB-INF/jsp/summary/admin/sales.jsp](../../../src/main/webapp/WEB-INF/jsp/summary/admin/sales.jsp)

### 画面表示項目

#### ヘッダー部

| 項目 | 説明 |
|-----|------|
| **会計年度** | 表示中の会計年度（例: 2025） |
| **期間表示** | 最初の月～最後の月（例: 2025-04 ～ 2026-03） |
| **年度選択** | プルダウンで年度を選択（2000～2100年） |

#### ピボットテーブル

リクエスト属性 `rows` (List<PivotRowDTO>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **顧客名** | 行ヘッダー（label） |
| **4月～3月** | 各月の売上金額（amountByYm[月]） |
| **行合計** | 各顧客の年間売上（rowTotal） |

#### フッター部

リクエスト属性 `colTotals`, `grandTotal` から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **列合計** | 各月の全顧客売上合計（colTotals[月]） |
| **総合計** | 年間総売上（grandTotal） |

### 画面アクション

- **年度変更**: 年度プルダウンで年度を選択し、「表示」ボタンをクリック
- **スクロール**: 横スクロールで12ヶ月のデータを確認

## データモデル

### 使用するDTO

- **PivotRowDTO** ([dto/PivotRowDTO.java](../../../src/main/java/dto/PivotRowDTO.java))
  - ピボット行データ
  - `id`: 顧客ID（UUID）
  - `label`: 顧客名（String）
  - `amountByYm`: 月別金額マップ（Map<String, BigDecimal>）
  - `rowTotal`: 行合計（BigDecimal）

### リクエスト属性

- **fy** (Integer): 会計年度（4月開始）
- **months** (List<String>): 12ヶ月のリスト（yyyy-MM形式）
- **rows** (List<PivotRowDTO>): ピボット行（顧客別）
- **colTotals** (Map<String, BigDecimal>): 列合計（月別）
- **grandTotal** (BigDecimal): 総合計

### データベーステーブル

- **customer_monthly_invoices**: 顧客月次請求テーブル
  - `customer_id`: 顧客ID
  - `target_year_month`: 対象年月（yyyy-MM）
  - `total_amount`: 合計金額
  - `deleted_at`: 論理削除フラグ

- **customers**: 顧客テーブル
  - `id`: 顧客ID
  - `company_name`: 会社名
  - `deleted_at`: 論理削除フラグ

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空のピボットテーブル）
- 存在しない月のセルは0で表示

## 備考

### 会計年度の定義

- **4月開始**: 会計年度は4月1日～翌3月31日
- **年度の表記**: FY=2025 は 2025-04 ～ 2026-03 を意味する

### 売上の集計元

- **customer_monthly_invoices テーブル**: 顧客月次請求テーブル
- 承認済みタスクを集計したデータ（他の機能で自動生成）
- ステータス: DRAFT / FINALIZED など

### ピボット形式の利点

- 12ヶ月のトレンドを一目で確認
- 顧客別の年間売上を把握
- 月別の売上合計を比較

### 画面の特徴

- **横スクロール対応**: 12ヶ月+行合計の13列を表示
- **フォーマット**: 金額は3桁カンマ区切り（`#,##0`）
- **色分け**: Bootstrap の primary カラーでヘッダー・フッターを強調

### 対象データの範囲

- 論理削除されていない顧客・請求データのみ表示
- 期間内に請求データがない顧客は表示されない

### 使用場面

- 年間売上の確認
- 顧客別売上の比較
- 月別売上トレンドの確認
- 経営判断のためのKPI確認

### 関連機能

- **支出サマリー表示** (42_支出サマリー表示.md): 秘書×月の支出をピボット表示
- **請求サマリー表示** (39_請求サマリー表示.md): 請求ダッシュボード表示
- **顧客月次請求管理**: customer_monthly_invoices テーブルの自動生成（他の機能で実装）
