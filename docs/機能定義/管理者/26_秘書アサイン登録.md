# 26_秘書アサイン登録(A05_03)

## 機能概要

通常秘書を特定の顧客にアサインする機能です。3画面構成(入力→確認→完了)で、顧客・秘書・タスクランク・対象月・各種単価を設定してアサインを登録します。秘書候補リスト表示機能により、プロフィール登録済みで対応可能な時間帯の秘書のみをフィルタして表示します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/assignment/register?id={顧客ID}&companyName={顧客名}&targetYM={年月}&wdAm=1&...` | 秘書アサイン登録フォーム | 秘書アサイン登録の入力画面（秘書候補リスト表示） |
| POST | `/admin/assignment/register_check` | 秘書アサイン登録確認 | 入力内容の検証と確認画面表示 |
| POST | `/admin/assignment/register_done` | 秘書アサイン登録完了 | アサインのDB登録と完了画面表示 |

## 画面フロー

```
[アサイン一覧画面]
    ↓ 秘書アサイン登録ボタンクリック
    ↓ GET /admin/assignment/register?id={顧客ID}&companyName={顧客名}&targetYM={年月}
    ↓ (オプション) 時間帯フィルタ: wdAm, wdDay, wdNight, saAm, saDay, saNight, suAm, suDay, suNight
    ↓ (オプション) ソート: sortKey, sortDir
    ↓
[秘書アサイン登録画面] (register.jsp)
    - 顧客名: 固定表示（変更不可）
    - 秘書候補リスト: プロフィール登録済み、対応可能時間帯でフィルタ
      - 時間帯フィルタ: 平日朝・昼・夜、土曜朝・昼・夜、日曜朝・昼・夜
      - ソート: 稼働時間、継続月数、稼働率など
    - 秘書: セレクトボックス（全秘書）
    - タスクランク: セレクトボックス（A/B/C/D/E）
    - 対象月: yyyy-MM形式（デフォルトは当月）
    - 単価（顧客）: 金額入力
    - 単価（秘書）: 金額入力
    - 増額（顧客）: 金額入力
    - 増額（秘書）: 金額入力
    - 継続単価（顧客）: 金額入力（省略可）
    - 継続単価（秘書）: 金額入力（省略可）
    - ステータス: テキスト入力（省略可）
    ↓ 次へボタン
    ↓ POST /admin/assignment/register_check
    ↓
[秘書アサイン登録確認画面] (register_check.jsp)
    - 入力内容の確認表示
    - hidden フィールドで値を保持（form_*属性）
    ↓ 登録ボタン
    ↓ POST /admin/assignment/register_done
    ↓ 重複チェック実施
    ↓
[秘書アサイン登録完了画面] (register_done.jsp)
    - 登録完了メッセージ表示
    ↓ アサイン一覧へ戻るボタン
    ↓ GET /admin/assignment?targetYM={年月}
    ↓
[アサイン一覧画面]
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**:
  - `assignmentRegister()` (257行目): 秘書アサイン登録フォーム表示
  - `assignmentRegisterCheck()` (388行目): 入力内容検証と確認画面表示
  - `assignmentRegisterDone()` (520行目): アサイン登録実行

### 処理フロー

#### 1. 秘書アサイン登録フォーム表示（GET `/admin/assignment/register`）

1. **パラメータ取得・検証**
   - `id`: 顧客ID（必須）
   - `companyName`: 顧客名（必須）
   - `targetYM`: 対象月（yyyy-MM形式、省略時は当月）
   - 時間帯フィルタ（チェックボックス）:
     - `wdAm`, `wdDay`, `wdNight`: 平日（朝・昼・夜）
     - `saAm`, `saDay`, `saNight`: 土曜（朝・昼・夜）
     - `suAm`, `suDay`, `suNight`: 日曜（朝・昼・夜）
   - ソート:
     - `sortKey`: wdHours / saHours / suHours / totalHours / lastMonth / capacity
     - `sortDir`: asc / desc
   - バリデーション: `isNull()` で必須チェック、エラー時はアサイン一覧へリダイレクト

2. **時間帯フィルタのパース**
   - 各チェックボックスの値（"1", "on", "true", "yes"）をbooleanに変換
   - チェックされていない場合はfalse

3. **顧客情報設定**
   - 顧客IDと顧客名をCustomerオブジェクトに設定
   - リクエスト属性 `customer` にセット

4. **プルダウン用データ取得**
   - 秘書一覧: `loadSecretariesToRequest(tm, false)` で全秘書を取得
   - タスクランク一覧: `loadTaskRanksToRequest(tm)` で全ランクを取得

5. **既存アサイン取得**
   - `AssignmentDAO.selectThisMonthByCustomerWithContRank(customerId, ym)` で対象月の既存アサインを取得
   - リクエスト属性 `futureAssignments` にセット

6. **秘書候補リスト取得**
   - `ProfileDAO.selectSecretaryCandidatesForRegister()` でフィルタリングとソート実施
   - 条件:
     - プロフィール登録済み（profiles テーブルに存在）
     - 対応可能時間帯が「〇」または「△」
     - pref_score で優先順位付け（〇=2、△=1）
   - リクエスト属性 `secretaryCandidates` にセット

7. **画面状態の保持**
   - 時間帯フィルタの状態をリクエスト属性にセット
   - ソート状態をリクエスト属性にセット

8. **ビューへフォワード**
   - 秘書登録フォーム（`assignment/admin/register`）へフォワード

#### 2. 秘書アサイン登録確認（POST `/admin/assignment/register_check`）

1. **パラメータ取得**
   - `id`: 顧客ID（画面のname=id）
   - `secretaryId`: 秘書ID（UUID）
   - `taskRankId`: タスクランクID（UUID）
   - `targetYM`: 対象月（yyyy-MM）
   - 単価・増額・インセンティブ（各顧客・秘書向け）
   - `status`: ステータス（省略可）

2. **form_* 属性の設定**
   - `pushFormBackToRequestForCheck(false)` で入力値をリクエスト属性にセット
   - エラー時の画面復元用

3. **バリデーション**
   - UUID形式チェック: `isUuid()` で検証（顧客ID、秘書ID、タスクランクID）
   - エラー時: 秘書一覧・タスクランク一覧を再取得し、入力フォームへ戻す

4. **表示名称取得**
   - 顧客情報: `CustomerDAO.selectByUUId()`
   - 秘書情報: `SecretaryDAO.selectByUUId()`
   - タスクランク情報: `TaskRankDAO.selectAll()` からマッチングして取得

5. **ビューへフォワード**
   - 確認ビュー（`assignment/admin/register_check`）へフォワード

#### 3. 秘書アサイン登録完了（POST `/admin/assignment/register_done`）

1. **パラメータ取得・再検証**
   - 全パラメータを取得
   - 必須チェック: 顧客、秘書、業務ランク、対象月
   - UUID形式チェック
   - 年月形式チェック: `isYearMonth()` で検証（yyyy-MM形式）
   - 金額チェック: `mustBeMoneyOrZero()` で検証（カンマ除去対応）
   - インセンティブは省略可（blank許容）

2. **バリデーションエラー時**
   - `populateFormBackForRegister()` で入力値を復元
   - 秘書一覧・タスクランク一覧を再取得
   - 入力フォーム（`register`）へ戻す

3. **AssignmentDTO組み立て**
   - `buildAssignmentDto()` ヘルパーメソッドで組み立て
   - 全ての単価・増額・インセンティブを設定

4. **重複チェック**
   - `AssignmentDAO.existsDuplicate(dto)` で重複確認
   - 重複条件: 同月・同顧客・同秘書・同ランク
   - 重複時: エラーメッセージを設定し、入力フォーム（`register`）へ戻す

5. **DB登録**
   - `AssignmentDAO.insert(dto)` でINSERT実行
   - トランザクションコミット（`tm.commit()`）

6. **完了処理**
   - 完了ビュー（`assignment/admin/register_done`）へフォワード

### トランザクション管理

#### 登録フォーム表示

```java
try (TransactionManager tm = new TransactionManager()) {
    /** 顧客（固定表示） */
    Customer customer = new Customer();
    customer.setId(UUID.fromString(idStr));
    customer.setCompanyName(companyName);
    req.setAttribute(A_CUSTOMER, customer);

    /** プルダウン */
    loadSecretariesToRequest(tm, false);
    loadTaskRanksToRequest(tm);

    AssignmentDAO adao = new AssignmentDAO(tm.getConnection());
    List<AssignmentDTO> adtos = adao.selectThisMonthByCustomerWithContRank(customer.getId(), ym);
    List<Assignment> futureAssignments = new ArrayList<>();
    for(AssignmentDTO adto : adtos) {
        futureAssignments.add(conv.toDomain(adto));
    }

    req.setAttribute("futureAssignments", futureAssignments);

    /** 候補（サーバー側：SQLでフィルタ/ソート） */
    ProfileDAO pdao = new ProfileDAO(tm.getConnection());
    List<Map<String, Object>> candidates =
            pdao.selectSecretaryCandidatesForRegister(
                    ym,
                    wdAm, wdDay, wdNight,
                    saAm, saDay, saNight,
                    suAm, suDay, suNight,
                    sortKey, desc
            );

    req.setAttribute("secretaryCandidates", candidates);
    return VIEW_REGISTER;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

#### 登録実行

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());

    if (dao.existsDuplicate(dto)) {
        validation.addErrorMsg("同月・同顧客・同秘書・同ランクのアサインは既に登録済みです。");
        populateFormBackForRegister(customerIdStr, secretaryIdStr, taskRankIdStr, ym,
                baseCustStr, baseSecStr, incCustStr, incSecStr, incentCustStr, incentSecStr, status);
        loadSecretariesToRequest(tm, false);
        loadTaskRanksToRequest(tm);
        return VIEW_REGISTER;
    }

    dao.insert(dto);
    tm.commit();  // 明示的コミット
    return VIEW_REGISTER_DONE;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック

### DAO呼び出し

- **AssignmentDAO**
  - `existsDuplicate(AssignmentDTO dto)`: 重複チェック（同月・同顧客・同秘書・同ランク）
    - SQL: `SQL_EXISTS_DUPLICATE`（417行目）
  - `insert(AssignmentDTO dto)`: アサイン新規登録
    - SQL: `SQL_INSERT`（406行目）
    - RETURNING句でIDを取得
  - `selectThisMonthByCustomerWithContRank(UUID customerId, String yearMonth)`: 対象月の既存アサイン取得
    - SQL: `SQL_SELECT_THIS_MONTH_BY_CUSTOMER_WITH_CONT_RANK`（688行目）

- **CustomerDAO**
  - `selectByUUId(UUID id)`: 顧客情報取得（確認画面用）

- **SecretaryDAO**
  - `selectAll()`: 全秘書一覧取得（プルダウン用）
  - `selectByUUId(UUID id)`: 秘書情報取得（確認画面用）

- **TaskRankDAO**
  - `selectAll()`: 全タスクランク取得（プルダウン用）

- **ProfileDAO**
  - `selectSecretaryCandidatesForRegister()`: 秘書候補リスト取得
    - フィルタ: 時間帯対応可能（〇/△）
    - ソート: 稼働時間、継続月数、稼働率など

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **必須パラメータ検証**: 顧客ID、秘書ID、対象月、単価の必須チェック
- **UUID形式検証**: 不正なUUID形式を拒否
- **重複防止**: ユニーク制約（月×顧客×秘書×ランク）で二重登録を防止
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **入力画面**: [/WEB-INF/jsp/assignment/admin/register.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/register.jsp)
- **確認画面**: [/WEB-INF/jsp/assignment/admin/register_check.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/register_check.jsp)
- **完了画面**: [/WEB-INF/jsp/assignment/admin/register_done.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/register_done.jsp)

### 入力画面 (register.jsp)

| 項目 | 種別 | 説明 |
|-----|------|------|
| **顧客名** | 固定表示 | パラメータから受け取った顧客名を表示（変更不可） |
| **時間帯フィルタ** | チェックボックス | 平日・土曜・日曜の朝・昼・夜（9つのチェックボックス） |
| **ソート** | セレクトボックス | 稼働時間、継続月数、稼働率など |
| **秘書候補リスト** | テーブル表示 | プロフィール登録済み、対応可能時間帯の秘書のみ表示 |
| **秘書** | セレクトボックス | 全秘書（プルダウン） |
| **タスクランク** | セレクトボックス | A/B/C/D/E（プルダウン） |
| **対象月** | テキスト入力 | yyyy-MM形式（デフォルトは当月） |
| **単価（顧客）** | テキスト入力 | 金額（カンマ区切り可） |
| **単価（秘書）** | テキスト入力 | 金額（カンマ区切り可） |
| **増額（顧客）** | テキスト入力 | 金額（カンマ区切り可） |
| **増額（秘書）** | テキスト入力 | 金額（カンマ区切り可） |
| **継続単価（顧客）** | テキスト入力 | 金額（カンマ区切り可、省略可） |
| **継続単価（秘書）** | テキスト入力 | 金額（カンマ区切り可、省略可） |
| **ステータス** | テキスト入力 | 任意入力 |

#### 秘書候補リスト表示項目

- 秘書名
- 平日・土曜・日曜の対応可能時間（〇/△/×）
- 稼働時間（平日・土曜・日曜・合計）
- 継続月数（過去のアサイン実績）
- 稼働率

### 確認画面 (register_check.jsp)

| 項目 | 説明 |
|-----|------|
| **顧客名** | 入力内容の確認表示 |
| **秘書名** | 入力内容の確認表示 |
| **タスクランク** | 入力内容の確認表示 |
| **対象月** | 入力内容の確認表示 |
| **単価（顧客）** | 入力内容の確認表示 |
| **単価（秘書）** | 入力内容の確認表示 |
| **増額（顧客）** | 入力内容の確認表示 |
| **増額（秘書）** | 入力内容の確認表示 |
| **継続単価（顧客）** | 入力内容の確認表示 |
| **継続単価（秘書）** | 入力内容の確認表示 |
| **ステータス** | 入力内容の確認表示 |
| **hidden値** | 顧客ID、秘書ID、タスクランクID、各種単価等をPOST用に保持（form_*属性） |

### 完了画面 (register_done.jsp)

- 登録完了メッセージ表示
- アサイン一覧へ戻るボタン

## データモデル

### 使用するDTO

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報（全フィールド使用）

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - 顧客情報

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - 秘書情報

- **TaskRankDTO** ([dto/TaskRankDTO.java](../../../src/main/java/dto/TaskRankDTO.java))
  - タスクランク情報

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報（JSP表示用）

- **Secretary** ([domain/Secretary.java](../../../src/main/java/domain/Secretary.java))
  - 秘書情報（JSP表示用）

- **TaskRank** ([domain/TaskRank.java](../../../src/main/java/domain/TaskRank.java))
  - タスクランク情報（JSP表示用）

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（既存アサイン表示用）

### リクエスト属性

#### 入力画面

- **customer** (Customer): 顧客情報
- **secretaries** (List<Secretary>): 全秘書一覧（プルダウン用）
- **taskRanks** (List<TaskRank>): 全タスクランク一覧（プルダウン用）
- **secretaryCandidates** (List<Map<String, Object>>): 秘書候補リスト
- **futureAssignments** (List<Assignment>): 対象月の既存アサイン
- **targetYM** (String): 対象月（yyyy-MM）
- **wdAm, wdDay, wdNight** (Boolean): 平日の時間帯フィルタ
- **saAm, saDay, saNight** (Boolean): 土曜の時間帯フィルタ
- **suAm, suDay, suNight** (Boolean): 日曜の時間帯フィルタ
- **sortKey** (String): ソートキー
- **sortDir** (String): ソート方向（asc / desc）
- **errorMsg** (List<String>): エラーメッセージ（バリデーションエラー時）

#### 確認画面

- **customer** (Customer): 顧客情報
- **secretary** (Secretary): 選択された秘書
- **taskRank** (TaskRank): 選択されたタスクランク
- **form_customerId** (String): 顧客ID（hidden用）
- **form_secretaryId** (String): 秘書ID（hidden用）
- **form_taskRankId** (String): タスクランクID（hidden用）
- **form_targetYM** (String): 対象月（hidden用）
- **form_basePayCustomer** (String): 単価（顧客）（hidden用）
- **form_basePaySecretary** (String): 単価（秘書）（hidden用）
- **form_increaseBasePayCustomer** (String): 増額（顧客）（hidden用）
- **form_increaseBasePaySecretary** (String): 増額（秘書）（hidden用）
- **form_customerBasedIncentiveForCustomer** (String): 継続単価（顧客）（hidden用）
- **form_customerBasedIncentiveForSecretary** (String): 継続単価（秘書）（hidden用）
- **form_status** (String): ステータス（hidden用）

#### 完了画面

- なし（完了メッセージのみ）

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: 顧客、秘書、タスクランク、対象月、単価の未入力
- **形式エラー**: UUID形式不正、年月形式不正（yyyy-MM以外）
- **金額エラー**: 数値以外の入力

**処理**:
- エラーメッセージをリクエスト属性にセット
- 入力フォーム（`register`）へ戻す
- 入力値を保持して再表示（form_*属性）

### 重複エラー

- **条件**: 同月・同顧客・同秘書・同ランクのアサインが既に存在
- **処理**: エラーメッセージを表示し、入力フォームへ戻す

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

### 秘書候補リスト機能

- **プロフィール登録済み秘書のみ表示**: profiles テーブルに登録されている秘書のみ
- **対応可能時間帯でフィルタ**: 「〇」または「△」の時間帯でフィルタ
- **優先順位**: pref_score で優先順位付け（〇=2、△=1）
- **サーバー側フィルタ/ソート**: ProfileDAO.selectSecretaryCandidatesForRegister() でSQL実行

### 時間帯フィルタ

- 平日・土曜・日曜の朝・昼・夜（9つの時間帯）
- チェックボックスで選択
- 複数選択可能（OR条件）

### ソート機能

- **稼働時間**: 平日・土曜・日曜・合計
- **継続月数**: 過去のアサイン実績
- **稼働率**: 月間稼働時間 / 月間最大稼働時間

### ユニーク制約

- 月（target_year_month）× 顧客（customer_id）× 秘書（secretary_id）× ランク（task_rank_id）の組み合わせで一意
- 同じ組み合わせは重複登録不可

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): 登録後の一覧表示
- **PM秘書アサイン登録** (25_PM秘書アサイン登録.md): PM秘書のアサイン登録
