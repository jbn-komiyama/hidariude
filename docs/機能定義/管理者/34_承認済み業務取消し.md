# 34_承認済み業務取消し（A05_23）

## 機能概要

承認済みタスクの承認を取り消す機能です。一括取消が可能です。承認を取り消すと、タスクは未承認状態に戻り、`approved_at` と `approved_by` が NULL になります。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| POST | `/admin/task/unapprove_bulk?taskIds[]={タスクID}&yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 承認一括取消 | 選択されたタスクの承認を一括取消 |

## 画面フロー

```
[業務一覧画面（承認済みタブ）]
    ↓ チェックボックスで取消対象を選択
    ↓ 承認取消ボタンクリック
    ↓ POST /admin/task/unapprove_bulk
    |   - taskIds[]: 選択されたタスクIDの配列
    |   - yearMonth: 対象月
    |   - sec: 秘書名検索値（絞込維持用）
    |   - cust: 顧客名検索値（絞込維持用）
    ↓
[承認取消処理実行]
    - 選択されたタスクに対して承認取消処理を実行
    - approved_at を NULL に設定
    - approved_by を NULL に設定
    ↓
    ├─ 選択なし
    |   ↓ 承認済み一覧へリダイレクト
    |   └─ エラーメッセージ表示
    |
    └─ 選択あり
        ↓ 各タスクに対して承認取消処理
        ↓ トランザクションコミット
        ↓ GET /admin/task/list_approved?yearMonth={年月}&sec={秘書名}&cust={顧客名}
        ↓
        [業務一覧画面（承認済みタブ）]（取消後、対象タスクは非表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**: `adminTaskUnapproveBulk()` (730行目): 承認一括取消

### 処理フロー

#### 1. 承認一括取消（POST `/admin/task/unapprove_bulk`）

1. **パラメータ取得**
   - `taskIds[]`: 選択されたタスクIDの配列（必須）
   - `yearMonth`: 対象月（yyyy-MM形式、任意、デフォルト: 当月）
   - `sec`: 秘書名検索値（任意、絞込維持用）
   - `cust`: 顧客名検索値（任意、絞込維持用）

2. **選択チェック**
   - `taskIds[]` が空または未指定の場合
   - エラーメッセージ "対象が選択されていません。" を設定
   - 承認済み一覧（`adminTaskListApproved()`）へ遷移

3. **UUID変換**
   - 配列の各要素をUUIDに変換
   - 変換エラー時はスキップ（無視）

4. **承認取消処理**
   - 各タスクIDに対して:
     - `TaskDAO.unapprove(taskId)` で承認取消処理
     - SQL: `UPDATE tasks SET approved_at = NULL, approved_by = NULL, updated_at = NOW() WHERE id = ? AND deleted_at IS NULL`
     - 処理内容:
       - `approved_at`: NULL に設定
       - `approved_by`: NULL に設定
       - `updated_at`: 現在時刻を設定

5. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

6. **リダイレクト**
   - 承認済み一覧へリダイレクト（絞込条件を維持）
   - リダイレクト先: `/admin/task/list_approved?yearMonth={年月}&sec={秘書名}&cust={顧客名}`

### トランザクション管理

```java
public String adminTaskUnapproveBulk() {
    final String[] idParams = req.getParameterValues("taskIds");
    final String ym   = Optional.ofNullable(req.getParameter(P_YEAR_MONTH))
            .filter(s -> !s.isBlank())
            .orElse(LocalDate.now(Z_TOKYO).format(YM_FMT));
    final String sec  = Optional.ofNullable(req.getParameter(P_SEC_NAME)).orElse("");
    final String cust = Optional.ofNullable(req.getParameter(P_CUST_NAME)).orElse("");

    if (idParams == null || idParams.length == 0) {
        validation.addErrorMsg("対象が選択されていません。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return adminTaskListApproved();
    }

    final List<UUID> ids = new ArrayList<>();
    for (String s : idParams) { try { ids.add(UUID.fromString(s)); } catch (Exception ignore) {} }

    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        for (UUID id : ids) dao.unapprove(id);
        tm.commit();  // 明示的コミット
    } catch (RuntimeException e) {
        validation.addErrorMsg("承認取消に失敗しました。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return req.getContextPath() + req.getServletPath() + "/error";
    }
    return req.getContextPath() + "/admin/task/list_approved?yearMonth=" + ym
            + "&sec=" + urlEnc(sec) + "&cust=" + urlEnc(cust);
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- URLエンコードでクエリパラメータを安全に処理

### DAO呼び出し

- **TaskDAO**
  - `unapprove(UUID taskId)`: 承認取消
    - SQL: 動的SQL（1121行目）
    - 処理:
      - `approved_at = NULL`: 承認日時をクリア
      - `approved_by = NULL`: 承認者IDをクリア
      - `updated_at = NOW()`: 更新日時を設定
    - 条件: `id = ? AND deleted_at IS NULL`
    - 影響行数を返す

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なIDは自動的にスキップ
- **論理削除フィルタ**: 削除済みタスクは承認取消できない
- **URLエンコーディング**: クエリパラメータの安全な処理
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **承認済み一覧画面**: [/WEB-INF/jsp/task/admin/list_approved.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_approved.jsp)

### 画面表示項目

#### 取消対象選択

| 項目 | 説明 |
|-----|------|
| **全選択チェックボックス** | 全タスクを一括選択 |
| **個別チェックボックス** | 各タスクを個別選択 |
| **承認取消ボタン** | 選択されたタスクの承認を一括取消 |

#### タスク一覧

承認済みタスクの一覧表示（詳細は 30_業務一覧表示.md を参照）

### 画面アクション

- **承認取消ボタン**: 選択されたタスクの承認を一括取消（`/admin/task/unapprove_bulk`）
  - POST メソッドでリクエスト
  - フォームで選択されたタスクIDを配列で送信
  - 実行後は承認済み一覧へリダイレクト（絞込条件を維持）

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `approved_at`: 承認日時（取消時に NULL）
  - `approved_by`: 承認者ID（取消時に NULL）

### URLパラメータ

- **taskIds[]** (String[]): 選択されたタスクIDの配列
- **yearMonth** (String): 対象月（yyyy-MM形式、絞込維持用）
- **sec** (String): 秘書名検索値（絞込維持用）
- **cust** (String): 顧客名検索値（絞込維持用）

## エラーハンドリング

### バリデーションエラー

- **選択なし**: `taskIds[]` が空または未指定
  - 承認済み一覧へ遷移
  - エラーメッセージ: "対象が選択されていません。"

- **UUID形式エラー**: UUID形式に変換できないIDが含まれる
  - 該当IDはスキップ
  - エラーにならない

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- **承認取消失敗**: エラーメッセージ "承認取消に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- 選択されたタスクが0件の場合でもエラー表示
- 未承認タスクに対して承認取消を実行してもエラーにならない（影響なし）

## 備考

### 承認取消の仕様

- **承認日時のクリア**: `approved_at` を NULL に設定
- **承認者IDのクリア**: `approved_by` を NULL に設定
- **更新日時**: `updated_at` に現在時刻を設定
- **未承認状態に戻る**: 承認取消後は未承認タブに表示される

### 請求への影響

- 承認取消により、タスクは請求対象から外れる
- 月次請求の集計には含まれなくなる

### 未承認タスクへの適用

- 未承認タスクに対して承認取消を実行してもエラーにならない
- WHERE句の条件により影響行数=0となるが、正常処理として扱われる

### 差戻し情報の保持

- 承認取消処理では、差戻し情報（`remanded_at`, `remanded_by`, `remand_comment`）は変更されない
- 差戻し状態のタスクを承認後に承認取消しても、差戻し情報は保持される

### 絞込条件の維持

- 承認取消後のリダイレクト時、元の絞込条件（yearMonth, sec, cust）を維持
- URLエンコードで安全に処理

### リダイレクト先

- 承認取消後は承認済み一覧へリダイレクト
- 取消されたタスクは承認済み一覧から消える（`approved_at IS NULL` の条件）

### 使用場面

- 承認の誤操作の修正
- 請求対象からの除外
- 業務内容の再確認が必要な場合
- 月次締め前の承認取消

### 再承認

- 承認取消後、未承認タブから再度承認可能
- 承認履歴は残らない（最新の承認情報のみ保持）

### 関連機能

- **業務一覧表示** (30_業務一覧表示.md): 承認済みタスクの一覧表示
- **業務承認** (32_業務承認.md): 承認取消後の再承認
- **業務差戻し** (33_業務差戻し.md): 承認取消の代わりに差戻し
- **請求サマリー表示** (39_請求サマリー表示.md): 承認済みタスクの集計（承認取消により集計から除外）
