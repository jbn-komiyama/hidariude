# 10_秘書一覧表示（A04_05）

## 機能概要

登録されている全ての秘書の一覧を表示する機能です。各秘書の基本情報（氏名、メールアドレス、秘書コード、PM対応可否、秘書ランクなど）を確認できます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/secretary` | 秘書一覧表示 | 全秘書の一覧を表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 秘書一覧リンククリック
    ↓ GET /admin/secretary
    ↓
[秘書一覧画面]
    ↓
    ├─ 新規登録ボタン → [秘書新規登録画面] へ遷移
    ├─ 詳細ボタン → [秘書詳細表示画面] へ遷移
    ├─ 編集ボタン → [秘書編集画面] へ遷移
    └─ 削除ボタン → 削除処理実行
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SecretaryService.java](../../../src/main/java/service/SecretaryService.java:124)
- **メソッド**: `secretaryList()`

### 処理フロー

1. **データベース接続**
   - `TransactionManager` で接続取得
   - トランザクション開始（読み取り専用）

2. **全秘書取得**
   - `SecretaryDAO.selectAll()` で全秘書を取得
   - 論理削除されていない秘書のみ取得（`deleted_at IS NULL`）
   - 取得順は作成日時順（デフォルト）

3. **DTO → Domain変換**
   - `ConvertUtil.toDomain(dto)` でDTOをDomainオブジェクトに変換
   - 秘書ランク情報も含めて変換

4. **画面表示用データ設定**
   - `secretaries` 属性にリストを設定
   - リクエストスコープに格納

5. **ビューへフォワード**
   - 一覧ビュー（`secretary/admin/home`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    SecretaryDAO dao = new SecretaryDAO(tm.getConnection());
    List<SecretaryDTO> dtos = dao.selectAll();

    List<Secretary> secretaries = new ArrayList<>(dtos.size());
    for (SecretaryDTO dto : dtos) {
        secretaries.add(conv.toDomain(dto));
    }
    req.setAttribute("secretaries", secretaries);
    return "secretary/admin/home";
} catch (RuntimeException e) {
    req.setAttribute("errorMsg", "データベースに不正な操作が行われました");
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resources で自動クローズ

### DAO呼び出し

- **SecretaryDAO**
  - `selectAll()`: 全秘書を取得
    - SQL:
      ```sql
      SELECT s.id, s.secretary_code, s.name, s.name_ruby, s.mail, s.password,
             s.phone, s.postal_code, s.address1, s.address2, s.building,
             s.pm_secretary, s.secretary_rank_id,
             s.created_at, s.updated_at, s.deleted_at, s.last_login_at,
             sr.rank_name, sr.description,
             sr.increase_base_pay_customer, sr.increase_base_pay_secretary
      FROM secretaries s
      LEFT JOIN secretary_ranks sr ON s.secretary_rank_id = sr.id
      WHERE s.deleted_at IS NULL
      ORDER BY s.created_at DESC
      ```

### セキュリティ

- **論理削除フィルタ**: 削除済み秘書は表示されない
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **一覧画面**: [/WEB-INF/jsp/secretary/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/home.jsp)

### 画面表示項目

リクエスト属性 `secretaries` (List<Secretary>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **氏名** | 秘書の氏名 |
| **ふりがな** | 氏名のふりがな |
| **秘書コード** | 秘書を識別するコード |
| **メールアドレス** | ログインIDとして使用 |
| **電話番号** | 連絡先電話番号 |
| **PM対応** | PM秘書かどうか（可・不可） |
| **秘書ランク** | 秘書ランク名（A/B/C/D/E） |
| **作成日時** | アカウント作成日時 |
| **最終ログイン日時** | 最後にログインした日時 |
| **アクション** | 詳細・編集・削除ボタン |

### 画面アクション

- **新規登録ボタン**: 秘書新規登録画面（`/admin/secretary/register`）へ遷移
- **詳細ボタン**: 秘書詳細表示画面（`/admin/secretary/detail?id={秘書ID}`）へ遷移
- **編集ボタン**: 秘書編集画面（`/admin/secretary/edit?id={秘書ID}`）へ遷移
- **削除ボタン**: 削除確認後、削除処理実行（`/admin/secretary/delete`）

## データモデル

### 使用するDTO

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - `id` (UUID): 秘書ID
  - `secretaryCode` (String): 秘書コード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `mail` (String): メールアドレス
  - `password` (String): パスワード（ハッシュ化済み、画面には非表示）
  - `phone` (String): 電話番号
  - `postalCode` (String): 郵便番号
  - `address1` (String): 住所1（都道府県・市区町村）
  - `address2` (String): 住所2（番地）
  - `building` (String): 建物名・部屋番号
  - `pmSecretary` (Boolean): PM秘書フラグ
  - `secretaryRankId` (UUID): 秘書ランクID
  - `createdAt` (Timestamp): 作成日時
  - `updatedAt` (Timestamp): 更新日時
  - `deletedAt` (Timestamp): 削除日時（NULL = 有効）
  - `lastLoginAt` (Timestamp): 最終ログイン日時

### 使用するDomainオブジェクト

- **Secretary** ([domain/Secretary.java](../../../src/main/java/domain/Secretary.java))
  - DTOと同等のフィールド構成
  - 秘書ランク情報を含む

### リクエスト属性

- **secretaries** (List<Secretary>): 秘書リスト

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）
- 初期データとして10件の秘書が存在（`DatabaseInitListener`）

## 備考

### 機能一覧の備考欄より

- **ソート機能**: 未実装（将来的に氏名順、作成日時順などの追加を検討）
- **フィルタリング機能**: 未実装（将来的にPM対応、秘書ランクでのフィルタを検討）
- **PM対応項目**: 一覧画面で表示済み（○/× または 可/不可で表示）

### その他

- ページネーション機能は未実装（秘書数が少ないため）
- 論理削除された秘書は表示されないが、データベースには残る
- パスワードはハッシュ化されており、一覧画面には表示されない
- 秘書コードは登録時に自動生成される
- 秘書ランク情報はLEFT JOINで取得（ランク未設定でもエラーにならない）
