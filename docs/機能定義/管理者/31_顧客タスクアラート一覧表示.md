# 31_顧客タスクアラート一覧表示（A05_10）

## 機能概要

顧客からの確認申請（アラート）を一覧表示する機能です。顧客が「確認してほしい」とマークしたタスクを管理者が確認し、アラートを取り消すことができます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/task/alert` | アラート一覧表示 | 顧客からの確認申請一覧を表示 |
| POST | `/admin/task/alert_delete?id={タスクID}` | アラート取消 | アラートを取り消す |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ アラート一覧リンククリック
    ↓ GET /admin/task/alert
    ↓
[アラート一覧画面] (alert.jsp)
    - 顧客からの確認申請一覧を表示
    - アラート日時、顧客名、秘書名、業務内容、コメントを表示
    ↓
    ├─ 取消ボタンクリック
    |   ↓ POST /admin/task/alert_delete?id={タスクID}
    |   ↓ アラート取消処理実行（alerted_at を NULL に）
    |   ↓ GET /admin/task/alert（一覧へリダイレクト）
    |   ↓
    |   [アラート一覧画面]（更新後）
    |
    └─ ナビゲーション
        └─ 業務一覧へ遷移可能
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**:
  - `adminTaskAlertList()` (814行目): アラート一覧表示
  - `adminAlertDelete()` (847行目): アラート取消

### 処理フロー

#### 1. アラート一覧表示（GET `/admin/task/alert`）

1. **データ取得**
   - `TaskDAO.showAlert(false)` でアラート一覧を取得
   - 引数 `false`: 件数制限なし（全件取得）
   - 条件: `alerted_at IS NOT NULL AND deleted_at IS NULL`
   - ソート: `alerted_at` 昇順（古いアラートから表示）

2. **DTO→Domain変換**
   - `ConvertUtil.toDomain()` でTaskDTOをTaskオブジェクトに変換
   - ネストした構造（Task → Assignment）を保持

3. **画面用属性設定**
   - `tasks`: アラート一覧（List<Task>）

4. **ビューへフォワード**
   - アラート一覧ビュー（`task/admin/alert`）へフォワード

#### 2. アラート取消（POST `/admin/task/alert_delete`）

1. **パラメータ取得・検証**
   - `id`: タスクID（UUID形式、必須）
   - バリデーション: `isUuid()` で形式チェック
   - エラー時: エラーページへリダイレクト

2. **アラート取消処理**
   - `TaskDAO.alertDelete(taskId)` でアラートを取り消す
   - SQL: `UPDATE tasks SET alerted_at = NULL, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
   - 影響行数が0の場合: エラーページへリダイレクト

3. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

4. **リダイレクト**
   - アラート一覧へリダイレクト
   - リダイレクト先: `/admin/task/alert`

### トランザクション管理

#### アラート一覧表示

```java
public String adminTaskAlertList() {
    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        List<TaskDTO> dtos = dao.showAlert(false);  // false: 件数絞りなし

        List<Task> tasks = new ArrayList<>();
        for(TaskDTO dto : dtos) {
            tasks.add(conv.toDomain(dto));
        }

        req.setAttribute("tasks", tasks);
        return VIEW_ADMIN_ALERT;  // "task/admin/alert"

    } catch (RuntimeException e) {
        e.printStackTrace();
        req.setAttribute("errorMsg", List.of("アラート一覧の取得に失敗しました。"));
        return req.getContextPath() + req.getServletPath() + "/error";
    }
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

#### アラート取消

```java
public String adminAlertDelete() {
    final String idStr = req.getParameter(P_ID);  // "id"
    if (!validation.isUuid(idStr)) {
        req.setAttribute(A_ERROR_MSG, "対象IDが不正です。");
        return req.getContextPath() + req.getServletPath() + "/error";
    }
    final UUID taskId = UUID.fromString(idStr);

    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        int updated = dao.alertDelete(taskId);
        if (updated == 0) {
            req.setAttribute(A_ERROR_MSG, "対象のタスクが見つかりません。");
            return req.getContextPath() + req.getServletPath() + "/error";
        }
        tm.commit();  // 明示的コミット
        return req.getContextPath() + "/admin/task/alert";
    } catch (RuntimeException e) {
        e.printStackTrace();
        req.setAttribute(A_ERROR_MSG, "アラート取消に失敗しました。");
        return req.getContextPath() + req.getServletPath() + "/error";
    }
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック

### DAO呼び出し

- **TaskDAO**
  - `showAlert(boolean flg)`: アラート一覧取得
    - SQL: `SQL_SELECT_ALERT_LIST`（261行目）
    - 条件: `alerted_at IS NOT NULL AND deleted_at IS NULL`
    - ソート: `alerted_at` 昇順
    - 引数 `flg`: `true` の場合は `LIMIT 10`（件数制限）、`false` の場合は全件取得
    - JOIN: `tasks → assignments → customers, secretaries, task_rank`
  - `alertDelete(UUID id)`: アラート取消
    - SQL: `SQL_ALERT_DELETE`（285行目）
    - 処理: `alerted_at` を NULL に更新

### セキュリティ

- **論理削除フィルタ**: 削除済みタスクは表示されない（`deleted_at IS NULL`）
- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なIDを拒否
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **アラート一覧画面**: [/WEB-INF/jsp/task/admin/alert.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/alert.jsp)

### 画面表示項目

#### アラート一覧

リクエスト属性 `tasks` (List<Task>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **アラート日時** | 確認申請日時（alerted_at） |
| **顧客名** | 顧客企業名（company_name） |
| **秘書名** | 秘書氏名（secretary_name） |
| **業務日** | 作業日（work_date） |
| **開始時刻** | 開始時刻（start_time） |
| **終了時刻** | 終了時刻（end_time） |
| **作業時間** | 作業時間（work_minute、分単位） |
| **ランク** | 業務ランク（rank_name） |
| **業務内容** | 作業内容（work_content） |
| **コメント** | 顧客からのコメント（alerted_comment） |
| **差戻状態** | 差戻し日時・コメント（remanded_at, remand_comment）があれば表示 |
| **アクション** | 取消ボタン |

### 画面アクション

- **取消ボタン**: アラートを取り消す（`/admin/task/alert_delete?id={タスクID}`）
  - POST メソッドでリクエスト
  - 確認ダイアログなし（即座に実行）
  - 実行後はアラート一覧へリダイレクト

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `alerted_at`: アラート日時
  - `alerted_comment`: 顧客からのコメント
  - `remanded_at`: 差戻し日時
  - `remand_comment`: 差戻しコメント
  - `assignment` フィールドでアサイン情報を保持

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報
  - 顧客名、秘書名、ランク名を保持

### 使用するDomainオブジェクト

- **Task** ([domain/Task.java](../../../src/main/java/domain/Task.java))
  - タスク情報（ネストした構造）
  - `assignment` フィールドでAssignmentオブジェクトを保持

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（ネストした構造）

### リクエスト属性

- **tasks** (List<Task>): アラート一覧

## エラーハンドリング

### バリデーションエラー

- **UUID形式エラー**: UUID形式以外のIDが指定された場合
  - エラーページへリダイレクト
  - エラーメッセージ: "対象IDが不正です。"

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- **データ取得失敗**: エラーメッセージ "アラート一覧の取得に失敗しました。"
- **アラート取消失敗**: エラーメッセージ "アラート取消に失敗しました。"
- **対象タスク不在**: エラーメッセージ "対象のタスクが見つかりません。"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）
- アラート取消後は一覧から削除される

## 備考

### アラートの仕様

- **アラート発生**: 顧客が業務画面から「確認申請」ボタンをクリック
- **アラート条件**: `alerted_at IS NOT NULL AND deleted_at IS NULL`
- **アラート解除**: 管理者が「取消」ボタンをクリック（`alerted_at` を NULL に）

### 件数制限

- `showAlert(false)` により全件取得（件数制限なし）
- 引数を `true` にすると `LIMIT 10` で上位10件のみ取得
- 現在の実装では全件取得のみ使用

### ソート順

- アラート日時（alerted_at）の昇順（古いアラートから表示）
- DAOレベルで固定（変更不可）

### 差戻し情報の表示

- タスクが差戻し状態（remanded_at が NULL でない）の場合、差戻し日時とコメントも表示
- 顧客がアラートを申請した業務が既に差し戻されている場合を考慮

### ナビゲーションバーのアラート件数

- `AlertCountFilter` により、管理者ログイン時に自動的にアラート件数を取得
- `TaskDAO.showAlert(false)` を実行してアラート件数をカウント
- ナビゲーションバーのバッジに表示

### 使用場面

- 顧客からの確認申請の確認
- アラートの取消
- 月次の業務確認作業

### 関連機能

- **業務一覧表示** (30_業務一覧表示.md): タスク詳細の確認
- **業務承認** (32_業務承認.md): アラート確認後の承認
- **業務差戻し** (33_業務差戻し.md): アラート確認後の差戻し
- **業務確認申請取消し** (35_業務確認申請取消し.md): アラート取消の詳細
