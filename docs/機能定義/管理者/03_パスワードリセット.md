# 03_パスワードリセット（A01_93）

## 機能概要

ログインパスワードを忘れたシステム管理者が、登録済みのメールアドレスを使用してパスワードを再設定する機能です。メールアドレスを入力するとパスワードリセット用のトークン付きURLがメールで送信され、そのURLからパスワードを再設定できます。

## 実装状況

**未実装（今後実装予定）**

以下は想定仕様です。実装時に変更される可能性があります。

## URL一覧（想定）

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/password_reset` | パスワードリセット申請画面 | メールアドレス入力フォームを表示 |
| POST | `/admin/password_reset/request` | リセット申請処理 | トークン生成、メール送信 |
| GET | `/admin/password_reset/form?token={token}` | パスワード再設定画面 | トークン検証後、新パスワード入力フォームを表示 |
| POST | `/admin/password_reset/reset` | パスワード再設定処理 | 新パスワードを設定 |

## 画面フロー（想定）

```
[ログイン画面] (/admin)
    ↓ 「パスワードを忘れた方」リンククリック
    ↓
[パスワードリセット申請画面] (/admin/password_reset)
    ↓ メールアドレス入力
    ↓ POST /admin/password_reset/request
    ↓
[申請完了画面] - メール送信通知
    ↓
（メール受信）
    ↓ メール内のリンクをクリック
    ↓
[パスワード再設定画面] (/admin/password_reset/form?token=xxx)
    ↓ 新パスワード・確認用パスワード入力
    ↓ POST /admin/password_reset/reset
    ↓
[再設定完了画面]
    ↓
[ログイン画面] (/admin) へリダイレクト
```

## バックエンド処理詳細（想定）

### サービスクラス（想定）

- **クラス**: `PasswordResetService.java`（新規作成）
- **メソッド**:
  - `showResetRequestForm()`: リセット申請画面表示
  - `processResetRequest()`: トークン生成・メール送信
  - `showResetForm()`: 再設定画面表示（トークン検証）
  - `processPasswordReset()`: パスワード更新

### 処理フロー（想定）

#### 1. リセット申請処理

1. **入力パラメータ取得**
   - `email`: メールアドレス（必須）

2. **バリデーション**
   - 必須チェック
   - メールアドレス形式チェック

3. **管理者存在確認**
   - `SystemAdminDAO.selectByMail(email)` でメールアドレスの存在確認
   - 存在しない場合でも同じメッセージを返す（セキュリティ対策：アカウントの存在を推測させない）

4. **トークン生成・保存**
   - ランダムなトークン（UUID等）を生成
   - トークンの有効期限を設定（例：1時間）
   - `password_reset_tokens` テーブルに保存（新規テーブル）

5. **メール送信**
   - パスワードリセット用URLを含むメールを送信
   - URL例: `https://example.com/admin/password_reset/form?token=xxx`

6. **完了画面表示**
   - 「メールを送信しました」メッセージを表示

#### 2. パスワード再設定処理

1. **入力パラメータ取得**
   - `token`: リセットトークン（必須）
   - `newPassword`: 新パスワード（必須）
   - `confirmPassword`: 確認用パスワード（必須）

2. **バリデーション**
   - 必須チェック
   - パスワード強度チェック（8文字以上、英大小数字含む）
   - パスワード一致チェック（`newPassword` == `confirmPassword`）

3. **トークン検証**
   - `PasswordResetTokenDAO.selectByToken(token)` でトークン情報取得
   - トークンが存在しない場合はエラー
   - 有効期限切れの場合はエラー
   - 既に使用済みの場合はエラー

4. **パスワード更新**
   - `PasswordUtil.hashPassword(newPassword)` で新パスワードをハッシュ化
   - `SystemAdminDAO.updatePassword(adminId, hashedPassword)` でパスワード更新
   - トークンを使用済みにマーク

5. **完了画面表示**
   - 「パスワードを再設定しました」メッセージを表示
   - ログイン画面へのリンクを表示

### トランザクション管理（想定）

```java
try (TransactionManager tm = new TransactionManager()) {
    // トークン生成・保存またはパスワード更新
    tm.commit();
} catch (RuntimeException e) {
    // エラー時は自動ロールバック
}
```

### DAO呼び出し（想定）

#### 新規DAO: PasswordResetTokenDAO

- `insert(PasswordResetTokenDTO token)`: トークン保存
- `selectByToken(String token)`: トークン取得
- `markAsUsed(String token)`: トークンを使用済みにマーク
- `deleteExpired()`: 期限切れトークンの削除（定期実行）

#### SystemAdminDAO（追加メソッド）

- `updatePassword(UUID id, String hashedPassword)`: パスワード更新のみ実行

### 新規テーブル: password_reset_tokens（想定）

```sql
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_id UUID NOT NULL REFERENCES system_admins(id),
    token VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ビューファイル（想定）

- **リセット申請画面**: `/WEB-INF/jsp/common/admin/password_reset_request.jsp`
- **申請完了画面**: `/WEB-INF/jsp/common/admin/password_reset_sent.jsp`
- **再設定画面**: `/WEB-INF/jsp/common/admin/password_reset_form.jsp`
- **再設定完了画面**: `/WEB-INF/jsp/common/admin/password_reset_done.jsp`

## データモデル（想定）

### 新規DTO: PasswordResetTokenDTO

- `id` (UUID): トークンID
- `adminId` (UUID): 管理者ID
- `token` (String): リセットトークン
- `expiresAt` (Timestamp): 有効期限
- `usedAt` (Timestamp): 使用日時（NULL = 未使用）
- `createdAt` (Timestamp): 作成日時

## エラーハンドリング（想定）

### バリデーションエラー

- メールアドレス未入力・形式エラー
- パスワード未入力・強度不足・不一致エラー

### ビジネスロジックエラー

- トークンが存在しない
- トークンが期限切れ
- トークンが既に使用済み

### セキュリティ考慮事項

- メールアドレスの存在有無を推測させない（存在しない場合も同じメッセージ）
- トークンは推測困難なランダム文字列
- トークンは一度のみ使用可能
- トークンには有効期限を設定（1時間推奨）
- パスワードリセット試行回数の制限（DoS対策）
- メール送信失敗時のリトライ処理

## 備考

- **実装優先度**: 中（セキュリティ機能として重要だが、初期リリースでは管理者が直接パスワード変更可能）
- **メール送信**: JavaMail API または Jakarta Mail を使用
- **トークン有効期限**: 1時間を推奨（要件に応じて調整可能）
- **他ロール対応**: 秘書・顧客向けにも同様の機能を実装予定
- **定期クリーンアップ**: 期限切れトークンを定期的に削除するバッチ処理が必要
