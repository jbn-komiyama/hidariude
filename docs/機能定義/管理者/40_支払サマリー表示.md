# 40_支払サマリー表示（A05_82）

## 機能概要

秘書への支払額をダッシュボード形式で表示する機能です。今月の支払総額、過去3ヶ月の月別支払額、秘書×顧客×ランクごとの支払明細を一覧表示します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/invoice/costs?targetYM={年月}` | 支払サマリー表示 | 支払ダッシュボードを表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 支払サマリーリンククリック
    ↓ GET /admin/invoice/costs?targetYM={yyyy-MM}
    ↓ クエリパラメータで制御：
    |   - targetYM: 対象月（省略時は当月）
    ↓
[支払サマリー画面] (costs.jsp)
    - 月次タイル表示（4ヶ月分）
      - 今月の支払額
      - 先月の支払額
      - 先々月の支払額
      - 3ヶ月前の支払額
    - 秘書別支払明細
      - 秘書×顧客×ランクごとの明細
      - 稼働時間、単価、金額を表示
      - 合計支払額
    ↓
    └─ ナビゲーション
        ├─ 対象月変更
        └─ 請求サマリーへ遷移可能
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [InvoiceService.java](../../../src/main/java/service/InvoiceService.java)
- **メソッド**: `secretaryInvoiceSummary()` (211行目): 支払サマリー表示

### 処理フロー

#### 1. 支払サマリー表示（GET `/admin/invoice/costs`）

1. **パラメータ取得**
   - `targetYM`: 対象月（yyyy-MM形式）
     - 省略時は当月（Asia/Tokyo）
     - `pickYearMonthParamPreferLegacy()` ヘルパーメソッドで取得（targetYMを優先）

2. **月次タイル用の年月算出**
   - `ym0`: 今月（Asia/Tokyo）
   - `ym1`: 先月
   - `ym2`: 先々月
   - `ym3`: 3ヶ月前
   - 各月の月番号（1-12）を取得

3. **当月明細の取得**
   - `InvoiceDAO.selectAdminLines(targetYM)` で秘書×顧客×ランクの明細を取得
   - SQL: `SQL_ADMIN_COST_LINES`（140行目）
   - GROUP BY: `secretary_id, secretary_name, customer_id, company_name, hourly_pay_sec, rank_name, rank_no`
   - ORDER BY: `secretary_name, company_name, rank_no`

4. **合計支払額の計算**
   - `grandTotalCost`: 今月の合計支払額（fee の合計）

5. **月次タイル用の支払額算出**
   - `costNow`: 今月の支払総額
   - `costPrev1`: 先月の支払総額
   - `costPrev2`: 先々月の支払総額
   - `costPrev3`: 3ヶ月前の支払総額

6. **画面用属性設定**
   - `targetYM`: 対象月
   - `yearMonth`: 対象月（互換用）
   - `costLines`: 秘書別支払明細（List<InvoiceDTO>）
   - `grandTotalCost`: 合計支払額
   - `m0`, `m1`, `m2`, `m3`: 各月の月番号
   - `ymNow`, `ymPrev1`, `ymPrev2`, `ymPrev3`: 各月の年月（yyyy-MM）
   - `costNow`, `costPrev1`, `costPrev2`, `costPrev3`: 各月の支払総額

7. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

8. **ビューへフォワード**
   - 支払サマリービュー（`invoice/admin/costs`）へフォワード

### トランザクション管理

```java
public String secretaryInvoiceSummary() {
    String targetYM = pickYearMonthParamPreferLegacy();  // targetYM を優先取得

    /** タイル表示（月の数字と YYYY-MM をセット） */
    ZoneId JST = ZoneId.of("Asia/Tokyo");
    YearMonth ym0 = YearMonth.now(JST);      // 今月
    YearMonth ym1 = ym0.minusMonths(1);
    YearMonth ym2 = ym0.minusMonths(2);
    YearMonth ym3 = ym0.minusMonths(3);

    req.setAttribute("m0", String.valueOf(ym0.getMonthValue()));
    req.setAttribute("m1", String.valueOf(ym1.getMonthValue()));
    req.setAttribute("m2", String.valueOf(ym2.getMonthValue()));
    req.setAttribute("m3", String.valueOf(ym3.getMonthValue()));

    req.setAttribute("ymNow",   ym0.toString());
    req.setAttribute("ymPrev1", ym1.toString());
    req.setAttribute("ymPrev2", ym2.toString());
    req.setAttribute("ymPrev3", ym3.toString());

    try (TransactionManager tm = new TransactionManager()) {
        InvoiceDAO dao = new InvoiceDAO(tm.getConnection());

        /** ① 当月明細（秘書×顧客×ランク） */
        List<InvoiceDTO> lines = dao.selectAdminLines(targetYM);

        BigDecimal grandTotal = lines.stream()
                .map(InvoiceDTO::getFee)
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        /** cost_summary.jsp が参照するキー名を厳守 */
        req.setAttribute("costLines", lines);
        req.setAttribute("grandTotalCost", grandTotal);

        /** 表示中YM（互換のため両方） */
        req.setAttribute(A_YM_LEGACY, targetYM);
        req.setAttribute(A_YM, targetYM);

        /** ② タイル用（4ヶ月分の総額） */
        req.setAttribute("costNow",   sumFee(dao.selectAdminLines(ym0.toString())));
        req.setAttribute("costPrev1", sumFee(dao.selectAdminLines(ym1.toString())));
        req.setAttribute("costPrev2", sumFee(dao.selectAdminLines(ym2.toString())));
        req.setAttribute("costPrev3", sumFee(dao.selectAdminLines(ym3.toString())));

        tm.commit();
        return VIEW_SUMMARY_ADMIN_COSTS;  // "invoice/admin/costs"
    } catch (Exception e) {
        throw new ServiceException("E:INV-S01 秘書支払サマリーの取得に失敗しました。", e);
    }
}

/** 請求金額合計（null を無視して加算） */
private BigDecimal sumFee(List<InvoiceDTO> list) {
    return list.stream()
            .map(InvoiceDTO::getFee)
            .filter(Objects::nonNull)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
}
```

**特徴**:
- 読み取り専用処理だが、明示的に `tm.commit()` を呼ぶ
- Stream API を使用した集計処理
- 4ヶ月分の集計を並行して実行

### DAO呼び出し

- **InvoiceDAO**
  - `selectAdminLines(String targetYM)`: 支払明細取得
    - SQL: `SQL_ADMIN_COST_LINES`（140行目）
    - JOIN: `tasks → assignments → customers, secretaries, task_rank`
    - GROUP BY: 秘書×顧客×ランクごとに集計
    - 集計項目: `SUM(work_minute)`, `hourly_pay_sec`（秘書単価）
    - 金額計算: `hourly_pay_sec × totalMinute / 60`（四捨五入）

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **論理削除フィルタ**: 削除済みタスクは集計対象外（`deleted_at IS NULL`）

## ビューファイル

- **支払サマリー画面**: [/WEB-INF/jsp/invoice/admin/costs.jsp](../../../src/main/webapp/WEB-INF/jsp/invoice/admin/costs.jsp)

### 画面表示項目

#### 月次タイル（4ヶ月分）

リクエスト属性から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **今月** | 今月の支払総額（costNow）、月番号（m0）、年月（ymNow） |
| **先月** | 先月の支払総額（costPrev1）、月番号（m1）、年月（ymPrev1） |
| **先々月** | 先々月の支払総額（costPrev2）、月番号（m2）、年月（ymPrev2） |
| **3ヶ月前** | 3ヶ月前の支払総額（costPrev3）、月番号（m3）、年月（ymPrev3） |

#### 秘書別支払明細

リクエスト属性 `costLines` (List<InvoiceDTO>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **秘書名** | 秘書氏名 |
| **顧客名** | 顧客企業名 |
| **ランク** | 業務ランク（A/B/C/D/E） |
| **稼働時間** | 合計作業時間（totalMinute、時:分形式） |
| **単価** | 秘書単価（hourlyPay） |
| **金額** | 支払金額（fee = hourlyPay × totalMinute / 60） |

#### 合計情報

| 項目 | 説明 |
|-----|------|
| **合計支払額** | 今月の支払総額（grandTotalCost） |

### 画面アクション

- **対象月変更**: プルダウンで対象月を選択
- **請求サマリーへ遷移**: ナビゲーションメニューから請求サマリーへ遷移可能
- **月次タイルクリック**: 各月のタイルをクリックして対象月を変更

## データモデル

### 使用するDTO

- **InvoiceDTO** ([dto/InvoiceDTO.java](../../../src/main/java/dto/InvoiceDTO.java))
  - 支払明細情報
  - `secretaryId`: 秘書ID
  - `secretaryName`: 秘書氏名
  - `customerId`: 顧客ID
  - `customerCompanyName`: 顧客企業名（実際は会社名）
  - `taskRankName`: 業務ランク名
  - `totalMinute`: 合計稼働時間（分）
  - `hourlyPay`: 秘書単価
  - `fee`: 支払金額
  - `targetYM`: 対象月

### リクエスト属性

- **targetYM** (String): 対象月（yyyy-MM）
- **yearMonth** (String): 対象月（互換用）
- **costLines** (List<InvoiceDTO>): 秘書別支払明細
- **grandTotalCost** (BigDecimal): 合計支払額
- **m0, m1, m2, m3** (String): 各月の月番号（1-12）
- **ymNow, ymPrev1, ymPrev2, ymPrev3** (String): 各月の年月（yyyy-MM）
- **costNow, costPrev1, costPrev2, costPrev3** (BigDecimal): 各月の支払総額

## エラーハンドリング

### システムエラー

- **ServiceException**: エラーメッセージ "E:INV-S01 秘書支払サマリーの取得に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト、金額=0）
- 過去月データがない場合、支払額は0として表示

## 備考

### 支払集計の仕様

- **集計対象**: 全タスク（承認状態に関わらず）
- **集計単位**: 秘書×顧客×ランク
- **金額計算**: `hourlyPay × totalMinute / 60`（四捨五入）
- **単価**: `base_pay_secretary + increase_base_pay_secretary + customer_based_incentive_for_secretary`

### 承認状態との関係

- 本画面では承認状態に関わらず全タスクを集計
- 実際の支払いは承認済みタスクのみが対象（運用による）

### 月次タイルの表示

- 今月から過去3ヶ月の支払額を表示
- 各月のタイルをクリックして対象月を変更可能
- 月番号（1-12）と年月（yyyy-MM）を表示

### パラメータの優先順位

- `pickYearMonthParamPreferLegacy()` により `targetYM` を優先取得
- 既存JSPとの互換性のため、`targetYM` と `yearMonth` の両方をサポート

### 対象月の指定

- URLパラメータで対象月を指定可能
- 省略時は当月（Asia/Tokyo）
- 過去月の集計も可能

### ソート順

- 秘書名、顧客名、ランク番号の昇順
- DAOレベルで固定（変更不可）

### 使用場面

- 月次の支払額確認
- 秘書別の支払明細確認
- 過去月との比較
- 支払い処理前の確認

### 関連機能

- **業務一覧表示** (30_業務一覧表示.md): タスクの確認
- **請求サマリー表示** (39_請求サマリー表示.md): 顧客への請求額集計
- **支払ステータス変更** (36_支払ステータス変更.md): 支払いステータス管理（未実装）
