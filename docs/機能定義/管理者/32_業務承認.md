# 32_業務承認（A05_21）

## 機能概要

未承認タスクを承認する機能です。単一承認と一括承認の両方に対応しています。承認されたタスクは請求対象となり、`approved_at` タイムスタンプが設定されます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| POST | `/admin/task/approve_bulk?taskIds[]={タスクID}&yearMonth={年月}&status={ステータス}` | 一括承認 | 選択されたタスクを一括承認 |

## 画面フロー

```
[業務一覧画面（未承認タブ）]
    ↓ チェックボックスで承認対象を選択
    ↓ 一括承認ボタンクリック
    ↓ POST /admin/task/approve_bulk
    |   - taskIds[]: 選択されたタスクIDの配列
    |   - yearMonth: 対象月
    |   - status: 表示中のステータス（通常は "unapproved"）
    ↓
[承認処理実行]
    - 選択されたタスクに対して承認処理を実行
    - approved_at に現在時刻を設定
    - approved_by に承認者（管理者）IDを設定
    ↓
    ├─ 選択なし
    |   ↓ 未承認一覧へリダイレクト
    |   └─ エラーメッセージなし
    |
    └─ 選択あり
        ↓ 各タスクに対して承認処理
        ↓ 既に承認済みのタスクはスキップ（エラーにならない）
        ↓ トランザクションコミット
        ↓ GET /admin/task/list_unapproved?yearMonth={年月}&status={ステータス}
        ↓
        [業務一覧画面（未承認タブ）]（承認後、対象タスクは非表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**: `adminTaskApproveBulk()` (670行目): 一括承認

### 処理フロー

#### 1. 一括承認（POST `/admin/task/approve_bulk`）

1. **パラメータ取得**
   - `taskIds[]`: 選択されたタスクIDの配列（必須）
   - `yearMonth`: 対象月（yyyy-MM形式、任意、デフォルト: 当月）
   - `status`: 表示中のステータス（任意、デフォルト: "all"）

2. **選択チェック**
   - `taskIds[]` が空または未指定の場合
   - エラーメッセージ "承認対象が選択されていません。" を設定
   - 未承認一覧（`adminTaskListUnapproved()`）へ遷移

3. **UUID変換**
   - 配列の各要素をUUIDに変換
   - 変換エラー時はスキップ（無視）
   - 全て変換エラーの場合、エラーメッセージを設定して未承認一覧へ遷移

4. **承認者ID取得**
   - セッションから `LoginUser` を取得
   - `LoginUser.getSystemAdmin().getId()` で承認者IDを取得
   - セッションがない場合は承認者IDを null に設定

5. **一括承認処理**
   - 各タスクIDに対して:
     - `TaskDAO.approve(taskId, approverId)` で承認処理
     - SQL: `UPDATE tasks SET approved_at = NOW(), approved_by = ?, updated_at = NOW() WHERE id = ? AND deleted_at IS NULL AND approved_at IS NULL`
     - 条件: 論理未削除 かつ 未承認のみ
     - 既に承認済みのタスクはスキップ（影響行数=0）
     - 個別のエラーは catch してスキップ（全体のトランザクションは継続）

6. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

7. **リダイレクト**
   - 未承認一覧へリダイレクト
   - リダイレクト先: `/admin/task/list_unapproved?yearMonth={年月}&status={ステータス}`

### トランザクション管理

```java
public String adminTaskApproveBulk() {
    final String[] idParams = req.getParameterValues("taskIds");
    final String yearMonth = Optional.ofNullable(req.getParameter(P_YEAR_MONTH))
            .filter(s -> !s.isBlank())
            .orElse(LocalDate.now(Z_TOKYO).format(YM_FMT));
    final String status = Optional.ofNullable(req.getParameter(P_STATUS))
            .filter(s -> !s.isBlank())
            .orElse("all");

    if (idParams == null || idParams.length == 0) {
        validation.addErrorMsg("承認対象が選択されていません。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return adminTaskListUnapproved();
    }

    final List<UUID> ids = new ArrayList<>();
    for (String s : idParams) {
        try { ids.add(UUID.fromString(s)); } catch (Exception ignore) {}
    }
    if (ids.isEmpty()) {
        validation.addErrorMsg("承認対象IDが不正です。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        return adminTaskListUnapproved();
    }

    UUID approverId = null;
    HttpSession session = req.getSession(false);
    if (session != null) {
        LoginUser lu = (LoginUser) session.getAttribute(ATTR_LOGIN_USER);
        if (lu != null && lu.getSystemAdmin() != null) {
            approverId = lu.getSystemAdmin().getId();
        }
    }

    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        for (UUID id : ids) {
            try { dao.approve(id, approverId); }
            catch (RuntimeException ex) { ex.printStackTrace(); }
        }
        tm.commit();  // 明示的コミット
    } catch (RuntimeException e) {
        validation.addErrorMsg("一括承認に失敗しました。やり直してください。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        e.printStackTrace();
        return req.getContextPath() + req.getServletPath() + "/error";
    }

    return req.getContextPath() + "/admin/task/list_unapproved?yearMonth=" + yearMonth + "&status=" + status;
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- 個別のエラーは catch してスキップ（全体のトランザクションは継続）
- 既に承認済みのタスクはDAOレベルでスキップ（WHERE句の条件）

### DAO呼び出し

- **TaskDAO**
  - `approve(UUID taskId, UUID approvedBy)`: タスク承認
    - SQL: 動的SQL（1098行目）
    - 処理: `approved_at = NOW()`, `approved_by = ?`, `updated_at = NOW()` を設定
    - 条件: `id = ? AND deleted_at IS NULL AND approved_at IS NULL`
    - 影響行数を返す（1: 成功, 0: 既に承認済み or 不在）

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なIDは自動的にスキップ
- **論理削除フィルタ**: 削除済みタスクは承認できない
- **二重承認防止**: 既に承認済みのタスクは自動的にスキップ（WHERE句の条件）
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **未承認一覧画面**: [/WEB-INF/jsp/task/admin/list_unapproved.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_unapproved.jsp)

### 画面表示項目

#### 承認対象選択

| 項目 | 説明 |
|-----|------|
| **全選択チェックボックス** | 全タスクを一括選択 |
| **個別チェックボックス** | 各タスクを個別選択 |
| **一括承認ボタン** | 選択されたタスクを一括承認 |

#### タスク一覧

未承認タスクの一覧表示（詳細は 30_業務一覧表示.md を参照）

### 画面アクション

- **一括承認ボタン**: 選択されたタスクを一括承認（`/admin/task/approve_bulk`）
  - POST メソッドでリクエスト
  - フォームで選択されたタスクIDを配列で送信
  - 実行後は未承認一覧へリダイレクト

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `approved_at`: 承認日時
  - `approved_by`: 承認者ID（SecretaryDTO）

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - 承認者情報（システム管理者）

### URLパラメータ

- **taskIds[]** (String[]): 選択されたタスクIDの配列
- **yearMonth** (String): 対象月（yyyy-MM形式）
- **status** (String): 表示中のステータス

## エラーハンドリング

### バリデーションエラー

- **選択なし**: `taskIds[]` が空または未指定
  - 未承認一覧へ遷移
  - エラーメッセージ: "承認対象が選択されていません。"

- **UUID形式エラー**: UUID形式に変換できないIDが含まれる
  - 該当IDはスキップ
  - 全て変換エラーの場合: エラーメッセージ "承認対象IDが不正です。"

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- **一括承認失敗**: エラーメッセージ "一括承認に失敗しました。やり直してください。"
- トランザクションは自動ロールバック

### 正常系

- 選択されたタスクが0件の場合でもエラー表示
- 既に承認済みのタスクはスキップ（エラーにならない）
- 一部のタスクでエラーが発生しても全体のトランザクションは継続

## 備考

### 承認の仕様

- **承認日時**: `approved_at` に現在時刻（NOW()）を設定
- **承認者**: `approved_by` に承認者（管理者）IDを設定
- **請求対象**: 承認されたタスクは請求対象となる
- **更新日時**: `updated_at` に現在時刻を設定

### 二重承認防止

- WHERE句の条件 `approved_at IS NULL` により、既に承認済みのタスクは自動的にスキップ
- 影響行数=0 の場合でもエラーにならない

### 個別エラーのハンドリング

- 各タスクの承認処理でエラーが発生しても、全体のトランザクションは継続
- 個別のエラーは catch してスキップ（`catch (RuntimeException ex) { ex.printStackTrace(); }`）
- 全体のトランザクションはコミットされる

### 承認者IDの設定

- セッションから取得した管理者IDを設定
- セッションがない場合は null を設定（承認者不明として記録）

### リダイレクト先

- 承認後は未承認一覧へリダイレクト
- 対象月（yearMonth）とステータス（status）をURLパラメータで引き継ぎ
- 承認されたタスクは未承認一覧から消える（`approved_at IS NOT NULL` の条件）

### 使用場面

- 月次の業務承認作業
- 未承認業務の一括承認
- 秘書からの業務申請の承認

### 関連機能

- **業務一覧表示** (30_業務一覧表示.md): 未承認タスクの一覧表示
- **承認済み業務取消し** (34_承認済み業務取消し.md): 承認の取消
- **業務差戻し** (33_業務差戻し.md): 承認の代わりに差戻し
- **請求サマリー表示** (39_請求サマリー表示.md): 承認済みタスクの集計表示
