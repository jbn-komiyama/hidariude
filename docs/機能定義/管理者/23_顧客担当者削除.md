# 23_顧客担当者削除（A04_18）

## 機能概要

既存の顧客担当者を論理削除する機能です。物理削除ではなく `deleted_at` タイムスタンプを設定することで、データベースからレコードを削除せずに無効化します。削除された担当者は一覧に表示されなくなり、ログインもできなくなります。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/contact/delete?id={担当者ID}&customerId={顧客ID}` | 削除処理 | 指定IDの担当者を論理削除し、担当者一覧画面へリダイレクト |

## 画面フロー

```
[担当者一覧画面]
    ↓ 削除ボタンをクリック（JavaScript確認ダイアログ）
    ↓ confirm('削除しますか？この操作は取り消せません。')
    |
    ├─ キャンセル → 元の画面に留まる
    └─ OK → GET /admin/contact/delete?id={担当者UUID}&customerId={顧客UUID}
        ↓
        ├─ ID形式エラー → [エラー画面] へリダイレクト
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 削除成功 → [担当者一覧画面] へリダイレクト
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [ContactService.java](../../../src/main/java/service/ContactService.java)
- **メソッド**: `contactDelete()` (443行目): 担当者論理削除

### 処理フロー

#### 1. 削除処理（GET `/admin/contact/delete?id={UUID}&customerId={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 削除対象の担当者ID（UUID形式）
   - `customerId`: 顧客ID（UUID形式）
   - `validation.isUuid(id)` および `validation.isUuid(customerId)` でUUID形式チェック
   - 不正な形式の場合: "不正なIDが指定されました。" エラー

2. **論理削除実行**
   - `CustomerContactDAO.delete(id)` で論理削除実行
   - `deleted_at` カラムに `CURRENT_TIMESTAMP` を設定
   - トランザクションコミット

3. **担当者一覧画面へリダイレクト**
   - 削除成功後、担当者一覧画面（`/admin/contact?customerId={顧客ID}`）へリダイレクト
   - 削除されたレコードは一覧に表示されなくなる

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID id = UUID.fromString(idStr);
    CustomerContactDAO dao = new CustomerContactDAO(tm.getConnection());
    dao.delete(id);
    tm.commit();
    return req.getContextPath() + "/admin/contact?customerId=" + cidStr;

} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- try-with-resourcesで自動クローズ
- 明示的にコミット（`tm.commit()`）を呼ぶ必要がある
- エラー時は自動ロールバック
- リダイレクト時に顧客IDを引き継ぐ

### DAO呼び出し

- **CustomerContactDAO**
  - `delete(UUID id)`: 担当者を論理削除
    - SQL: `UPDATE customer_contacts SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?`
    - 戻り値: なし（void）
    - 例外: `DAOException` - "E:CC32 論理DELETE に失敗しました。"

### セキュリティ

- **論理削除**: 物理削除ではなく論理削除を使用
  - データはデータベースに残り、監査証跡として保持される
  - `deleted_at IS NULL` 条件により、削除されたレコードは自動的に除外される
- **UUID検証**: 不正なID形式をエラーとして処理
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

削除処理は直接リダイレクトするため、専用のビューファイルはありません。

### 削除ボタンの実装

削除ボタンは担当者一覧画面に配置されており、JavaScriptの確認ダイアログを使用します:

```html
<a class="btn btn-sm btn-outline-danger"
   href="${pageContext.request.contextPath}/admin/contact/delete?id=${contact.id}&customerId=${customer.id}"
   onclick="return confirm('削除しますか？この操作は取り消せません。');">
   削除
</a>
```

## データモデル

### 使用するDTO

削除処理ではDTOの読み込みは行いません（IDのみ使用）。

### テーブル構造

- **customer_contacts** テーブル
  - `id` (UUID): 担当者ID
  - `customer_id` (UUID): 顧客ID（FK）
  - `deleted_at` (Timestamp): 削除日時（NULL = 有効）

## エラーハンドリング

### バリデーションエラー

- **ID形式エラー**: "不正なIDが指定されました。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

### 論理削除の仕組み

- **物理削除ではなく論理削除**: レコードは削除されず、`deleted_at` タイムスタンプが設定される
- **自動除外**: 全てのSELECTクエリで `deleted_at IS NULL` 条件を使用するため、削除されたレコードは自動的に除外される
- **データ保持**: 削除されたデータは監査証跡として保持される
- **復元可能**: 必要に応じて `deleted_at` をNULLに戻すことで復元可能（管理者操作が必要）

### 削除の影響範囲

- **担当者一覧画面**: 削除された担当者は表示されなくなる
- **ログイン**: 削除された担当者はログインできなくなる（`deleted_at IS NULL` 条件）
- **顧客詳細画面**: 削除された担当者は担当者一覧に表示されなくなる
- **主担当者の削除**: 主担当者を削除しても、顧客の `primary_contact_id` は変更されない
  - 顧客詳細画面では主担当者が表示されなくなる（JOIN条件で除外される）
  - 主担当者を設定し直す場合は、別の担当者を編集して主担当フラグをONにする

### 削除時の注意事項

- **確認ダイアログ**: JavaScriptで削除確認ダイアログを表示
  - "削除しますか？この操作は取り消せません。"
  - ユーザーがキャンセルした場合、削除処理は実行されない
- **リダイレクト**: 削除成功後、担当者一覧画面へリダイレクト
  - 削除されたレコードは一覧に表示されなくなる
  - リダイレクト時に顧客IDを引き継ぐ（`?customerId={UUID}`）
- **エラー時**: エラー画面へリダイレクト
  - エラーメッセージが表示される
- **主担当者の削除**: 主担当者を削除しても特別な警告は表示されない
  - 主担当者がいない状態になる可能性がある

### その他

- 削除完了メッセージは表示されない（担当者一覧画面へ直接リダイレクト）
- 削除日時（`deleted_at`）は自動設定（`CURRENT_TIMESTAMP`）
- 削除後、IDは再利用されない（UUIDのため）
- 削除された担当者のメールアドレスは再利用可能（論理削除されたレコードは重複チェック対象外）
- 顧客削除時、紐づく担当者も自動的に論理削除される（`CustomerDAO.delete()` 内で処理）
