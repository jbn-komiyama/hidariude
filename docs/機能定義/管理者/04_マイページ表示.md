# 04_マイページ表示（A02_01）

## 機能概要

ログイン中のシステム管理者が自身のアカウント情報（氏名、メールアドレス、ふりがな、作成日時など）を確認できる画面を表示する機能です。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/mypage/home` | マイページ表示 | 自身のアカウント情報を表示 |

## 画面フロー

```
[任意の管理者画面]
    ↓ マイページリンククリック
    ↓ GET /admin/mypage/home
    ↓
[マイページ画面] - アカウント情報表示
    ↓
編集ボタンをクリック → [マイページ編集画面] へ遷移
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CommonService.java](../../../src/main/java/service/CommonService.java)
- **メソッド**: `adminMyPageHome()`

### 処理フロー

1. **セッション取得**
   - `req.getSession(false)` で既存のセッションを取得
   - セッションが存在しない場合は `/admin` へリダイレクト

2. **ログインユーザー確認**
   - セッションから `loginUser` 属性を取得し、管理者IDを参照
   - `loginUser`、`systemAdmin`、または `systemAdmin.id` が `null` の場合は `/admin` へリダイレクト

3. **DBから最新情報を取得**
   - `SystemAdminDAO.selectById(adminId)` で管理者情報を取得
   - 該当レコードがない場合は `/admin` へリダイレクト

4. **Domainへの詰め替えとセッション同期**
   - `ConvertUtil.toDomain(SystemAdminDTO)` で Domain オブジェクトへ変換
   - 取得した情報でセッション内の `loginUser.systemAdmin` を更新

5. **画面表示用データ設定**
   - Domain オブジェクトを `admin` 属性としてリクエストに設定
   - セッションに格納したフラッシュメッセージ（`flashSuccessMsg`）があればリクエストに移して表示

6. **ビューへフォワード**
   - マイページビュー（`mypage/admin/home`）へフォワード

### トランザクション管理

- **データベースアクセスあり**: 最新情報を表示するため `SystemAdminDAO` から取得
- `TransactionManager` を使用してトランザクション境界を管理

### DAO呼び出し

- **SystemAdminDAO**
  - `selectById(UUID id)`: 管理者情報を取得

### セキュリティ

- **セッションチェック**: ログイン済みであることを確認
- **未ログイン時**: ログイン画面（`/admin`）へリダイレクト

## ビューファイル

- **マイページ画面**: [/WEB-INF/jsp/mypage/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/mypage/admin/home.jsp)

### 画面表示項目

リクエスト属性 `admin` (SystemAdmin) から以下の情報を表示：

- **ID**: 管理者ID（UUID）
- **メールアドレス**: ログインIDとして使用
- **氏名**: 管理者の氏名
- **ふりがな**: 氏名のふりがな
- **作成日時**: アカウント作成日時
- **更新日時**: 最終更新日時
- **最終ログイン日時**: 最後にログインした日時

### 画面アクション

- **編集ボタン**: マイページ編集画面（`/admin/id_edit`）へ遷移

## データモデル

### リクエスト属性

- **admin** (SystemAdmin): ログイン中の管理者情報
  - セッションの `loginUser.systemAdmin` をそのまま設定

### 使用するDomainオブジェクト

- **LoginUser** ([domain/LoginUser.java](../../../src/main/java/domain/LoginUser.java))
  - `systemAdmin` (SystemAdmin): 管理者情報
  - `authority` (int): 権限値（`1` = システム管理者）

- **SystemAdmin** ([domain/SystemAdmin.java](../../../src/main/java/domain/SystemAdmin.java))
  - `id` (UUID): 管理者ID
  - `mail` (String): メールアドレス
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `createdAt` (Date): 作成日時
  - `updatedAt` (Date): 更新日時
  - `deletedAt` (Date): 削除日時（NULL = 有効）
  - `lastLoginAt` (Date): 最終ログイン日時

## エラーハンドリング

### セッションエラー

- **セッション不在**: ログイン画面（`/admin`）へリダイレクト
- **loginUser不在**: ログイン画面（`/admin`）へリダイレクト
- **systemAdmin不在**: ログイン画面（`/admin`）へリダイレクト

### システムエラー

- マイページ表示ではデータベースアクセスを行わないため、通常システムエラーは発生しない

## 備考

- セッションに保存された情報をそのまま表示するため、リアルタイムなデータベース情報ではない
- 他の管理者が同じアカウントの情報を変更しても、再ログインするまで反映されない
- 編集画面（A02_02）では最新情報をデータベースから取得する
- パスワードは表示されない（セキュリティ上の理由）
