# 27_アサイン削除(A05_04)

## 機能概要

登録済みのアサインを論理削除する機能です。JavaScript確認ダイアログで削除確認を行い、OKの場合はアサインを論理削除（deleted_atを設定）します。紐づくタスクが存在する場合は削除不可として、エラーメッセージを表示します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| POST | `/admin/assignment/delete?id={アサインID}&targetYM={年月}` | アサイン削除処理 | アサインの論理削除実行 |

## 画面フロー

```
[アサイン一覧画面]
    ↓ 削除ボタンクリック
    ↓ JavaScript確認ダイアログ表示
    |   「このアサインを削除してもよろしいですか?」
    |
    ├─ キャンセル → 一覧画面に留まる
    |
    └─ OK
        ↓ POST /admin/assignment/delete?id={アサインID}&targetYM={年月}
        ↓ タスク存在チェック
        |
        ├─ タスクあり → エラーメッセージ表示
        |   ↓ 「このアサインにはタスクが登録されています。削除できません。」
        |   ↓ GET /admin/assignment?targetYM={年月}
        |   ↓
        |   [アサイン一覧画面]（エラーメッセージ表示）
        |
        └─ タスクなし → 論理削除実行
            ↓ deleted_at を現在時刻に更新
            ↓ GET /admin/assignment?targetYM={年月}
            ↓
            [アサイン一覧画面]（削除後の一覧表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**: `assignmentDelete()` (923行目): アサイン削除処理

### 処理フロー

#### アサイン削除処理（POST `/admin/assignment/delete`）

1. **パラメータ取得・検証**
   - `id`: アサインID（UUID形式、必須）
   - `targetYM`: 対象月（yyyy-MM形式、戻り先URLパラメータ用）
   - バリデーション: `isUuid()` で形式チェック
   - エラー時: エラーメッセージをセットしてアサイン一覧へリダイレクト

2. **アサイン情報取得**
   - `AssignmentDAO.selectOne(id)` で削除対象のアサイン情報を取得
   - 対象月を取得（戻り先URL用）

3. **タスク存在チェック**
   - `AssignmentDAO.hasTasks(id)` で紐づくタスクの存在を確認
   - タスク存在時:
     - エラーメッセージ「このアサインにはタスクが登録されています。削除できません。」をセット
     - アサイン一覧へリダイレクト（削除しない）

4. **論理削除実行**
   - `AssignmentDAO.delete(id)` でdeleted_atを現在時刻に更新
   - トランザクションコミット（`tm.commit()`）

5. **リダイレクト**
   - アサイン一覧へリダイレクト（対象月を指定）
   - リダイレクト先: `/admin/assignment?targetYM={年月}`

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());
    UUID id = UUID.fromString(idStr);

    AssignmentDTO cur = dao.selectOne(id);
    String ym = (cur != null ? cur.getTargetYearMonth() : ymBack);

    if (dao.hasTasks(id)) {
        req.setAttribute(A_ERROR, List.of("このアサインにはタスクが登録されています。削除できません。"));
        return req.getContextPath() + "/admin/assignment?targetYM=" + (ym != null ? ym : "");
    }

    dao.delete(id);
    tm.commit();  // 明示的コミット
    return req.getContextPath() + "/admin/assignment?targetYM=" + (ym != null ? ym : "");
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- タスク存在時はコミットせずにリダイレクト

### DAO呼び出し

- **AssignmentDAO**
  - `selectOne(UUID id)`: アサイン情報取得（対象月取得用）
    - SQL: `SQL_SELECT_ONE_MINIMAL`（640行目）
  - `hasTasks(UUID assignmentId)`: 紐づくタスクの存在チェック
    - SQL: `SQL_COUNT_TASKS_BY_ASSIGNMENT`（637行目）
    - タスク件数が0より大きい場合true
  - `delete(UUID id)`: アサインの論理削除
    - SQL: `SQL_DELETE_LOGICAL`（439行目）
    - deleted_atを現在時刻に更新

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なUUID形式を拒否
- **タスク存在チェック**: 紐づくタスクがある場合は削除不可
- **論理削除**: 物理削除ではなく論理削除（deleted_at設定）のため復元可能
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **削除処理**: ビューなし（アサイン一覧へリダイレクト）
- **削除ボタン**: [/WEB-INF/jsp/assignment/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/home.jsp) 内に配置

### 削除ボタン表示（一覧画面）

JavaScriptによる確認ダイアログ:

```javascript
if (confirm('このアサインを削除してもよろしいですか?')) {
    form.action = '/admin/assignment/delete';
    form.method = 'POST';
    form.submit();
}
```

## データモデル

### 使用するDTO

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報（対象月取得用）

### リクエスト属性

#### エラー時

- **errorMsg** (List<String>): エラーメッセージ
  - 「不正なアサインIDです。」（UUID形式エラー）
  - 「このアサインにはタスクが登録されています。削除できません。」（タスク存在エラー）

#### 正常時

- なし（リダイレクトのみ）

### URLパラメータ

- **id** (String): 削除対象のアサインID（UUID形式）
- **targetYM** (String): 戻り先の対象月（yyyy-MM形式）

## エラーハンドリング

### バリデーションエラー

- **UUID形式エラー**: 不正なアサインID
  - エラーメッセージ「不正なアサインIDです。」
  - アサイン一覧へリダイレクト

### ビジネスロジックエラー

- **タスク存在エラー**: 紐づくタスクが存在する
  - エラーメッセージ「このアサインにはタスクが登録されています。削除できません。」
  - アサイン一覧へリダイレクト（削除しない）

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

### 論理削除

- 物理削除ではなく論理削除（deleted_at設定）
- 削除済みレコードはクエリ時に除外（WHERE deleted_at IS NULL）
- 削除後も復元可能（deleted_atをNULLに更新すれば復活）

### タスク存在チェック

- 紐づくタスク（tasks テーブル）が1件でも存在する場合は削除不可
- タスクを先に削除してからアサインを削除する運用
- データ整合性を保つための制約

### JavaScript確認ダイアログ

- 削除ボタンクリック時にJavaScript confirmダイアログを表示
- ユーザーの誤操作を防止
- キャンセル時はリクエスト送信しない

### リダイレクト先

- 削除後はアサイン一覧へリダイレクト
- 対象月（targetYM）をURLパラメータで引き継ぎ
- エラー時も同様にアサイン一覧へリダイレクト（エラーメッセージ表示）

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): 削除後の一覧表示
- **秘書アサイン登録** (26_秘書アサイン登録.md): アサイン再登録
- **タスク管理**: 紐づくタスクの削除が必要な場合
