# 15_顧客一覧表示（A04_10）

## 機能概要

登録されている全ての顧客の一覧を表示する機能です。各顧客の基本情報（会社コード、会社名、メールアドレス、電話番号、作成日時など）を確認できます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/customer` | 顧客一覧表示 | 全顧客の一覧を表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 顧客一覧リンククリック
    ↓ GET /admin/customer
    ↓
[顧客一覧画面]
    ↓
    ├─ 新規登録ボタン → [顧客新規登録画面] へ遷移
    ├─ 詳細ボタン → [顧客詳細画面] へ遷移
    ├─ 編集ボタン → [顧客編集画面] へ遷移
    └─ 削除ボタン → 削除処理実行
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CustomerService.java](../../../src/main/java/service/CustomerService.java)
- **メソッド**: `customerList()` (126行目): 顧客一覧表示

### 処理フロー

#### 1. 顧客一覧画面表示（GET `/admin/customer`）

1. **データベース接続**
   - `TransactionManager` で接続取得
   - トランザクション開始（読み取り専用）

2. **全顧客取得**
   - `CustomerDAO.selectAll()` で全顧客を取得
   - 論理削除されていない顧客のみ取得（`deleted_at IS NULL`）

3. **リスト変換**
   - DTOリストをDomainオブジェクトのリストに変換
   - `ConvertUtil.toDomain()` でDTO → Domain変換

4. **画面表示用データ設定**
   - `customers` 属性にリストを設定
   - リクエストスコープに格納

5. **ビューへフォワード**
   - 一覧ビュー（`customer/admin/home`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    CustomerDAO dao = new CustomerDAO(tm.getConnection());
    List<CustomerDTO> dtos = dao.selectAll();

    /** DTO -> Domain へ詰替 */
    List<Customer> customers = new ArrayList<>(dtos.size());
    for (CustomerDTO dto : dtos) {
        customers.add(conv.toDomain(dto));
    }

    req.setAttribute(A_CUSTOMERS, customers);
    return VIEW_HOME;
} catch (RuntimeException e) {
    validation.addErrorMsg("顧客一覧の取得に失敗しました。");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

### DAO呼び出し

- **CustomerDAO**
  - `selectAll()`: 全顧客を取得
    - SQL: `SELECT * FROM customers WHERE deleted_at IS NULL ORDER BY created_at DESC`

### セキュリティ

- **論理削除フィルタ**: 削除済み顧客は表示されない
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **一覧画面**: [/WEB-INF/jsp/customer/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/customer/admin/home.jsp)

### 画面表示項目

リクエスト属性 `customers` (List<Customer>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **会社コード** | 顧客を識別するコード |
| **会社名** | 顧客企業名 |
| **メールアドレス** | 連絡先メールアドレス |
| **電話番号** | 連絡先電話番号 |
| **住所** | 郵便番号・住所1・住所2・建物名 |
| **作成日時** | アカウント作成日時 |
| **アクション** | 詳細・編集・削除ボタン |

### 画面アクション

- **新規登録ボタン**: 顧客新規登録画面（`/admin/customer/register`）へ遷移
- **詳細ボタン**: 顧客詳細画面（`/admin/customer/detail?id={顧客ID}`）へ遷移
- **編集ボタン**: 顧客編集画面（`/admin/customer/edit?id={顧客ID}`）へ遷移
- **削除ボタン**: 削除確認後、削除処理実行（`/admin/customer/delete`）

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - `id` (UUID): 顧客ID
  - `companyCode` (String): 会社コード
  - `companyName` (String): 会社名
  - `mail` (String): メールアドレス
  - `phone` (String): 電話番号
  - `postalCode` (String): 郵便番号
  - `address1` (String): 住所1
  - `address2` (String): 住所2
  - `building` (String): 建物名
  - `createdAt` (Timestamp): 作成日時
  - `updatedAt` (Timestamp): 更新日時
  - `deletedAt` (Timestamp): 削除日時（NULL = 有効）

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報を保持するDomainオブジェクト

### リクエスト属性

- **customers** (List<Customer>): 顧客リスト

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "顧客一覧の取得に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）

## 備考

### 機能一覧の備考欄より

- **ソートとフィルタリングが無い**: 現在は実装されていない
  - 将来的にソート機能（会社名順、作成日時順など）の追加を検討
  - フィルタリング機能（会社名検索、会社コード検索など）の追加を検討

### その他

- 一覧にソート・フィルタリング機能は実装されていない
- ページネーション機能は未実装（顧客数が少ないため）
- 論理削除された顧客は表示されないが、データベースには残る
- 一覧画面では主要な連絡先情報のみ表示（詳細は詳細画面で確認）
