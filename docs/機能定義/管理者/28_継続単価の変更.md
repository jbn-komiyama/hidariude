# 28_継続単価の変更(A05_05)

## 機能概要

既存アサインの継続単価（インセンティブ）を変更する機能です。2画面構成（編集フォーム→完了）で、顧客向けインセンティブと秘書向けインセンティブを更新します。対象月の顧客×秘書の全レコードを一括更新し、さらに翌月に同じ組み合わせのアサインが存在する場合は翌月分も自動更新します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/assignment/edit?id={アサインID}&targetYM={年月}` | 継続単価編集フォーム | 継続単価の編集画面表示 |
| POST | `/admin/assignment/edit_update?id={アサインID}&targetYM={年月}` | 継続単価更新処理 | 継続単価の更新実行 |

## 画面フロー

```
[アサイン一覧画面]
    ↓ 継続単価変更ボタンクリック
    ↓ GET /admin/assignment/edit?id={アサインID}&targetYM={年月}
    ↓
[継続単価編集画面] (edit_incentive.jsp)
    - 顧客名: 固定表示（変更不可）
    - 秘書名: 固定表示（変更不可）
    - 対象月: 固定表示（変更不可）
    - タスクランク: 固定表示（変更不可）
    - 継続単価（顧客）: 金額入力
    - 継続単価（秘書）: 金額入力
    ↓ 更新ボタン
    ↓ POST /admin/assignment/edit_update?id={アサインID}&targetYM={年月}
    ↓ 金額バリデーション
    ↓
    ├─ エラー時 → 編集フォームへ戻る
    |
    └─ 成功時
        ↓ 対象月の顧客×秘書の全レコードを一括更新
        ↓ 翌月に同じ組み合わせが存在する場合、翌月分も一括更新
        ↓ GET /admin/assignment?targetYM={年月}
        ↓
        [アサイン一覧画面]（更新後の一覧表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**:
  - `assignmentEditIncentiveForm()` (827行目): 継続単価編集フォーム表示
  - `assignmentEditIncentiveUpdate()` (860行目): 継続単価更新処理

### 処理フロー

#### 1. 継続単価編集フォーム表示（GET `/admin/assignment/edit`）

1. **パラメータ取得・検証**
   - `id`: アサインID（UUID形式、必須）
   - `targetYM`: 対象月（yyyy-MM形式、戻り先URLパラメータ用）
   - バリデーション: `isUuid()` で形式チェック
   - エラー時: エラーメッセージをセットしてアサイン一覧へリダイレクト

2. **アサイン情報取得**
   - `AssignmentDAO.selectOneWithNames(id)` で編集対象のアサイン情報を取得
   - 顧客名、秘書名、タスクランク名、継続単価を含む
   - 取得できない場合: エラーメッセージをセットしてアサイン一覧へリダイレクト

3. **画面表示**
   - リクエスト属性 `row` にアサイン情報をセット
   - リクエスト属性 `targetYM` に対象月をセット
   - 編集フォーム（`assignment/admin/edit_incentive`）へフォワード

#### 2. 継続単価更新処理（POST `/admin/assignment/edit_update`）

1. **パラメータ取得・検証**
   - `id`: アサインID（UUID形式、必須）
   - `targetYM`: 対象月（yyyy-MM形式）
   - `customerBasedIncentiveForCustomer`: 継続単価（顧客）
   - `customerBasedIncentiveForSecretary`: 継続単価（秘書）
   - UUID形式チェック: `isUuid()` で検証
   - 金額チェック: `mustBeMoneyOrZero()` で検証（カンマ除去対応）

2. **バリデーションエラー時**
   - エラーメッセージをリクエスト属性にセット
   - 編集フォーム表示メソッド（`assignmentEditIncentiveForm()`）を呼び出して再表示

3. **アサイン情報取得**
   - `AssignmentDAO.selectOne(id)` でアサイン情報を取得
   - 顧客ID、秘書ID、対象月を取得
   - 取得できない場合: エラーメッセージをセットしてアサイン一覧へリダイレクト

4. **金額変換**
   - `parseMoneyOrZero()` でカンマ除去してBigDecimalに変換

5. **対象月の一括更新**
   - `AssignmentDAO.updateIncentivesByPairAndMonth()` で対象月の更新
   - 更新対象: 顧客×秘書×対象月の全レコード
   - ただし、rank_no = 0（PM秘書）は除外

6. **翌月の一括更新**
   - 対象月の翌月（YearMonth.plusMonths(1)）を計算
   - 同じ顧客×秘書の組み合わせで翌月にアサインが存在する場合
   - `AssignmentDAO.updateIncentivesByPairAndMonth()` で翌月分も更新
   - 更新件数が0の場合はスルー（翌月にアサインが存在しない）

7. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

8. **リダイレクト**
   - アサイン一覧へリダイレクト（対象月を指定）
   - リダイレクト先: `/admin/assignment?targetYM={対象月}`

### トランザクション管理

#### 編集フォーム表示

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());
    AssignmentDTO d = dao.selectOneWithNames(UUID.fromString(idStr));
    if (d == null) {
        req.setAttribute(A_ERROR, List.of("対象のアサインが見つかりません。"));
        return req.getContextPath() + "/admin/assignment?targetYM=" + (ym != null ? ym : "");
    }
    req.setAttribute("row", d);
    req.setAttribute(A_TARGET_YM, ym != null ? ym : d.getTargetYearMonth());
    return VIEW_EDIT_INCENTIVE;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

#### 更新処理

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());

    AssignmentDTO cur = dao.selectOne(UUID.fromString(idStr));
    if (cur == null) {
        req.setAttribute(A_ERROR, List.of("対象のアサインが見つかりません。"));
        return req.getContextPath() + "/admin/assignment?targetYM=" + (ymBack != null ? ymBack : "");
    }

    BigDecimal custVal = parseMoneyOrZero(incCust);
    BigDecimal secVal  = parseMoneyOrZero(incSec);

    // 対象月の一括更新
    dao.updateIncentivesByPairAndMonth(
            cur.getAssignmentCustomerId(),
            cur.getAssignmentSecretaryId(),
            cur.getTargetYearMonth(),
            custVal, secVal
    );

    // 翌月の一括更新
    YearMonth thisYm = YearMonth.parse(cur.getTargetYearMonth());
    String nextYm    = thisYm.plusMonths(1).toString();

    dao.updateIncentivesByPairAndMonth(
            cur.getAssignmentCustomerId(),
            cur.getAssignmentSecretaryId(),
            nextYm,
            custVal, secVal
    );

    tm.commit();  // 明示的コミット
    return req.getContextPath() + "/admin/assignment?targetYM=" + cur.getTargetYearMonth();
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- 対象月と翌月の2回UPDATE実行（翌月の更新件数が0でもエラーにならない）

### DAO呼び出し

- **AssignmentDAO**
  - `selectOneWithNames(UUID id)`: アサイン情報取得（名称付き）
    - SQL: `SQL_SELECT_ONE_WITH_NAMES`（610行目）
    - 顧客名、秘書名、タスクランク名を含む
  - `selectOne(UUID id)`: アサイン情報取得（最小）
    - SQL: `SQL_SELECT_ONE_MINIMAL`（640行目）
    - 顧客ID、秘書ID、対象月を取得
  - `updateIncentivesByPairAndMonth(UUID customerId, UUID secretaryId, String yearMonth, BigDecimal custVal, BigDecimal secVal)`: 継続単価一括更新
    - SQL: `SQL_UPDATE_INCENTIVES_BY_PAIR_MONTH`（623行目）
    - 顧客×秘書×年月の全レコードを一括更新
    - rank_no != 0（PM秘書以外）のみ更新

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なUUID形式を拒否
- **金額検証**: 数値以外の入力を拒否（カンマ区切りは許容）
- **PM秘書除外**: rank_no = 0（PM秘書）は更新対象外
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **編集画面**: [/WEB-INF/jsp/assignment/admin/edit_incentive.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/edit_incentive.jsp)

### 編集画面 (edit_incentive.jsp)

| 項目 | 種別 | 説明 |
|-----|------|------|
| **顧客名** | 固定表示 | 変更不可 |
| **秘書名** | 固定表示 | 変更不可 |
| **対象月** | 固定表示 | 変更不可 |
| **タスクランク** | 固定表示 | 変更不可 |
| **継続単価（顧客）** | テキスト入力 | 金額（カンマ区切り可） |
| **継続単価（秘書）** | テキスト入力 | 金額（カンマ区切り可） |

## データモデル

### 使用するDTO

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報
  - `customerBasedIncentiveForCustomer`: 継続単価（顧客）
  - `customerBasedIncentiveForSecretary`: 継続単価（秘書）

### リクエスト属性

#### 編集画面

- **row** (AssignmentDTO): 編集対象のアサイン情報（名称付き）
- **targetYM** (String): 対象月（yyyy-MM）

#### エラー時

- **errorMsg** (List<String>): エラーメッセージ
  - 「不正なアサインIDです。」（UUID形式エラー）
  - 「対象のアサインが見つかりません。」（アサイン未存在エラー）
  - 「継続単価（顧客）は0以上の数値で入力してください。」（金額エラー）
  - 「継続単価（秘書）は0以上の数値で入力してください。」（金額エラー）

### URLパラメータ

- **id** (String): 編集対象のアサインID（UUID形式）
- **targetYM** (String): 対象月（yyyy-MM形式、戻り先URL用）
- **customerBasedIncentiveForCustomer** (String): 継続単価（顧客）
- **customerBasedIncentiveForSecretary** (String): 継続単価（秘書）

## エラーハンドリング

### バリデーションエラー

- **UUID形式エラー**: 不正なアサインID
  - エラーメッセージ「不正なアサインIDです。」
  - アサイン一覧へリダイレクト

- **金額エラー**: 数値以外の入力
  - エラーメッセージ「継続単価（顧客）は0以上の数値で入力してください。」
  - エラーメッセージ「継続単価（秘書）は0以上の数値で入力してください。」
  - 編集フォームへ戻す

### ビジネスロジックエラー

- **アサイン未存在エラー**: 対象のアサインが見つからない
  - エラーメッセージ「対象のアサインが見つかりません。」
  - アサイン一覧へリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

### 一括更新の仕様

- **対象月の全レコード更新**: 顧客×秘書×対象月の組み合わせで全レコードを一括更新
  - 複数のタスクランク（A, B, C等）がある場合、全てのランクのアサインを更新
  - ただし、rank_no = 0（PM秘書）は除外
- **翌月の自動更新**: 翌月に同じ顧客×秘書の組み合わせが存在する場合、翌月分も自動更新
  - 更新件数が0の場合（翌月にアサインが存在しない）はスルー

### PM秘書の除外

- rank_no = 0（PM秘書）は継続単価の更新対象外
- SQL内で `WHERE ... AND tr.rank_no <> 0` で除外

### 金額のパース

- カンマ区切り（1,000円など）を許容
- `parseMoneyOrZero()` でカンマを除去してBigDecimalに変換
- 空白や省略時は0円として扱う

### リダイレクト先

- 更新後はアサイン一覧へリダイレクト
- 対象月（targetYM）をURLパラメータで引き継ぎ
- エラー時も同様にアサイン一覧へリダイレクト（エラーメッセージ表示）

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): 更新後の一覧表示
- **秘書アサイン登録** (26_秘書アサイン登録.md): アサイン新規登録時の継続単価設定
