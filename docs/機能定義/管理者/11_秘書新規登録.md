# 11_秘書新規登録（A04_06）

## 機能概要

新しい秘書を登録する機能です。入力→確認→確定の3画面構成で、基本情報、連絡先、口座情報、PM対応可否、秘書ランクなどを登録します。メールアドレスと秘書コードの重複チェックを実施します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/secretary/register` | 登録フォーム表示 | 新規登録の入力フォームを表示、秘書ランク一覧をロード |
| POST | `/admin/secretary/register_check` | 登録確認 | 入力内容をバリデーション後、確認画面を表示 |
| POST | `/admin/secretary/register_done` | 登録確定 | データベースに登録し、完了画面を表示 |

## 画面フロー

```
[秘書一覧画面]
    ↓ 新規登録ボタンをクリック
    ↓ GET /admin/secretary/register
    ↓ 秘書ランク一覧をセッションにロード
    ↓
[登録入力画面] - 基本情報、連絡先、口座情報等を入力
    ↓ 確認ボタンをクリック
    ↓ POST /admin/secretary/register_check
    |
    ├─ バリデーションエラー → [登録入力画面] へ戻る（エラーメッセージ・入力値保持）
    └─ バリデーションOK → [登録確認画面] へ遷移
        ↓ 確定ボタンをクリック
        ↓ POST /admin/secretary/register_done
        |
        ├─ メール重複エラー → [登録入力画面] へ戻る
        ├─ 秘書コード重複エラー → [登録入力画面] へ戻る
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 登録成功 → [登録完了画面] を表示
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SecretaryService.java](../../../src/main/java/service/SecretaryService.java)
- **メソッド**:
  - `secretaryRegister()` (149行目): 登録フォーム表示
  - `secretaryRegisterCheck()` (176行目): 登録確認
  - `secretaryRegisterDone()` (203行目): 登録確定

### 処理フロー

#### 1. 登録フォーム表示（GET `/admin/secretary/register`）

1. **秘書ランク一覧取得**
   - `SecretaryDAO.selectRankAll()` で秘書ランク一覧を取得
   - DTO → Domainオブジェクトに変換

2. **セッションに格納**
   - 秘書ランク一覧を `ranks` 属性としてセッションに格納
   - セレクトボックスで使用

3. **フォーム表示**
   - 空のフォームを表示
   - 登録ビュー（`secretary/admin/register`）へフォワード

#### 2. 登録確認（POST `/admin/secretary/register_check`）

1. **入力パラメータ取得**
   - **基本情報**:
     - `name`: 氏名（必須）
     - `nameRuby`: ふりがな（任意）
     - `mail`: メールアドレス（必須）
     - `password`: パスワード（必須）
     - `secretaryCode`: 秘書コード（任意、空の場合は自動生成）
   - **連絡先**:
     - `phone`: 電話番号（任意）
     - `postalCode`: 郵便番号（任意、形式チェックあり）
     - `address1`: 住所1（都道府県・市区町村）（任意）
     - `address2`: 住所2（番地）（任意）
     - `building`: 建物名・部屋番号（任意）
   - **秘書情報**:
     - `pmSecretary`: PM秘書フラグ（true/false）
     - `secretaryRankId`: 秘書ランクID（必須）
   - **口座情報**（すべて任意）:
     - `bankName`: 銀行名
     - `bankBranch`: 支店名
     - `bankType`: 口座種別
     - `bankAccount`: 口座番号
     - `bankOwner`: 口座名義

2. **バリデーション**
   - 必須チェック:
     - `validation.isNull("名前", name)`
     - `validation.isNull("メールアドレス", mail)`
     - `validation.isNull("パスワード", password)`
     - 秘書ランク選択チェック（カスタムメッセージ）
   - 形式チェック（入力がある場合のみ）:
     - `validation.isPostalCode(postalCode)` - 郵便番号形式
     - `validation.isPhoneNumber(phone)` - 電話番号形式
     - `validation.isEmail(mail)` - メールアドレス形式
   - **注意**: パスワード強度チェック、メール重複チェックは確認画面では実施しない（確定処理で実施）

3. **エラー時の処理**
   - `errorMsg` 属性にエラーメッセージを設定
   - 入力値を属性に戻す（フォーム再表示用）
   - 登録入力画面へ戻る

4. **成功時の処理**
   - 入力値を属性に設定
   - 確認画面（`secretary/admin/register_check`）へフォワード

#### 3. 登録確定（POST `/admin/secretary/register_done`）

1. **入力パラメータ取得・バリデーション（再実行）**
   - 確認画面と同じバリデーションを再度実行
   - ブラウザバック対策、直接URL入力対策
   - **追加**: パスワード強度チェック `validation.isStrongPassword(password)`

2. **DTOオブジェクト作成**
   - `SecretaryDTO` に全ての入力値を設定
   - パスワードをBCryptでハッシュ化: `PasswordUtil.hashPassword(password)`
   - PM秘書フラグを boolean に変換
   - 秘書ランクIDを UUID に変換

3. **メール重複チェック**
   - `SecretaryDAO.mailCheck(mail)` でメール重複確認
   - 重複時: "登録いただいたメールアドレスはすでに使われています。" エラー

4. **秘書コード重複チェック**
   - 秘書コードが入力されている場合のみチェック
   - `SecretaryDAO.secretaryCodeCheck(secretaryCode)` で重複確認
   - 重複時: "登録いただいた秘書コードはすでに使われています。" エラー

5. **エラー時の処理**
   - エラー時: 入力値を保持して登録入力画面へ戻る

6. **データベース登録**
   - `SecretaryDAO.insert(dto)` で登録実行
   - IDは自動生成（`gen_random_uuid()`）
   - トランザクションコミット

7. **完了画面表示**
   - `message` 属性に "登録が完了しました（件数:1）" を設定
   - 完了画面（`secretary/admin/register_done`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    SecretaryDAO dao = new SecretaryDAO(tm.getConnection());
    // メール重複チェック
    // 秘書コード重複チェック
    // 登録処理
    tm.commit();
    req.setAttribute("message", "登録が完了しました（件数:" + num + "）");
    return VIEW_REGISTER_DONE;
} catch (RuntimeException e) {
    req.setAttribute("errorMsg", "データベースに不正な操作が行われました");
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **SecretaryDAO**
  - `selectRankAll()`: 秘書ランク一覧を取得
  - `mailCheck(String mail)`: メールアドレス重複チェック
    - SQL: `SELECT COUNT(*) FROM secretaries WHERE mail = ? AND deleted_at IS NULL`
  - `secretaryCodeCheck(String code)`: 秘書コード重複チェック
    - SQL: `SELECT COUNT(*) FROM secretaries WHERE secretary_code = ? AND deleted_at IS NULL`
  - `insert(SecretaryDTO dto)`: 秘書情報を登録
    - SQL:
      ```sql
      INSERT INTO secretaries (
          id, secretary_code, name, name_ruby, mail, password,
          phone, postal_code, address1, address2, building,
          pm_secretary, secretary_rank_id,
          created_at, updated_at
      ) VALUES (
          gen_random_uuid(), ?, ?, ?, ?, ?,
          ?, ?, ?, ?, ?,
          ?, ?,
          CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
      )
      ```

### セキュリティ

- **パスワード強度チェック**: 8文字以上、英大小数字を含む必要がある（確定処理で実施）
- **パスワードハッシュ化**: BCrypt（コストファクタ10）で保存
- **メール重複チェック**: 同じメールアドレスは登録不可
- **秘書コード重複チェック**: 同じ秘書コードは登録不可（任意項目）
- **二重バリデーション**: 確認画面と確定処理で2回検証（改ざん対策）

## ビューファイル

- **登録入力画面**: [/WEB-INF/jsp/secretary/admin/register.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/register.jsp)
- **登録確認画面**: [/WEB-INF/jsp/secretary/admin/register_check.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/register_check.jsp)
- **登録完了画面**: [/WEB-INF/jsp/secretary/admin/register_done.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/register_done.jsp)

### 画面表示項目（登録入力画面）

#### 基本情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **秘書コード** | - | 秘書を識別するコード（任意、未入力時は自動生成） |
| **氏名** | ○ | 秘書の氏名 |
| **ふりがな** | - | 氏名のふりがな |
| **メールアドレス** | ○ | ログインIDとして使用、重複不可 |
| **パスワード** | ○ | 8文字以上、英大小数字含む |

#### 連絡先

| 項目 | 必須 | 説明 |
|-----|------|------|
| **電話番号** | - | 連絡先電話番号 |
| **郵便番号** | - | 郵便番号（形式チェックあり） |
| **住所1** | - | 都道府県・市区町村 |
| **住所2** | - | 番地 |
| **建物名・部屋番号** | - | 建物名・部屋番号 |

#### 秘書情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **PM対応** | - | PM秘書かどうか（チェックボックス） |
| **秘書ランク** | ○ | 秘書ランク（A/B/C/D/E から選択） |

#### 口座情報（すべて任意）

| 項目 | 必須 | 説明 |
|-----|------|------|
| **銀行名** | - | 振込先銀行名 |
| **支店名** | - | 振込先支店名 |
| **口座種別** | - | 普通/当座 など |
| **口座番号** | - | 振込先口座番号 |
| **口座名義** | - | 振込先口座名義 |

### 画面アクション

- **確認ボタン**: POST `/admin/secretary/register_check` でバリデーション実行
- **戻るボタン**: 一覧画面へ戻る

## データモデル

### 使用するDTO

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - `id` (UUID): 自動生成（`gen_random_uuid()`）
  - `secretaryCode` (String): 秘書コード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `mail` (String): メールアドレス
  - `password` (String): BCryptハッシュ化パスワード
  - `phone` (String): 電話番号
  - `postalCode` (String): 郵便番号
  - `address1` (String): 住所1
  - `address2` (String): 住所2
  - `building` (String): 建物名・部屋番号
  - `pmSecretary` (Boolean): PM秘書フラグ
  - `secretaryRankId` (UUID): 秘書ランクID
  - `createdAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）
  - `updatedAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）

- **SecretaryRankDTO** ([dto/SecretaryRankDTO.java](../../../src/main/java/dto/SecretaryRankDTO.java))
  - `id` (UUID): ランクID
  - `rankName` (String): ランク名（A/B/C/D/E）
  - `description` (String): 説明
  - `increaseBasePayCustomer` (Integer): 顧客向け基本単価増額
  - `increaseBasePaySecretary` (Integer): 秘書向け基本単価増額

### セッション属性

- **ranks** (List<SecretaryRank>): 秘書ランク一覧（セレクトボックス用）

### リクエスト属性

- **errorMsg** (String): バリデーションエラーメッセージ
- **message** (String): 登録完了メッセージ
- **入力値の属性**（エラー時の再表示用）

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: "名前 を入力してください" など
- **メール形式エラー**: "メールアドレス の形式が正しくありません"
- **郵便番号形式エラー**: "郵便番号 の形式が正しくありません"
- **電話番号形式エラー**: "電話番号 の形式が正しくありません"
- **パスワード強度エラー**: "パスワードは8文字以上で、英大文字・小文字・数字を含む必要があります"
- **秘書ランク未選択エラー**: "秘書ランクを選択してください。"

### ビジネスロジックエラー

- **メール重複エラー**: "登録いただいたメールアドレスはすでに使われています。"
- **秘書コード重複エラー**: "登録いただいた秘書コードはすでに使われています。"
- エラー時: 登録入力画面へ戻り、入力値を保持

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

### 機能一覧の備考欄より

- **備考欄**: 実装済み（任意）
- **口座情報**: 実装済み（すべて任意項目）
- **緊急連絡先**: 未実装（将来的な拡張項目）

### その他

- IDはデータベース側で自動生成（UUID）
- 作成日時・更新日時も自動設定
- 削除日時（`deleted_at`）は初期値NULL（有効状態）
- 最終ログイン日時（`last_login_at`）は初期値NULL
- 登録完了後、一覧画面へ戻るリンクが表示される
- パスワードは平文で保存されず、必ずBCryptハッシュで保存される
- 秘書コードが未入力の場合、自動生成される（DAO側で処理）
- 口座情報は登録時に入力できるが、すべて任意項目
- PM秘書フラグは登録時に設定可能（デフォルト: false）
- 秘書ランクは必須項目で、A/B/C/D/Eから選択
