# 19_顧客削除（A04_14）

## 機能概要

既存の顧客を論理削除する機能です。物理削除ではなく `deleted_at` タイムスタンプを設定することで、データベースからレコードを削除せずに無効化します。削除された顧客は一覧に表示されなくなります。同時に、顧客に紐づく担当者（customer_contacts）も論理削除されます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/customer/delete?id={顧客ID}` | 削除処理 | 指定IDの顧客を論理削除し、一覧画面へリダイレクト |

## 画面フロー

```
[顧客一覧画面] または [顧客詳細画面]
    ↓ 削除ボタンをクリック（JavaScript確認ダイアログ）
    ↓ confirm('削除しますか？この操作は取り消せません。')
    |
    ├─ キャンセル → 元の画面に留まる
    └─ OK → GET /admin/customer/delete?id={UUID}
        ↓
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 削除成功 → [顧客一覧画面] へリダイレクト
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CustomerService.java](../../../src/main/java/service/CustomerService.java)
- **メソッド**: `customerDelete()` (508行目): 顧客論理削除

### 処理フロー

#### 1. 削除処理（GET `/admin/customer/delete?id={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 削除対象の顧客ID（UUID形式）
   - UUID形式を暗黙的に検証（`UUID.fromString()`）
   - 不正な形式の場合: RuntimeExceptionをキャッチ

2. **論理削除実行**
   - `CustomerDAO.delete(id)` で論理削除実行
   - 内部で以下の処理を順次実行:
     - `CustomerContactDAO.deleteByCustomerId(id)` で紐づく担当者を一括論理削除
     - `customers` テーブルの `deleted_at` カラムに `CURRENT_TIMESTAMP` を設定
   - トランザクションコミット

3. **一覧画面へリダイレクト**
   - 削除成功後、顧客一覧画面（`/admin/customer`）へリダイレクト
   - 削除されたレコードは一覧に表示されなくなる

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID id = UUID.fromString(idStr);
    CustomerDAO dao = new CustomerDAO(tm.getConnection());
    dao.delete(id);
    tm.commit();
    return req.getContextPath() + "/admin/customer";
} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- try-with-resourcesで自動クローズ
- 明示的にコミット（`tm.commit()`）を呼ぶ必要がある
- エラー時は自動ロールバック

### DAO呼び出し

- **CustomerDAO**
  - `delete(UUID id)`: 顧客を論理削除（担当者も自動削除）
    - 処理内容:
      1. `CustomerContactDAO.deleteByCustomerId(id)` で担当者を一括論理削除
         - SQL: `UPDATE customer_contacts SET deleted_at = CURRENT_TIMESTAMP WHERE customer_id = ? AND deleted_at IS NULL`
      2. 顧客を論理削除
         - SQL: `UPDATE customers SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?`
    - 戻り値: なし（void）
    - 例外: `DAOException` - "E:C16 Customers 論理DELETE 中にエラーが発生しました。"

- **CustomerContactDAO**
  - `deleteByCustomerId(UUID customerId)`: 顧客IDに紐づく担当者を一括論理削除
    - SQL: `UPDATE customer_contacts SET deleted_at = CURRENT_TIMESTAMP WHERE customer_id = ? AND deleted_at IS NULL`
    - 戻り値: 影響行数（削除された担当者数）
    - 例外: `DAOException` - "E:CC33 顧客IDによる担当者一括論理DELETE に失敗しました。"

### セキュリティ

- **論理削除**: 物理削除ではなく論理削除を使用
  - データはデータベースに残り、監査証跡として保持される
  - `deleted_at IS NULL` 条件により、削除されたレコードは自動的に除外される
- **カスケード削除**: 顧客削除時、紐づく担当者も自動的に論理削除される
  - データの整合性を保持
- **UUID検証**: 不正なID形式はRuntimeExceptionとして処理
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

削除処理は直接リダイレクトするため、専用のビューファイルはありません。

### 削除ボタンの実装

削除ボタンは一覧画面および詳細画面に配置されており、JavaScriptの確認ダイアログを使用します:

```html
<a class="btn btn-sm btn-outline-danger"
   href="${pageContext.request.contextPath}/admin/customer/delete?id=${customer.id}"
   onclick="return confirm('削除しますか？この操作は取り消せません。');">
   削除
</a>
```

## データモデル

### 使用するDTO

削除処理ではDTOの読み込みは行いません（IDのみ使用）。

### テーブル構造

- **customers** テーブル
  - `id` (UUID): 顧客ID
  - `deleted_at` (Timestamp): 削除日時（NULL = 有効）

- **customer_contacts** テーブル
  - `id` (UUID): 担当者ID
  - `customer_id` (UUID): 顧客ID（FK）
  - `deleted_at` (Timestamp): 削除日時（NULL = 有効）

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
  - UUID形式エラー、DAO実行エラーを含む
- トランザクションは自動ロールバック

## 備考

### 論理削除の仕組み

- **物理削除ではなく論理削除**: レコードは削除されず、`deleted_at` タイムスタンプが設定される
- **自動除外**: 全てのSELECTクエリで `deleted_at IS NULL` 条件を使用するため、削除されたレコードは自動的に除外される
- **データ保持**: 削除されたデータは監査証跡として保持される
- **復元可能**: 必要に応じて `deleted_at` をNULLに戻すことで復元可能（管理者操作が必要）

### 削除の影響範囲

- **顧客一覧画面**: 削除された顧客は表示されなくなる
- **顧客担当者**: 顧客削除時、紐づく担当者も自動的に論理削除される
  - 削除された担当者はログインできなくなる
  - 削除された担当者は担当者一覧に表示されなくなる
- **ログイン**: 削除された担当者はログインできなくなる（`deleted_at IS NULL` 条件）
- **アサイン**: 既存のアサインは削除されない（過去データは保持）
  - アサイン情報には顧客IDが記録されているが、論理削除された顧客とのJOINでは表示されなくなる
- **タスク**: 既存のタスクは削除されない（過去データは保持）
  - タスク情報にはアサインIDが記録されているが、削除された顧客のタスクは新規登録できなくなる

### 削除時の注意事項

- **確認ダイアログ**: JavaScriptで削除確認ダイアログを表示
  - "削除しますか？この操作は取り消せません。"
  - ユーザーがキャンセルした場合、削除処理は実行されない
- **リダイレクト**: 削除成功後、顧客一覧画面へリダイレクト
  - 削除されたレコードは一覧に表示されなくなる
- **エラー時**: エラー画面へリダイレクト
  - エラーメッセージが表示される
- **カスケード削除**: 顧客削除時、紐づく担当者も自動的に論理削除される
  - 担当者の削除件数は返されないが、トランザクション内で処理される

### その他

- 削除完了メッセージは表示されない（一覧画面へ直接リダイレクト）
- 削除日時（`deleted_at`）は自動設定（`CURRENT_TIMESTAMP`）
- 削除後、IDは再利用されない（UUIDのため）
- 削除された顧客の担当者も同時に論理削除される（データ整合性の維持）
