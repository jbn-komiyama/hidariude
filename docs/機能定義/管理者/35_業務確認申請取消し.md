# 35_業務確認申請取消し（A05_25）

## 機能概要

顧客からの確認申請（アラート）を取り消す機能です。アラート取消により、`alerted_at` が NULL になり、アラート一覧から削除されます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| POST | `/admin/task/alert_delete?id={タスクID}` | アラート取消 | 指定されたタスクのアラートを取り消す |

## 画面フロー

```
[アラート一覧画面]
    ↓ 取消ボタンクリック
    ↓ POST /admin/task/alert_delete?id={タスクID}
    ↓
[アラート取消処理実行]
    - alerted_at を NULL に設定
    - updated_at に現在時刻を設定
    ↓
    ├─ タスクIDが不正
    |   └─ エラーページへリダイレクト
    |
    ├─ 対象タスクが見つからない
    |   └─ エラーページへリダイレクト
    |
    └─ 正常処理
        ↓ トランザクションコミット
        ↓ GET /admin/task/alert
        ↓
        [アラート一覧画面]（取消後、対象タスクは非表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**: `adminAlertDelete()` (847行目): アラート取消

### 処理フロー

#### 1. アラート取消（POST `/admin/task/alert_delete`）

1. **パラメータ取得・検証**
   - `id`: タスクID（UUID形式、必須）
   - バリデーション: `isUuid()` で形式チェック
   - エラー時: エラーページへリダイレクト
   - エラーメッセージ: "対象IDが不正です。"

2. **アラート取消処理**
   - `TaskDAO.alertDelete(taskId)` でアラートを取り消す
   - SQL: `UPDATE tasks SET alerted_at = NULL, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
   - 処理内容:
     - `alerted_at`: NULL に設定
     - `updated_at`: 現在時刻を設定
   - 影響行数が0の場合: エラーページへリダイレクト
   - エラーメッセージ: "対象のタスクが見つかりません。"

3. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

4. **リダイレクト**
   - アラート一覧へリダイレクト
   - リダイレクト先: `/admin/task/alert`

### トランザクション管理

```java
public String adminAlertDelete() {
    final String idStr = req.getParameter(P_ID);  // "id"
    if (!validation.isUuid(idStr)) {
        req.setAttribute(A_ERROR_MSG, "対象IDが不正です。");
        return req.getContextPath() + req.getServletPath() + "/error";
    }
    final UUID taskId = UUID.fromString(idStr);

    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        int updated = dao.alertDelete(taskId);
        if (updated == 0) {
            req.setAttribute(A_ERROR_MSG, "対象のタスクが見つかりません。");
            return req.getContextPath() + req.getServletPath() + "/error";
        }
        tm.commit();  // 明示的コミット
        return req.getContextPath() + "/admin/task/alert";
    } catch (RuntimeException e) {
        e.printStackTrace();
        req.setAttribute(A_ERROR_MSG, "アラート取消に失敗しました。");
        return req.getContextPath() + req.getServletPath() + "/error";
    }
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- 影響行数が0の場合はエラーとして扱う

### DAO呼び出し

- **TaskDAO**
  - `alertDelete(UUID id)`: アラート取消
    - SQL: `SQL_ALERT_DELETE`（285行目）
    - 処理:
      - `alerted_at = NULL`: アラート日時をクリア
      - `updated_at = CURRENT_TIMESTAMP`: 更新日時を設定
    - 条件: `id = ?`
    - 影響行数を返す（1: 成功, 0: 対象不在）

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **UUID形式検証**: 不正なIDを拒否
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **アラート一覧画面**: [/WEB-INF/jsp/task/admin/alert.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/alert.jsp)

### 画面表示項目

#### アラート取消ボタン

| 項目 | 説明 |
|-----|------|
| **取消ボタン** | 各アラート行に表示 |

### 画面アクション

- **取消ボタン**: アラートを取り消す（`/admin/task/alert_delete?id={タスクID}`）
  - POST メソッドでリクエスト
  - 確認ダイアログなし（即座に実行）
  - 実行後はアラート一覧へリダイレクト

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `alerted_at`: アラート日時（取消時に NULL）

### URLパラメータ

- **id** (String): タスクID（UUID形式）

## エラーハンドリング

### バリデーションエラー

- **UUID形式エラー**: UUID形式以外のIDが指定された場合
  - エラーページへリダイレクト
  - エラーメッセージ: "対象IDが不正です。"

- **対象タスク不在**: 影響行数が0の場合
  - エラーページへリダイレクト
  - エラーメッセージ: "対象のタスクが見つかりません。"

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- **アラート取消失敗**: エラーメッセージ "アラート取消に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- アラート取消後、アラート一覧から削除される
- 顧客側の業務一覧では、アラート状態が解除される

## 備考

### アラート取消の仕様

- **アラート日時のクリア**: `alerted_at` を NULL に設定
- **更新日時**: `updated_at` に現在時刻を設定
- **アラートコメントの保持**: `alerted_comment` は変更されない（履歴として保持）

### アラート再申請

- アラート取消後、顧客は再度確認申請可能
- アラート履歴は残らない（最新のアラート情報のみ保持）

### 業務状態への影響

- アラート取消処理では、承認状態や差戻し状態は変更されない
- 未承認タスクのアラートを取り消しても、未承認のまま
- 承認済みタスクのアラートを取り消しても、承認済みのまま

### 31_顧客タスクアラート一覧表示.md との関係

- 本機能は 31_顧客タスクアラート一覧表示.md で説明されているアラート取消機能と同一
- 31_顧客タスクアラート一覧表示.md では画面全体の説明を含む
- 本文書では取消処理に特化した詳細説明

### ナビゲーションバーのアラート件数への影響

- アラート取消により、ナビゲーションバーのアラート件数（バッジ）が減る
- `AlertCountFilter` により、管理者ログイン時に自動的にアラート件数を再計算

### リダイレクト先

- アラート取消後はアラート一覧へリダイレクト
- 取消されたタスクはアラート一覧から消える（`alerted_at IS NULL` の条件）

### 使用場面

- 顧客からの確認申請を確認済み
- アラートの誤申請の取消
- 月次の業務確認作業

### 顧客への通知

- アラート取消時に顧客への通知機能は実装されていない
- 顧客は業務一覧画面でアラート状態が解除されたことを確認可能

### 関連機能

- **顧客タスクアラート一覧表示** (31_顧客タスクアラート一覧表示.md): アラート一覧の表示とアラート取消
- **業務一覧表示** (30_業務一覧表示.md): タスク詳細の確認
- **業務承認** (32_業務承認.md): アラート確認後の承認
- **業務差戻し** (33_業務差戻し.md): アラート確認後の差戻し
