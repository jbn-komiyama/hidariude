# 24_アサイン一覧表示（A05_01）

## 機能概要

指定月のアサイン状況を一覧表示する機能です。顧客ごとに秘書とのアサインを表示し、継続月数も確認できます。ソート機能（継続月数降順）とフィルタリング機能（顧客名検索、秘書フィルタ、継続月数フィルタ）を提供します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/assignment?targetYM={年月}` | アサイン一覧表示 | 指定月のアサイン一覧を表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ アサイン一覧リンククリック
    ↓ GET /admin/assignment?targetYM={yyyy-MM}
    ↓ クエリパラメータで制御：
    |   - targetYM: 対象月（省略時は当月、最大で翌月まで）
    |   - qCustomer: 顧客名検索（部分一致）
    |   - secretaryId: 秘書フィルタ（UUID）
    |   - minMonths: 継続月数フィルタ（N ヶ月以上）
    |   - sort: ソート（months_desc = 継続月数降順）
    ↓
[アサイン一覧画面]
    - 顧客ごとに秘書とのアサインを表示
    - 継続月数を表示
    - フィルタリング・ソート機能
    ↓
    ├─ 新規登録ボタン → [秘書アサイン登録画面] または [PM秘書アサイン登録画面] へ遷移
    ├─ 継続単価変更ボタン → [継続単価変更画面] へ遷移
    ├─ 削除ボタン → 削除処理実行
    └─ 先月アサイン引き継ぎボタン → [先月アサイン引き継ぎプレビュー画面] へ遷移
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**: `assignmentList()` (147行目): アサイン一覧表示

### 処理フロー

#### 1. アサイン一覧画面表示（GET `/admin/assignment?targetYM={yyyy-MM}`）

1. **パラメータ取得・検証**
   - `targetYM`: 対象月（yyyy-MM形式）
     - 省略時は当月
     - 最大で翌月まで（翌月を超える場合は翌月に補正）
   - `qCustomer`: 顧客名検索（部分一致）
   - `secretaryId`: 秘書フィルタ（UUID）
   - `minMonths`: 継続月数フィルタ（N ヶ月以上）
   - `sort`: ソート指定（`months_desc` = 継続月数降順）

2. **対象月の補正**
   - `LocalDate.now(ZoneId.of("Asia/Tokyo"))` で現在日付を取得
   - `ymNow`: 今月、`ymNext`: 翌月
   - `targetYM` が未指定または空白の場合: 今月をセット
   - `targetYM` が翌月を超える場合: 翌月に補正
   - パースエラー時: 今月をセット

3. **フィルタパラメータの解析**
   - `minMonths`: 文字列 → Integer変換（エラー時はnull）
   - `secretaryId`: UUID形式チェック（不正時はnull）
   - `qCustomer`: 顧客名検索文字列
   - `hasFilters`: フィルタが1つでも指定されているかを判定

4. **秘書一覧取得（セレクトボックス用）**
   - `loadSecretariesToRequest(tm, false)` で秘書一覧を取得
   - リクエスト属性 `secretaries` にセット

5. **データ取得（2パターン）**
   - **パターン1**: ソートが「継続月数降順」かつフィルタなしの場合
     - `AssignmentDAO.selectAllByMonthOrderByConsecutiveDesc(targetYM)` を使用
     - 継続月数降順の専用SQL
   - **パターン2**: それ以外（フィルタありまたは通常ソート）
     - `AssignmentDAO.selectAllByMonthFiltered(targetYM, qCustomer, filterSecId, minMonths)` を使用
     - フィルタ条件を適用したSQL

6. **データ整形（顧客→秘書グルーピング）**
   - CustomerDTOのリストを処理
   - 各顧客に紐づくアサインを秘書単位でグルーピング
   - 継続月数マップ（`contMonths`）を作成
     - キー: アサインID（UUID）
     - 値: 継続月数（Integer）
   - DTO → Domainオブジェクトに変換
   - `AssignmentGroup` で秘書ごとのアサインをまとめる

7. **画面用属性設定**
   - `canCarryOver`: 引き継ぎ可能フラグ（当月または翌月の場合true）
   - `prevYM`: 前月の年月（yyyy-MM）
   - `maxYM`: 最大月（翌月）
   - `contMonths`: 継続月数マップ
   - `customers`: 顧客リスト
   - `targetYM`: 対象月
   - フォーム入力値を再設定（`f_minMonths`, `f_secretaryId`, `f_qCustomer`, `f_sort`）

8. **ビューへフォワード**
   - 一覧ビュー（`assignment/admin/home`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    /** セレクトボックス：秘書 */
    loadSecretariesToRequest(tm, false);

    AssignmentDAO aDao = new AssignmentDAO(tm.getConnection());

    /** データ取得 */
    List<CustomerDTO> cRows;
    if (sortByMonthsDesc && !hasFilters) {
        cRows = aDao.selectAllByMonthOrderByConsecutiveDesc(targetYM);
    } else {
        cRows = aDao.selectAllByMonthFiltered(targetYM, qCustomer, filterSecId, minMonths);
    }

    /** DTO→Domain 整形（秘書単位でグルーピング） */
    Map<UUID, Integer> contMonths = new HashMap<>();
    List<Customer> customers = new ArrayList<>();

    for (CustomerDTO cdto : cRows) {
        Customer c = new Customer();
        c.setId(cdto.getId());
        c.setCompanyName(cdto.getCompanyName());

        if (cdto.getAssignmentDTOs() != null && !cdto.getAssignmentDTOs().isEmpty()) {
            Map<UUID, AssignmentGroup> gmap = new LinkedHashMap<>();
            for (AssignmentDTO adto : cdto.getAssignmentDTOs()) {
                if (adto.getAssignmentId() != null) {
                    Integer cont = adto.getConsecutiveMonths();
                    contMonths.put(adto.getAssignmentId(), cont == null ? 0 : cont);
                }
                Assignment a = conv.toDomain(adto);
                UUID sid = (a.getSecretary() != null ? a.getSecretary().getId() : null);

                AssignmentGroup g = gmap.get(sid);
                if (g == null) {
                    g = new AssignmentGroup();
                    g.setSecretary(a.getSecretary());
                    gmap.put(sid, g);
                }
                g.getAssignments().add(a);
            }
            c.setAssignmentGroups(new ArrayList<>(gmap.values()));
        }
        customers.add(c);
    }

    /** 画面用属性 */
    String prevYM = LocalDate.parse(targetYM + "-01").minusMonths(1).format(YM_FMT);
    req.setAttribute("canCarryOver", ymNow.equals(targetYM) || ymNext.equals(targetYM));
    req.setAttribute("prevYM", prevYM);
    req.setAttribute("maxYM", ymNext);

    req.setAttribute("contMonths", contMonths);
    req.setAttribute(A_CUSTOMERS, customers);
    req.setAttribute(A_TARGET_YM, targetYM);

    return VIEW_HOME;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

### DAO呼び出し

- **AssignmentDAO**
  - `selectAllByMonthOrderByConsecutiveDesc(String targetYM)`: 継続月数降順でアサイン一覧を取得
    - 継続月数を計算するCTE（Common Table Expression）を使用
    - LEFT JOIN で顧客起点でアサインを取得（アサイン無しの顧客も表示）
  - `selectAllByMonthFiltered(String targetYM, String qCustomer, UUID filterSecId, Integer minMonths)`: フィルタ条件を適用してアサイン一覧を取得
    - 顧客名部分一致、秘書フィルタ、継続月数フィルタを適用

- **SecretaryDAO**
  - `selectAll()`: 全秘書を取得（セレクトボックス用）

### セキュリティ

- **論理削除フィルタ**: 削除済みアサインは表示されない
- **対象月の上限制御**: 翌月までのアサインのみ表示可能
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **一覧画面**: [/WEB-INF/jsp/assignment/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/home.jsp)

### 画面表示項目

#### アサイン一覧

リクエスト属性 `customers` (List<Customer>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **顧客企業名** | 顧客企業名 |
| **秘書名** | アサインされた秘書の氏名 |
| **業務ランク** | 業務ランク（A/B/C/D/E） |
| **基本単価（顧客）** | 顧客向け基本単価 |
| **基本単価（秘書）** | 秘書向け基本単価 |
| **単価増額（顧客）** | 顧客向け単価増額（ランク増額分） |
| **単価増額（秘書）** | 秘書向け単価増額（ランク増額分） |
| **インセンティブ（顧客）** | 顧客向けインセンティブ |
| **インセンティブ（秘書）** | 秘書向けインセンティブ |
| **継続月数** | 同一組み合わせ（顧客×秘書×ランク）の連続月数 |
| **アクション** | 継続単価変更・削除ボタン |

#### フィルタリング・ソート機能

| 機能 | 説明 |
|-----|------|
| **対象月選択** | 今月または翌月を選択可能 |
| **顧客名検索** | 顧客名で部分一致検索 |
| **秘書フィルタ** | 特定の秘書でフィルタ |
| **継続月数フィルタ** | N ヶ月以上の継続案件のみ表示 |
| **継続月数降順ソート** | 継続月数の多い順に表示 |

### 画面アクション

- **秘書アサイン登録ボタン**: 秘書アサイン登録画面（`/admin/assignment/register?id={顧客ID}&companyName={顧客名}&targetYM={年月}`）へ遷移
- **PM秘書アサイン登録ボタン**: PM秘書アサイン登録画面（`/admin/assignment/pm_register?targetYM={年月}`）へ遷移
- **継続単価変更ボタン**: 継続単価変更画面（`/admin/assignment/edit_incentive?id={アサインID}`）へ遷移
- **削除ボタン**: 削除確認後、削除処理実行（`/admin/assignment/delete?id={アサインID}`）
- **先月アサイン引き継ぎボタン**: 先月アサイン引き継ぎプレビュー画面（`/admin/assignment/carry_over_preview?targetYM={年月}`）へ遷移

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - 顧客情報
  - `assignmentDTOs` フィールドでアサイン情報のリストを保持

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報
  - `consecutiveMonths` フィールドで継続月数を保持

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報
  - `assignmentGroups` フィールドで秘書単位のグルーピングを保持

- **AssignmentGroup** ([domain/AssignmentGroup.java](../../../src/main/java/domain/AssignmentGroup.java))
  - 秘書単位でアサインをグルーピング
  - `secretary` フィールドで秘書情報を保持
  - `assignments` フィールドでアサインリストを保持

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（ネストした構造）

### リクエスト属性

- **customers** (List<Customer>): 顧客リスト（秘書グルーピング済み）
- **contMonths** (Map<UUID, Integer>): 継続月数マップ（アサインID → 継続月数）
- **targetYM** (String): 対象月（yyyy-MM）
- **canCarryOver** (Boolean): 引き継ぎ可能フラグ
- **prevYM** (String): 前月の年月（yyyy-MM）
- **maxYM** (String): 最大月（翌月）
- **secretaries** (List<Secretary>): 秘書一覧（セレクトボックス用）
- **f_minMonths** (String): 継続月数フィルタ値（フォーム再表示用）
- **f_secretaryId** (String): 秘書フィルタ値（フォーム再表示用）
- **f_qCustomer** (String): 顧客名検索値（フォーム再表示用）
- **f_sort** (String): ソート指定（フォーム再表示用）

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）

## 備考

### 機能一覧の備考欄より

- **ソート機能**: 継続月数降順（`sort=months_desc`）のみ実装
- **フィルタリング機能**: 顧客名検索、秘書フィルタ、継続月数フィルタ

### その他

- 対象月は今月または翌月のみ選択可能（過去月は表示不可）
- 継続月数はCTE（Common Table Expression）で計算
  - 顧客×秘書×ランクの組み合わせごとに連続月を"島"として認識
  - 末尾が対象月の島の長さが継続月数として表示される
- 顧客起点でLEFT JOINするため、アサイン無しの顧客も表示される
- 秘書単位でグルーピングして表示（`AssignmentGroup`）
- フィルタ条件とソート条件は排他的（継続月数降順ソートはフィルタなしの場合のみ有効）
- 先月アサイン引き継ぎボタンは、当月または翌月の場合のみ表示（`canCarryOver`）
