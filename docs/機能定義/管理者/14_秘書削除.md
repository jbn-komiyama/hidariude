# 14_秘書削除（A04_09）

## 機能概要

既存の秘書を論理削除する機能です。物理削除ではなく `deleted_at` タイムスタンプを設定することで、データベースからレコードを削除せずに無効化します。削除された秘書は一覧に表示されなくなります。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/secretary/delete?id={秘書ID}` | 削除処理 | 指定IDの秘書を論理削除し、一覧画面へリダイレクト |

## 画面フロー

```
[秘書一覧画面] または [秘書詳細画面]
    ↓ 削除ボタンをクリック（JavaScript確認ダイアログ）
    ↓ confirm('削除しますか？この操作は取り消せません。')
    |
    ├─ キャンセル → 元の画面に留まる
    └─ OK → GET /admin/secretary/delete?id={UUID}
        ↓
        ├─ ID形式エラー → [エラー画面] へリダイレクト
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 削除成功 → [秘書一覧画面] へリダイレクト
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SecretaryService.java](../../../src/main/java/service/SecretaryService.java)
- **メソッド**: `secretaryDelete()` (514行目): 秘書論理削除

### 処理フロー

#### 1. 削除処理（GET `/admin/secretary/delete?id={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 削除対象の秘書ID（UUID形式）
   - `validation.isUuid(idStr)` でUUID形式チェック
   - 不正な形式の場合: "不正なIDが指定されました。" エラー

2. **論理削除実行**
   - `SecretaryDAO.delete(id)` で論理削除実行
   - `deleted_at` カラムに `CURRENT_TIMESTAMP` を設定
   - トランザクションコミット

3. **一覧画面へリダイレクト**
   - 削除成功後、秘書一覧画面（`/admin/secretary`）へリダイレクト
   - 削除されたレコードは一覧に表示されなくなる

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID id = UUID.fromString(idStr);
    SecretaryDAO dao = new SecretaryDAO(tm.getConnection());
    dao.delete(id);
    tm.commit();
    return req.getContextPath() + "/admin/secretary";
} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- try-with-resourcesで自動クローズ
- 明示的にコミット（`tm.commit()`）を呼ぶ必要がある
- エラー時は自動ロールバック

### DAO呼び出し

- **SecretaryDAO**
  - `delete(UUID id)`: 秘書を論理削除
    - SQL: `UPDATE secretaries SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?`
    - 戻り値: なし（void）
    - 例外: `DAOException` - "E:S33 secretaries 論理DELETE に失敗しました。"

### セキュリティ

- **論理削除**: 物理削除ではなく論理削除を使用
  - データはデータベースに残り、監査証跡として保持される
  - `deleted_at IS NULL` 条件により、削除されたレコードは自動的に除外される
- **UUID検証**: 不正なID形式をエラーとして処理
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

削除処理は直接リダイレクトするため、専用のビューファイルはありません。

### 削除ボタンの実装

削除ボタンは一覧画面および詳細画面に配置されており、JavaScriptの確認ダイアログを使用します:

```html
<a class="btn btn-sm btn-outline-danger"
   href="${pageContext.request.contextPath}/admin/secretary/delete?id=${secretary.id}"
   onclick="return confirm('削除しますか？この操作は取り消せません。');">
   削除
</a>
```

## データモデル

### 使用するDTO

削除処理ではDTOの読み込みは行いません（IDのみ使用）。

### テーブル構造

- **secretaries** テーブル
  - `id` (UUID): 秘書ID
  - `deleted_at` (Timestamp): 削除日時（NULL = 有効）

## エラーハンドリング

### バリデーションエラー

- **ID形式エラー**: "不正なIDが指定されました。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

### 論理削除の仕組み

- **物理削除ではなく論理削除**: レコードは削除されず、`deleted_at` タイムスタンプが設定される
- **自動除外**: 全てのSELECTクエリで `deleted_at IS NULL` 条件を使用するため、削除されたレコードは自動的に除外される
- **データ保持**: 削除されたデータは監査証跡として保持される
- **復元可能**: 必要に応じて `deleted_at` をNULLに戻すことで復元可能（管理者操作が必要）

### 削除の影響範囲

- **秘書一覧画面**: 削除された秘書は表示されなくなる
- **ログイン**: 削除された秘書はログインできなくなる（`deleted_at IS NULL` 条件）
- **アサイン**: 既存のアサインは削除されない（過去データは保持）
  - アサイン情報には秘書IDが記録されているが、論理削除された秘書とのJOINでは表示されなくなる
- **タスク**: 既存のタスクは削除されない（過去データは保持）
  - タスク情報にはアサインIDが記録されているが、削除された秘書のタスクは新規登録できなくなる

### 削除時の注意事項

- **確認ダイアログ**: JavaScriptで削除確認ダイアログを表示
  - "削除しますか？この操作は取り消せません。"
  - ユーザーがキャンセルした場合、削除処理は実行されない
- **リダイレクト**: 削除成功後、秘書一覧画面へリダイレクト
  - 削除されたレコードは一覧に表示されなくなる
- **エラー時**: エラー画面へリダイレクト
  - エラーメッセージが表示される

### その他

- 削除完了メッセージは表示されない（一覧画面へ直接リダイレクト）
- 削除日時（`deleted_at`）は自動設定（`CURRENT_TIMESTAMP`）
- 削除後、IDは再利用されない（UUIDのため）
- 削除された秘書の口座情報も論理削除により非表示になる
- 削除された秘書のプロフィール情報も論理削除により非表示になる（profilesテーブルは独自の`deleted_at`を持つ）
