# 29_先月アサイン引き継ぎ(A05_91)

## 機能概要

先月のアサインを当月に一括コピーする機能です。2画面構成（プレビュー→実行）で、先月のアサインを確認してから当月に引き継ぎます。継続月数の表示により、各アサインの継続期間を確認できます。重複チェックにより、既に登録済みのアサインはスキップします。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/assignment/carry_over_preview?toYM={対象月}&fromYM={先月}` | 引き継ぎプレビュー | 引き継ぎ候補の一覧表示 |
| POST | `/admin/assignment/carry_over_apply?toYM={対象月}&assignmentId[]={アサインID}` | 引き継ぎ実行 | チェックされたアサインを当月にコピー |

## 画面フロー

```
[アサイン一覧画面]
    ↓ 先月アサイン引き継ぎボタンクリック
    ↓ GET /admin/assignment/carry_over_preview?toYM={当月}&fromYM={先月}
    ↓
[引き継ぎプレビュー画面] (carry_over_preview.jsp)
    - 引き継ぎ候補の一覧表示
      - 先月のアサインから、当月に未登録のもののみ表示
      - 継続月数を表示（先月を末尾とする連続月数）
    - チェックボックスで引き継ぎ対象を選択
    ↓ 引き継ぎ実行ボタン
    ↓ POST /admin/assignment/carry_over_apply?toYM={当月}&assignmentId[]={選択されたアサインID}
    ↓
    ├─ 選択なし → プレビュー画面へ戻る
    |
    └─ 選択あり
        ↓ 選択されたアサインを当月にコピー
        ↓ 重複チェック（既に存在するアサインはスキップ）
        ↓ 一括INSERT実行
        ↓ GET /admin/assignment?targetYM={当月}
        ↓
        [アサイン一覧画面]（引き継ぎ後の一覧表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**:
  - `assignmentCarryOverPreview()` (735行目): 引き継ぎプレビュー表示
  - `assignmentCarryOverApply()` (772行目): 引き継ぎ実行

### 処理フロー

#### 1. 引き継ぎプレビュー表示（GET `/admin/assignment/carry_over_preview`）

1. **パラメータ取得・検証**
   - `toYM`: 対象月（yyyy-MM形式、必須）
   - `fromYM`: 先月（yyyy-MM形式、必須）
   - バリデーション: `isYearMonth()` で形式チェック
   - エラー時: アサイン一覧へリダイレクト（対象月を指定）

2. **引き継ぎ候補の取得**
   - `AssignmentDAO.selectCarryOverCandidates(fromYM, toYM)` で候補を取得
   - 条件:
     - 先月（fromYM）に存在する
     - 当月（toYM）に未登録（重複しない）
     - 論理削除されていない
   - ソート: 会社名、秘書名、タスクランク名、作成日時

3. **継続月数の計算**
   - 各候補アサインについて、`countConsecutiveMonths()` で継続月数を計算
   - 計算方法:
     - `AssignmentDAO.selectMonthsForPairUpTo(secretaryId, customerId, fromYM)` で存在月を取得
     - 先月（fromYM）を末尾として、過去に遡って連続月をカウント
     - 例: 2024-01, 2024-02, 2024-03（fromYM）→ 継続月数=3
   - Map<UUID, Integer>（アサインID → 継続月数）に格納

4. **画面表示**
   - リクエスト属性 `fromYM` に先月をセット
   - リクエスト属性 `toYM` に対象月をセット
   - リクエスト属性 `candidates` に引き継ぎ候補をセット
   - リクエスト属性 `contMonths` に継続月数マップをセット
   - プレビュービュー（`assignment/admin/carry_over_preview`）へフォワード

#### 2. 引き継ぎ実行（POST `/admin/assignment/carry_over_apply`）

1. **パラメータ取得・検証**
   - `toYM`: 対象月（yyyy-MM形式、必須）
   - `assignmentId[]`: 選択されたアサインIDの配列
   - 年月形式チェック: `isYearMonth()` で検証
   - エラー時: アサイン一覧へリダイレクト

2. **選択チェック**
   - `assignmentId[]` が空または未指定の場合
   - プレビュー画面へリダイレクト
   - リダイレクト先: `/admin/assignment/carry_over_preview?toYM={対象月}&fromYM={先月}`

3. **UUID変換**
   - 配列の各要素をUUIDに変換
   - 変換エラー時はスキップ

4. **元アサイン情報の取得**
   - `AssignmentDAO.selectByIds(idList)` で選択されたアサインの情報を取得

5. **一括コピー処理**
   - 各アサインについて:
     - 新しいAssignmentDTOを作成
     - 元アサインから以下をコピー:
       - 顧客ID（customer_id）
       - 秘書ID（secretary_id）
       - タスクランクID（task_rank_id）
       - 基本単価（base_pay_customer, base_pay_secretary）
       - 増額単価（increase_base_pay_customer, increase_base_pay_secretary）
       - インセンティブ（customer_based_incentive_for_customer, customer_based_incentive_for_secretary）
       - ステータス（status）
     - 対象月を `toYM` に設定
     - 重複チェック: `AssignmentDAO.existsDuplicate(dto)` で確認
     - 重複しない場合のみINSERT: `AssignmentDAO.insert(dto)`

6. **トランザクションコミット**
   - `tm.commit()` で明示的コミット

7. **リダイレクト**
   - アサイン一覧へリダイレクト（対象月を指定）
   - リダイレクト先: `/admin/assignment?targetYM={対象月}`

### トランザクション管理

#### プレビュー表示

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());
    List<AssignmentDTO> candidates = dao.selectCarryOverCandidates(fromYM, toYM);

    Map<UUID,Integer> contMonths = new HashMap<>();
    for (AssignmentDTO a : candidates) {
        int n = countConsecutiveMonths(tm, a.getAssignmentSecretaryId(), a.getAssignmentCustomerId(), fromYM);
        contMonths.put(a.getAssignmentId(), n);
    }

    req.setAttribute("fromYM", fromYM);
    req.setAttribute("toYM",   toYM);
    req.setAttribute("candidates", candidates);
    req.setAttribute("contMonths", contMonths);
    return VIEW_CARRY_OVER_PREVIEW;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

#### 引き継ぎ実行

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());
    List<AssignmentDTO> rows = dao.selectByIds(idList);

    for (AssignmentDTO src : rows) {
        AssignmentDTO dto = new AssignmentDTO();
        dto.setAssignmentCustomerId(src.getAssignmentCustomerId());
        dto.setAssignmentSecretaryId(src.getAssignmentSecretaryId());
        dto.setTaskRankId(src.getTaskRankId());
        dto.setTargetYearMonth(toYM);
        dto.setBasePayCustomer(src.getBasePayCustomer());
        dto.setBasePaySecretary(src.getBasePaySecretary());
        dto.setIncreaseBasePayCustomer(src.getIncreaseBasePayCustomer());
        dto.setIncreaseBasePaySecretary(src.getIncreaseBasePaySecretary());
        dto.setCustomerBasedIncentiveForCustomer(src.getCustomerBasedIncentiveForCustomer());
        dto.setCustomerBasedIncentiveForSecretary(src.getCustomerBasedIncentiveForSecretary());
        dto.setAssignmentStatus(src.getAssignmentStatus());
        if (!dao.existsDuplicate(dto)) {
            dao.insert(dto);
        }
    }
    tm.commit();  // 明示的コミット
    return req.getContextPath() + "/admin/assignment?targetYM=" + toYM;
} catch (RuntimeException e) {
    e.printStackTrace();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック
- 重複チェックでスキップされたアサインもエラーにならない

### DAO呼び出し

- **AssignmentDAO**
  - `selectCarryOverCandidates(String fromYM, String toYM)`: 引き継ぎ候補取得
    - SQL: `SQL_SELECT_CARRYOVER_CANDIDATES`（573行目）
    - 先月に存在し、当月に未登録のアサインを取得
  - `selectByIds(List<UUID> ids)`: 複数アサイン取得（ID配列指定）
    - SQL: 動的SQL（1456行目）
    - 選択されたアサインの情報を取得
  - `selectMonthsForPairUpTo(UUID secretaryId, UUID customerId, String upToYm)`: 継続月数計算用
    - SQL: `SQL_SELECT_MONTHS_FOR_PAIR_UPTO`（600行目）
    - 秘書×顧客の存在月を降順で取得
  - `existsDuplicate(AssignmentDTO dto)`: 重複チェック
    - SQL: `SQL_EXISTS_DUPLICATE`（417行目）
  - `insert(AssignmentDTO dto)`: アサイン新規登録
    - SQL: `SQL_INSERT`（406行目）

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **年月形式検証**: 不正な年月形式を拒否（yyyy-MM以外）
- **重複防止**: 既に存在するアサインは自動的にスキップ
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **プレビュー画面**: [/WEB-INF/jsp/assignment/admin/carry_over_preview.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/carry_over_preview.jsp)

### プレビュー画面 (carry_over_preview.jsp)

| 項目 | 説明 |
|-----|------|
| **先月** | fromYM（yyyy-MM形式） |
| **対象月** | toYM（yyyy-MM形式） |
| **引き継ぎ候補一覧** | チェックボックス付きテーブル |
| **チェックボックス** | 引き継ぎ対象を選択 |
| **顧客名** | 会社名 |
| **秘書名** | 秘書氏名 |
| **秘書ランク** | 秘書ランク名 |
| **タスクランク** | タスクランク名（A/B/C/D/E/P） |
| **単価（顧客）** | 基本単価（顧客） |
| **単価（秘書）** | 基本単価（秘書） |
| **増額（顧客）** | 増額単価（顧客） |
| **増額（秘書）** | 増額単価（秘書） |
| **継続単価（顧客）** | インセンティブ（顧客） |
| **継続単価（秘書）** | インセンティブ（秘書） |
| **継続月数** | 先月を末尾とする連続月数 |

## データモデル

### 使用するDTO

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報（全フィールド使用）

### リクエスト属性

#### プレビュー画面

- **fromYM** (String): 先月（yyyy-MM）
- **toYM** (String): 対象月（yyyy-MM）
- **candidates** (List<AssignmentDTO>): 引き継ぎ候補一覧
- **contMonths** (Map<UUID, Integer>): 継続月数マップ（アサインID → 継続月数）

### URLパラメータ

#### プレビュー

- **toYM** (String): 対象月（yyyy-MM形式）
- **fromYM** (String): 先月（yyyy-MM形式）

#### 実行

- **toYM** (String): 対象月（yyyy-MM形式）
- **assignmentId[]** (String[]): 選択されたアサインIDの配列

## エラーハンドリング

### バリデーションエラー

- **年月形式エラー**: yyyy-MM形式以外
  - アサイン一覧へリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

### 引き継ぎ候補の抽出条件

- **先月に存在する**: fromYMのアサイン
- **当月に未登録**: toYMに同じ顧客×秘書×ランクのアサインが存在しない
- **論理削除されていない**: deleted_at IS NULL

### 継続月数の計算

- 先月（fromYM）を末尾として、過去に遡って連続月をカウント
- 秘書×顧客の組み合わせで計算（ランクは不問）
- 例:
  - 2024-01, 2024-02, 2024-03（fromYM）→ 継続月数=3
  - 2024-01, (2024-02欠落), 2024-03（fromYM）→ 継続月数=1

### 重複チェックの仕様

- `existsDuplicate()` で重複確認
- 重複条件: 同月・同顧客・同秘書・同ランク
- 重複時はスキップ（エラーにならない）
- 既に登録済みのアサインを上書きしない

### 一括コピーの仕様

- 選択されたアサインのみコピー
- 全ての単価情報をコピー（基本単価、増額単価、インセンティブ）
- ステータスもコピー
- 対象月のみ変更（toYM）

### チェックボックス選択

- 全選択チェックボックスで一括選択可能
- 個別にチェック/チェック解除も可能
- 未選択時はプレビュー画面へ戻る

### リダイレクト先

- 引き継ぎ実行後はアサイン一覧へリダイレクト
- 対象月（toYM）をURLパラメータで引き継ぎ

### 使用場面

- 月次の定期的なアサイン登録
- 継続契約の更新
- 新月のアサイン設定の効率化

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): 引き継ぎ後の一覧表示、引き継ぎボタンの表示
- **秘書アサイン登録** (26_秘書アサイン登録.md): 引き継ぎで不足するアサインの追加登録
- **継続単価の変更** (28_継続単価の変更.md): 引き継ぎ後の単価調整
