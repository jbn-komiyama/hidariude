# 01_ログイン（A01_91）

## 機能概要

システム管理者がメールアドレスとパスワードを使用してHidariudeシステムにログインする機能です。認証成功時にセッションが作成され、管理者ホーム画面へ遷移します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin` | ログイン画面表示 | 管理者ログインフォームを表示 |
| POST | `/admin/login` | ログイン処理 | 認証を実行し、成功時はホームへリダイレクト |

## 画面フロー

```
[ログイン画面] (/admin)
    ↓ メールアドレス・パスワード入力
    ↓ POST /admin/login
    |
    ├─ 認証成功 → [管理者ホーム画面] (/admin/home) へリダイレクト
    └─ 認証失敗 → [ログイン画面] (/admin) へ戻る（エラーメッセージ表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CommonService.java](../../../src/main/java/service/CommonService.java:175)
- **メソッド**: `adminLogin()`

### 処理フロー

1. **入力パラメータ取得**
   - `loginId`: メールアドレス（必須）
   - `password`: パスワード（必須）

2. **バリデーション**
   - 必須チェック: `validation.isNull("ログインID", loginId)`
   - 必須チェック: `validation.isNull("パスワード", password)`
   - エラー時: `errorMsg` 属性をセットしてログイン画面へ戻る

3. **データベース認証**
   - `SystemAdminDAO.selectByMail(loginId)` でメールアドレスから管理者情報を取得
   - `PasswordUtil.verifyPassword(password, dto.getPassword())` でパスワード照合（BCrypt）
   - 認証失敗時: "メールアドレス、パスワードの組み合わせが間違っています" エラー

4. **最終ログイン時刻更新**
   - 認証成功時に `SystemAdminDAO.updateLastLoginAt(dto.getId())` を実行
   - トランザクションコミット

5. **セッション作成**
   - `LoginUser` オブジェクトを作成し、以下を格納:
     - `systemAdmin`: 管理者情報（ID、メール、氏名、ふりがな、作成日時など）
     - `authority`: 権限値 `1`（システム管理者）
   - セッションに `loginUser` 属性として格納

6. **リダイレクト**
   - 成功時: `/admin/home` へリダイレクト
   - 失敗時: `/admin` （ログイン画面）へ戻る

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    SystemAdminDAO dao = new SystemAdminDAO(tm.getConnection());
    // 認証処理
    tm.commit();  // 成功時のみコミット
} catch (RuntimeException e) {
    // エラー時は自動ロールバック
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **SystemAdminDAO**
  - `selectByMail(String email)`: メールアドレスで管理者情報を取得
    - SQL: `SELECT * FROM system_admins WHERE mail = ? AND deleted_at IS NULL`
  - `updateLastLoginAt(UUID id)`: 最終ログイン時刻を更新
    - SQL: `UPDATE system_admins SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?`

### セキュリティ

- **パスワード照合**: BCrypt ハッシュによる照合（`PasswordUtil.verifyPassword()`）
- **論理削除チェック**: `deleted_at IS NULL` 条件により削除済み管理者は除外
- **セッション管理**: HttpSession に `loginUser` を格納し、以降の画面でセッションチェック

## ビューファイル

- **ログイン画面**: [/WEB-INF/jsp/common/admin/login.jsp](../../../src/main/webapp/WEB-INF/jsp/common/admin/login.jsp)

### 画面表示項目

- メールアドレス入力フィールド（`loginId`）
- パスワード入力フィールド（`password`）
- ログインボタン
- エラーメッセージ表示エリア（`errorMsg` 属性）

## データモデル

### 使用するDTO

- **SystemAdminDTO** ([dto/SystemAdminDTO.java](../../../src/main/java/dto/SystemAdminDTO.java))
  - `id` (UUID): 管理者ID
  - `mail` (String): メールアドレス
  - `password` (String): BCryptハッシュ化パスワード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `createdAt` (Timestamp): 作成日時
  - `updatedAt` (Timestamp): 更新日時
  - `deletedAt` (Timestamp): 削除日時（NULL = 有効）
  - `lastLoginAt` (Timestamp): 最終ログイン日時

### 使用するDomainオブジェクト

- **LoginUser** ([domain/LoginUser.java](../../../src/main/java/domain/LoginUser.java))
  - `systemAdmin` (SystemAdmin): 管理者情報
  - `authority` (int): 権限値（`1` = システム管理者）

- **SystemAdmin** ([domain/SystemAdmin.java](../../../src/main/java/domain/SystemAdmin.java))
  - DTOと同等のフィールド構成

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: ログイン画面へ戻り、エラーメッセージを表示
- **認証エラー**: "メールアドレス、パスワードの組み合わせが間違っています" を表示

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

- 初期データとして10件の管理者アカウントが存在（`DatabaseInitListener` による自動投入）
- デフォルト管理者: `admin1@example.com` / パスワード: `Password1`
- パスワードはBCrypt（コストファクタ10）でハッシュ化されてデータベースに保存
