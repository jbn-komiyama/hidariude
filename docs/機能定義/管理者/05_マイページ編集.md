# 05_マイページ編集（A02_02）

## 機能概要

ログイン中のシステム管理者が自身のアカウント情報（メールアドレス、氏名、ふりがな、パスワード）を編集する機能です。編集後はセッション情報も更新され、即座に反映されます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/mypage/edit` | 編集フォーム表示 | 現在の情報を初期値として編集フォームを表示 |
| POST | `/admin/mypage/edit_check` | 編集確認表示 | 入力内容の確認画面を表示 |
| POST | `/admin/mypage/edit_done` | 編集確定処理 | バリデーション・更新実行・セッション更新 |

## 画面フロー

```
[マイページ画面] (/admin/mypage/home)
    ↓ 編集ボタンをクリック
    ↓ GET /admin/mypage/edit
    ↓
[編集フォーム画面] - 現在の情報が初期表示
    ↓ メール・氏名・ふりがな・パスワード（任意）を入力
    ↓ POST /admin/mypage/edit_check
    |
    ├─ バリデーションエラー → [編集フォーム画面] へ戻る（エラーメッセージ表示）
    └─ 入力に問題なし → [確認画面]
            ↓ 内容を確認して修正の場合は POST /admin/mypage/edit
            ↓ 問題なければ POST /admin/mypage/edit_done
            |
            ├─ バリデーションエラー（再チェック） → [編集フォーム画面]
            └─ 更新成功 → [マイページ画面] (/admin/mypage/home) へリダイレクト（成功メッセージ表示）
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CommonService.java](../../../src/main/java/service/CommonService.java)
- **メソッド**:
  - `adminMyPageEdit()`: 編集フォーム表示
  - `adminMyPageEditCheck()`: 編集確認画面
  - `adminMyPageEditDone()`: 編集確定処理

### 処理フロー

#### 1. 編集フォーム表示（GET `/admin/mypage/edit`）

1. **セッションチェック**
   - セッションまたは `loginUser` が存在しない場合は `/admin` へリダイレクト

2. **現在値の取得**
   - `SystemAdminDAO.selectById(adminId)` で最新の管理者情報を取得
   - `ConvertUtil.toDomain()` で Domain オブジェクトへ詰め替え

3. **フォーム初期値設定**
   - `form` 属性（Map）に現在値、および戻り遷移時の入力値を格納し JSP で初期表示

4. **ビューへフォワード**
   - 編集フォームビュー（`mypage/admin/edit`）へフォワード

#### 2. 編集確認（POST `/admin/mypage/edit_check`）

1. **セッションチェック**
   - セッションまたは `loginUser` が存在しない場合は `/admin` へリダイレクト

2. **入力値の保持**
   - リクエストパラメータを `form` に格納し、再描画時に利用

3. **バリデーション**
   - 必須チェック: `mail`, `name`
   - `mail` について自ID除外の重複チェック (`SystemAdminDAO.mailExistsExceptId`)
   - パスワードが入力されている場合は `validation.isStrongPassword` で強度検証（8文字以上・英大小数字含む）

4. **ビューへフォワード**
   - エラーがあれば編集フォームに戻りエラーメッセージを表示
   - 問題がなければ確認ビュー（`mypage/admin/edit_check`）へフォワードし、パスワードは「入力あり/変更なし」で表示

#### 3. 編集確定処理（POST `/admin/mypage/edit_done`）

1. **セッションチェックと入力取得**
   - `mail`, `name`, `nameRuby`, `password` を取得し、必須/強度チェックを再実施

2. **現在情報の取得と重複チェック**
   - `SystemAdminDAO.selectById(adminId)` で現行データを取得
   - 自分以外のメール重複 (`mailExistsExceptId`) を確認

3. **更新データ組み立て**
   - パスワード入力時のみ `PasswordUtil.hashPassword` でハッシュ化、それ以外は現行値を据え置き
   - `nameRuby` は未入力時に `null` を設定

4. **データベース更新とコミット**
   - `SystemAdminDAO.update(upd)` を実行し、成功時にトランザクションコミット

5. **セッション更新とフラッシュメッセージ**
   - 再取得した管理者情報で `loginUser.systemAdmin` を差し替え
   - セッションに `flashSuccessMsg` を設定し、マイページ表示時に成功メッセージとして表示

6. **成功リダイレクト**
   - `/admin/mypage/home` へリダイレクト

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    SystemAdminDAO dao = new SystemAdminDAO(tm.getConnection());
    // メール重複チェック
    // 現在情報取得
    // 更新実行
    tm.commit();  // 成功時のみコミット
} catch (RuntimeException e) {
    // エラー時は自動ロールバック
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **SystemAdminDAO**
  - `mailExistsExceptId(String mail, UUID exceptId)`: 自分以外でメール重複チェック
    - SQL: `SELECT COUNT(*) FROM system_admins WHERE mail = ? AND id != ? AND deleted_at IS NULL`
  - `selectById(UUID id)`: 管理者情報を取得
    - SQL: `SELECT * FROM system_admins WHERE id = ? AND deleted_at IS NULL`
  - `update(SystemAdminDTO dto)`: 管理者情報を更新
    - SQL: `UPDATE system_admins SET mail = ?, password = ?, name = ?, name_ruby = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`

### セキュリティ

- **パスワード強度チェック**: 8文字以上、英大小数字を含む必要がある
- **パスワードハッシュ化**: BCrypt（コストファクタ10）で保存
- **メール重複チェック**: 自分以外のアカウントとの重複を防止
- **セッション更新**: データベース更新成功後にセッション情報も同期

## ビューファイル

- **編集フォーム画面**: [/WEB-INF/jsp/mypage/admin/edit.jsp](../../../src/main/webapp/WEB-INF/jsp/mypage/admin/edit.jsp)
- **確認画面**: [/WEB-INF/jsp/mypage/admin/edit_check.jsp](../../../src/main/webapp/WEB-INF/jsp/mypage/admin/edit_check.jsp)

### 画面表示項目

リクエスト属性 `form` (Map) から以下の初期値を表示：

- **メールアドレス**: `form.mail`（必須）
- **氏名**: `form.name`（必須）
- **ふりがな**: `form.nameRuby`（任意）
- **パスワード**: 初期値なし（任意、空白の場合は変更なし）

また、`admin` 属性（SystemAdmin Domain）を利用して管理者ID・作成/更新日時・最終ログイン日時を表示する。

### 画面アクション

- **確認するボタン**: POST `/admin/mypage/edit_check` で確認画面へ遷移
- **編集画面の戻るリンク**: `/admin/mypage/home` へ戻る
- **確認画面**: `修正する`（POST `/admin/mypage/edit`）、`更新する`（POST `/admin/mypage/edit_done`）

## データモデル

### 使用するDTO

- **SystemAdminDTO** ([dto/SystemAdminDTO.java](../../../src/main/java/dto/SystemAdminDTO.java))
  - `id` (UUID): 管理者ID
  - `mail` (String): メールアドレス
  - `password` (String): BCryptハッシュ化パスワード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな

### 使用するDomainオブジェクト

- **LoginUser** ([domain/LoginUser.java](../../../src/main/java/domain/LoginUser.java))
  - `systemAdmin` (SystemAdmin): 管理者情報（セッション保持）
  - `authority` (int): 権限値

### リクエスト属性

- **form** (Map<String, String>): フォーム初期値・再表示用
  - `mail`: メールアドレス
  - `name`: 氏名
  - `nameRuby`: ふりがな
  - `password`: パスワード（確認画面での hidden 用）
- **admin** (SystemAdmin): 管理者の最新情報（ID・日時など表示用）
- **willChangePassword** (boolean): 確認画面でパスワード変更有無を表示するフラグ

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: 編集フォームへ戻り、エラーメッセージ・入力値を表示
- **パスワード強度エラー**: "パスワードは8文字以上で、大文字・小文字・数字を含む必要があります" を表示

### ビジネスロジックエラー

- **メール重複エラー**: "入力されたメールアドレスは既に使用されています。"
- **管理者不在エラー**: "対象の管理者が見つかりません。"
- **更新失敗エラー**: "更新に失敗しました。"

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

- パスワードフィールドを空白のまま送信すると、パスワードは変更されない
- メールアドレス変更時は即座にセッションに反映され、次回ログインから新しいメールアドレスでログイン可能
- パスワード変更時も即座に反映されるが、現在のセッションは維持される（再ログイン不要）
- ふりがなは任意項目のため、空白でも更新可能
- 更新成功後はセッションに保存した `flashSuccessMsg` が `/admin/mypage/home` で `successMsg` として表示される
