# 39_請求サマリー表示（A05_81）

## 機能概要

顧客への請求額をダッシュボード形式で表示する機能です。今月の請求総額、請求件数、合計稼働時間、前月比較を表示し、顧客ごとの請求明細を一覧表示します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/invoice/sales?yearMonth={年月}` | 請求サマリー表示 | 請求ダッシュボードを表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 請求サマリーリンククリック
    ↓ GET /admin/invoice/sales?yearMonth={yyyy-MM}
    ↓ クエリパラメータで制御：
    |   - yearMonth: 対象月（省略時は当月）
    ↓
[請求サマリー画面] (sales.jsp)
    - KPIタイル表示
      - 総請求額
      - 請求件数
      - 合計稼働時間
      - 前月比（金額差分）
    - 顧客別請求一覧
      - 顧客名でグルーピング
      - 顧客×秘書×ランクごとの明細
      - 稼働時間、単価、金額を表示
    ↓
    └─ ナビゲーション
        ├─ 対象月変更
        └─ 支払サマリーへ遷移可能
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [InvoiceService.java](../../../src/main/java/service/InvoiceService.java)
- **メソッド**: `adminInvoiceSummary()` (136行目): 請求サマリー表示

### 処理フロー

#### 1. 請求サマリー表示（GET `/admin/invoice/sales`）

1. **パラメータ取得**
   - `yearMonth`: 対象月（yyyy-MM形式）
     - 省略時は当月（Asia/Tokyo）
     - `pickYearMonthParam()` ヘルパーメソッドで取得

2. **前月の算出**
   - 対象月の前月を計算（yyyy-MM-01 → minusMonths(1)）
   - 前月比較用に使用

3. **顧客月次集計のUPSERT**
   - `CustomerMonthlyInvoiceDAO.upsertByMonthFromTasks(yearMonth)` で当月の集計を更新
   - `customer_monthly_invoices` テーブルにDRAFTステータスで登録
   - 承認済みタスクを集計

4. **請求明細の取得**
   - `InvoiceDAO.selectAdminLines(yearMonth)` で顧客×秘書×ランクの明細を取得
   - SQL: `SQL_ADMIN_LINES`（126行目）
   - GROUP BY: `customer_id, company_name, secretary_name, hourly_pay, rank_name, rank_no`
   - ORDER BY: `company_name, secretary_name, rank_no`

5. **顧客名でグルーピング**
   - `Stream.collect(Collectors.groupingBy())` で顧客名ごとにグルーピング
   - TreeMap を使用してソート順を維持

6. **KPI計算**
   - **totalAmount**: 総請求額（fee の合計）
   - **totalMinutes**: 合計稼働時間（work_minute の合計）
   - **totalTasks**: 請求件数（行数）
   - **prevTotalAmount**: 前月の総請求額
   - **diffFromPrev**: 前月比（今月 - 前月）

7. **画面用属性設定**
   - `yearMonth`: 対象月
   - `targetYM`: 対象月（互換用）
   - `prevYearMonth`: 前月
   - `adminTotals`: KPI情報（Map）
     - `totalAmount`: 総請求額
     - `totalTasksCount`: 請求件数
     - `totalWorkMinutes`: 合計稼働時間
   - `adminGrouped`: 顧客別請求一覧（Map<String, List<InvoiceDTO>>）
   - `diffFromPrev`: 前月比

8. **トランザクションコミット**
   - `tm.commit()` で明示的コミット（UPSERT実行のため）

9. **ビューへフォワード**
   - 請求サマリービュー（`invoice/admin/sales`）へフォワード

### トランザクション管理

```java
public String adminInvoiceSummary() {
    String ym = pickYearMonthParam();  // yearMonth パラメータ取得

    LocalDate cur = LocalDate.parse(ym + "-01", YMD_FMT);
    String prevYm = cur.minusMonths(1).format(YM_FMT);

    try (TransactionManager tm = new TransactionManager()) {
        InvoiceDAO dao = new InvoiceDAO(tm.getConnection());

        /** 当月の顧客向け月次サマリーを UPSERT（DRAFT） */
        new CustomerMonthlyInvoiceDAO(tm.getConnection()).upsertByMonthFromTasks(ym);

        /** 明細（顧客×秘書×ランク） */
        List<InvoiceDTO> rows = dao.selectAdminLines(ym);

        /** 顧客名でグルーピング（TreeMapで安定ソート） */
        Map<String, List<InvoiceDTO>> grouped = rows.stream()
                .collect(Collectors.groupingBy(
                        InvoiceDTO::getCustomerCompanyName,
                        TreeMap::new,
                        Collectors.toList()));

        /** KPI（合計金額・合計作業分数・行数） */
        BigDecimal totalAmount = rows.stream()
                .map(InvoiceDTO::getFee)
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        int totalMinutes = rows.stream().mapToInt(InvoiceDTO::getTotalMinute).sum();
        int totalTasks = rows.size();

        /** 前月比較 */
        BigDecimal prevTotalAmount = dao.selectAdminLines(prevYm).stream()
                .map(InvoiceDTO::getFee)
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal diffFromPrev = totalAmount.subtract(prevTotalAmount);

        /** JSP 属性（既存JSP互換キーをセット） */
        req.setAttribute("yearMonth", ym);
        req.setAttribute("targetYM", ym);
        req.setAttribute("prevYearMonth", prevYm);

        Map<String, Object> adminTotals = new HashMap<>();
        adminTotals.put("totalAmount", totalAmount);
        adminTotals.put("totalTasksCount", totalTasks);
        adminTotals.put("totalWorkMinutes", totalMinutes);
        req.setAttribute("adminTotals", adminTotals);

        req.setAttribute("adminGrouped", grouped);
        req.setAttribute("diffFromPrev", diffFromPrev);

        tm.commit();
        return VIEW_SUMMARY_ADMIN_SALES;  // "invoice/admin/sales"
    } catch (Exception e) {
        throw new ServiceException("E:INV-ADM-SUM 管理者サマリー作成に失敗しました。", e);
    }
}
```

**特徴**:
- UPSERT処理があるため、明示的に `tm.commit()` を呼ぶ必要あり
- Stream API を使用した集計処理
- TreeMap によるソート順の維持

### DAO呼び出し

- **InvoiceDAO**
  - `selectAdminLines(String targetYM)`: 請求明細取得
    - SQL: `SQL_ADMIN_LINES`（126行目）
    - JOIN: `tasks → assignments → customers, secretaries, task_rank`
    - GROUP BY: 顧客×秘書×ランクごとに集計
    - 集計項目: `SUM(work_minute)`, `hourly_pay`（単価）
    - 金額計算: `hourly_pay × totalMinute / 60`（四捨五入）

- **CustomerMonthlyInvoiceDAO**
  - `upsertByMonthFromTasks(String yearMonth)`: 顧客月次集計UPSERT
    - 承認済みタスクを集計して `customer_monthly_invoices` テーブルに登録
    - ステータス: DRAFT

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **論理削除フィルタ**: 削除済みタスクは集計対象外（`deleted_at IS NULL`）
- **承認済みフィルタ**: 未承認タスクは集計対象外（UPSERT処理で考慮）

## ビューファイル

- **請求サマリー画面**: [/WEB-INF/jsp/invoice/admin/sales.jsp](../../../src/main/webapp/WEB-INF/jsp/invoice/admin/sales.jsp)

### 画面表示項目

#### KPIタイル

リクエスト属性 `adminTotals` (Map<String, Object>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **総請求額** | 今月の請求合計金額（totalAmount） |
| **請求件数** | 請求明細の行数（totalTasksCount） |
| **合計稼働時間** | 合計作業時間（totalWorkMinutes、時:分形式） |
| **前月比** | 前月との金額差分（diffFromPrev、±表示） |

#### 顧客別請求一覧

リクエスト属性 `adminGrouped` (Map<String, List<InvoiceDTO>>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **顧客名** | 顧客企業名（キー） |
| **秘書名** | 秘書氏名 |
| **ランク** | 業務ランク（A/B/C/D/E） |
| **稼働時間** | 合計作業時間（totalMinute、時:分形式） |
| **単価** | 顧客課金時給（hourlyPay） |
| **金額** | 請求金額（fee = hourlyPay × totalMinute / 60） |

### 画面アクション

- **対象月変更**: プルダウンで対象月を選択
- **支払サマリーへ遷移**: ナビゲーションメニューから支払サマリーへ遷移可能

## データモデル

### 使用するDTO

- **InvoiceDTO** ([dto/InvoiceDTO.java](../../../src/main/java/dto/InvoiceDTO.java))
  - 請求明細情報
  - `customerId`: 顧客ID
  - `customerCompanyName`: 顧客企業名
  - `secretaryName`: 秘書氏名
  - `taskRankName`: 業務ランク名
  - `totalMinute`: 合計稼働時間（分）
  - `hourlyPay`: 顧客課金時給
  - `fee`: 請求金額
  - `targetYM`: 対象月

### リクエスト属性

- **yearMonth** (String): 対象月（yyyy-MM）
- **targetYM** (String): 対象月（互換用）
- **prevYearMonth** (String): 前月（yyyy-MM）
- **adminTotals** (Map<String, Object>): KPI情報
  - `totalAmount` (BigDecimal): 総請求額
  - `totalTasksCount` (Integer): 請求件数
  - `totalWorkMinutes` (Integer): 合計稼働時間（分）
- **adminGrouped** (Map<String, List<InvoiceDTO>>): 顧客別請求一覧
- **diffFromPrev** (BigDecimal): 前月比（金額差分）

## エラーハンドリング

### システムエラー

- **ServiceException**: エラーメッセージ "E:INV-ADM-SUM 管理者サマリー作成に失敗しました。"
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）
- 前月データがない場合、前月比は0として表示

## 備考

### 請求集計の仕様

- **集計対象**: 承認済みタスク（`approved_at IS NOT NULL`）
- **集計単位**: 顧客×秘書×ランク
- **金額計算**: `hourlyPay × totalMinute / 60`（四捨五入）
- **単価**: `base_pay_customer + increase_base_pay_customer + customer_based_incentive_for_customer`

### UPSERT処理

- 画面表示のたびに `customer_monthly_invoices` テーブルを更新
- ステータス: DRAFT
- 既存データがあれば更新、なければ新規登録

### 顧客名グルーピング

- TreeMap を使用してソート順を維持（顧客名の昇順）
- 同一顧客の複数明細（秘書×ランク）をまとめて表示

### 前月比の計算

- 前月の同じ集計を実行して合計金額を算出
- 今月 - 前月 で差分を計算
- プラス表示（増加）、マイナス表示（減少）

### 対象月の指定

- URLパラメータで対象月を指定可能
- 省略時は当月（Asia/Tokyo）
- 過去月の集計も可能

### 使用場面

- 月次の請求額確認
- 顧客別の請求明細確認
- 前月との比較
- 請求書発行前の確認

### 関連機能

- **業務承認** (32_業務承認.md): 請求対象タスクの承認
- **業務一覧表示** (30_業務一覧表示.md): 承認済みタスクの確認
- **支払サマリー表示** (40_支払サマリー表示.md): 秘書への支払額集計
- **顧客請求データ出力** (38_顧客請求データ出力.md): 請求データのExcel出力（未実装）
