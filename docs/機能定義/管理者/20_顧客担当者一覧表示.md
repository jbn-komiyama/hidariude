# 20_顧客担当者一覧表示（A04_15）

## 機能概要

指定顧客に紐づく担当者の一覧を表示する機能です。顧客情報と担当者一覧を同時に取得し、担当者の登録・編集・削除操作へのリンクを提供します。主担当フラグ（is_primary_contact）も表示されます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/contact?customerId={顧客ID}` | 担当者一覧表示 | 指定顧客の担当者一覧を表示 |

## 画面フロー

```
[顧客一覧画面] または [顧客詳細画面]
    ↓ 担当者一覧ボタンをクリック
    ↓ GET /admin/contact?customerId={UUID}
    ↓ 顧客情報と担当者一覧を取得
    ↓
[担当者一覧画面] - 顧客情報、担当者一覧を表示
    ↓
    ├─ 新規登録ボタン → /admin/contact/register?customerId={UUID}
    ├─ 編集ボタン → /admin/contact/edit?id={担当者ID}&customerId={顧客ID}
    └─ 削除ボタン → /admin/contact/delete?id={担当者ID}&customerId={顧客ID}
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [ContactService.java](../../../src/main/java/service/ContactService.java)
- **メソッド**: `contactList()` (109行目): 担当者一覧表示

### 処理フロー

#### 1. 担当者一覧表示（GET `/admin/contact?customerId={UUID}`）

1. **パラメータ取得・検証**
   - `customerId`: 対象顧客ID（UUID形式）
   - `validation.isUuid(customerId)` でUUID形式チェック
   - 不正な形式の場合: "不正な顧客IDが指定されました。" エラー

2. **顧客情報取得**
   - `CustomerDAO.selectByUUId(customerId)` で顧客情報を取得
   - DTO → Domainオブジェクトに変換
   - `customer` 属性に設定（ヘッダー表示用）

3. **担当者一覧取得**
   - `CustomerContactDAO.selectByCustomerId(customerId)` で担当者一覧を取得
   - 論理削除済み担当者は除外（`deleted_at IS NULL`）
   - 氏名昇順でソート
   - DTO → Domainオブジェクトのリストに変換

4. **画面表示**
   - `customer` 属性に顧客情報を設定
   - `contacts` 属性に担当者一覧を設定
   - 一覧ビュー（`contact/admin/home`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    CustomerDAO cdao = new CustomerDAO(tm.getConnection());
    CustomerDTO cdto = cdao.selectByUUId(customerId);
    Customer customer = conv.toDomain(cdto);

    CustomerContactDAO dao = new CustomerContactDAO(tm.getConnection());
    List<CustomerContactDTO> dtos = dao.selectByCustomerId(customerId);

    List<CustomerContact> contacts = new ArrayList<>(dtos.size());
    for (CustomerContactDTO d : dtos) contacts.add(conv.toDomain(d));

    req.setAttribute(A_CUSTOMER, customer);
    req.setAttribute(A_CONTACTS, contacts);
    return VIEW_HOME;

} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **CustomerDAO**
  - `selectByUUId(UUID id)`: 顧客情報を取得
    - SQL: `SELECT c.* FROM customers c WHERE c.deleted_at IS NULL AND c.id = ?`

- **CustomerContactDAO**
  - `selectByCustomerId(UUID customerId)`: 顧客別担当者一覧を取得
    - SQL:
      ```sql
      SELECT cc.id, cc.customer_id, cc.mail, cc.password, cc.name, cc.name_ruby,
             cc.phone, cc.department, cc.is_primary, cc.created_at, cc.updated_at,
             cc.deleted_at, cc.last_login_at
      FROM customer_contacts cc
      WHERE cc.deleted_at IS NULL AND cc.customer_id = ?
      ORDER BY cc.name
      ```
    - 戻り値: `List<CustomerContactDTO>`（0件可）
    - 例外: `DAOException` - "E:CC11 顧客別の担当者一覧取得に失敗しました。"

### セキュリティ

- **UUID検証**: 不正な顧客ID形式をエラーとして処理
- **論理削除除外**: `deleted_at IS NULL` 条件により削除済み担当者を自動除外
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **担当者一覧画面**: [/WEB-INF/jsp/contact/admin/home.jsp](../../../src/main/webapp/WEB-INF/jsp/contact/admin/home.jsp)

### 画面表示項目

#### 顧客情報ヘッダー

| 項目 | 説明 |
|------|------|
| **会社コード** | 顧客の会社コード |
| **会社名** | 顧客の会社名 |

#### 担当者一覧テーブル

| 列 | 説明 |
|---|------|
| **氏名** | 担当者の氏名 |
| **ふりがな** | 氏名のふりがな |
| **メールアドレス** | 担当者のメールアドレス（ログインID） |
| **電話番号** | 担当者の電話番号 |
| **部署** | 担当者の部署 |
| **主担当** | 主担当フラグ（○/空白） |
| **操作** | 編集ボタン、削除ボタン |

### 画面アクション

- **新規登録ボタン**: GET `/admin/contact/register?customerId={UUID}` - 担当者新規登録画面へ遷移
- **編集ボタン**: GET `/admin/contact/edit?id={担当者ID}&customerId={顧客ID}` - 担当者編集画面へ遷移
- **削除ボタン**: GET `/admin/contact/delete?id={担当者ID}&customerId={顧客ID}` - 担当者削除処理（JavaScript確認ダイアログ）
- **戻るボタン**: 顧客一覧画面へ戻る

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - `id` (UUID): 顧客ID
  - `companyCode` (String): 会社コード
  - `companyName` (String): 会社名

- **CustomerContactDTO** ([dto/CustomerContactDTO.java](../../../src/main/java/dto/CustomerContactDTO.java))
  - `id` (UUID): 担当者ID
  - `customerId` (UUID): 顧客ID（FK）
  - `mail` (String): メールアドレス（UNIQUE, NOT NULL）
  - `password` (String): パスワード（BCryptハッシュ）
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `phone` (String): 電話番号
  - `department` (String): 部署
  - `isPrimary` (Boolean): 主担当フラグ
  - `createdAt` (Timestamp): 作成日時
  - `updatedAt` (Timestamp): 更新日時
  - `deletedAt` (Timestamp): 削除日時
  - `lastLoginAt` (Timestamp): 最終ログイン日時

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報

- **CustomerContact** ([domain/CustomerContact.java](../../../src/main/java/domain/CustomerContact.java))
  - 担当者情報

### リクエスト属性

- **customer** (Customer): 顧客情報（ヘッダー表示用）
- **contacts** (List<CustomerContact>): 担当者一覧
- **errorMsg** (String): エラーメッセージ（エラー時のみ）

## エラーハンドリング

### バリデーションエラー

- **顧客ID形式エラー**: "不正な顧客IDが指定されました。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

### 一覧表示の仕様

- **ソート順**: 氏名（name）の昇順
- **論理削除除外**: `deleted_at IS NULL` 条件により削除済み担当者は表示されない
- **担当者0件**: 担当者が登録されていない場合、空のリストを表示（エラーにならない）
- **主担当表示**: `is_primary` フラグが true の担当者に "○" を表示

### 画面遷移

- **顧客情報ヘッダー**: 顧客の会社コード・会社名を表示（どの顧客の担当者か明示）
- **新規登録**: 顧客IDを引き継いで担当者登録画面へ遷移
- **編集**: 担当者IDと顧客IDの両方を引き継いで編集画面へ遷移
- **削除**: 担当者IDと顧客IDの両方を引き継いで削除処理を実行
- **戻る**: 顧客一覧画面へ戻る

### データの取得

- **トランザクション**: 読み取り専用だが、TransactionManagerを使用（統一性のため）
- **DTO→Domain変換**: ConvertUtilを使用してDTOをDomainオブジェクトに変換
- **パスワード**: 一覧画面ではパスワードは表示されない（セキュリティのため）

### その他

- 担当者一覧は顧客詳細画面からもアクセス可能
- 主担当者の編集・削除も可能（他の担当者と同様）
- 主担当フラグの変更は編集画面で実施
- 担当者の最終ログイン日時は一覧画面では表示されない
