# 17_顧客詳細表示（A04_12）

## 機能概要

指定した顧客の詳細情報を表示する機能です。顧客の基本情報、担当者一覧、今月のアサイン（継続月数付き）、請求サマリ（通算・直近12ヶ月）、およびアサイン履歴を1画面で確認できます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/customer/detail?id={顧客ID}` | 詳細画面表示 | 指定IDの顧客情報を取得し、詳細画面を表示 |

## 画面フロー

```
[顧客一覧画面]
    ↓ 詳細ボタンをクリック
    ↓ GET /admin/customer/detail?id={UUID}
    ↓ データベースから顧客情報・担当者・アサイン・請求サマリを取得
    ↓
[顧客詳細画面] - 5つのセクションを表示
    ①顧客情報（基本情報・連絡先）
    ②担当者一覧（顧客企業の担当者リスト）
    ③今月のアサイン（継続月数付き）
    ④請求サマリ（通算・直近12ヶ月）
    ⑤アサイン履歴（今月まで、降順）
    ↓
    ├─ 編集ボタン → [顧客編集画面] へ遷移
    ├─ 削除ボタン → 削除処理実行
    └─ 担当者管理ボタン → [顧客担当者一覧画面] へ遷移
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CustomerService.java](../../../src/main/java/service/CustomerService.java)
- **メソッド**: `customerDetail()` (158行目): 顧客詳細表示

### 処理フロー

#### 1. 顧客詳細画面表示（GET `/admin/customer/detail?id={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 顧客ID（UUID形式）
   - `validation.isUuid(idStr)` でUUID形式チェック
   - 不正な形式の場合: "不正な顧客IDです。" エラー

2. **日時情報取得**
   - `LocalDate.now(ZoneId.of("Asia/Tokyo"))` で現在日付を取得
   - `ymNow`: 今月の年月（yyyy-MM形式）

3. **①②顧客＋担当者一覧取得**
   - `CustomerDAO.selectWithContactsByUuid(customerId)` で顧客情報と担当者一覧を取得
   - JOIN で contacts テーブルから担当者リストを取得
   - 顧客が存在しない場合: "顧客が見つかりません。" エラー
   - DTO → Domainオブジェクトに変換
   - `customer` 属性にセット

4. **③今月のアサイン取得（継続月数付き）**
   - `AssignmentDAO.selectThisMonthByCustomerWithContRank(customerId, ymNow)` で今月のアサインを取得
   - 継続月数を含むDTO取得
   - DTO → Domainオブジェクトのリストに変換
   - 継続月数マップ（`contMonths`）を作成
   - `assignmentsThisMonth` 属性と `contMonths` 属性にセット

5. **④請求サマリ取得**
   - **通算集計**: `CustomerMonthlyInvoiceDAO.selectSummaryUpToYm(customerId, ymNow)` で今月までの累計を取得
     - `invoiceTotalAmount`: 総請求額
     - `invoiceTotalCount`: 総請求件数
     - `invoiceTotalWork`: 総稼働時間（分）
   - **直近12ヶ月集計**: `CustomerMonthlyInvoiceDAO.selectLast12UpToYm(customerId, ymNow)` で月別サマリを取得
     - `invoicesLast12` 属性にセット（DTOのままリストで保持）

6. **⑤アサイン履歴取得**
   - `AssignmentDAO.selectByCustomerUpToYearMonthDesc(customerId, ymNow)` で今月までのアサイン履歴を取得
   - 降順（最新→過去）
   - DTO → Domainオブジェクトのリストに変換
   - `assignmentsHistory` 属性にセット

7. **ビューへフォワード**
   - `targetYM` 属性に今月の年月をセット
   - 詳細画面（`customer/admin/detail`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID customerId = UUID.fromString(idStr);

    /** ①② 顧客＋担当者一覧 */
    CustomerDAO cdao = new CustomerDAO(tm.getConnection());
    CustomerDTO cDto = cdao.selectWithContactsByUuid(customerId);
    if (cDto == null) {
        req.setAttribute(A_ERROR_MSG, List.of("顧客が見つかりません。"));
        return req.getContextPath() + req.getServletPath() + "/error";
    }
    Customer customer = conv.toDomain(cDto);
    req.setAttribute(A_CUSTOMER, customer);

    /** ③ 今月のアサイン（継続ランク付き） */
    AssignmentDAO adao = new AssignmentDAO(tm.getConnection());
    List<AssignmentDTO> thisMonthDtos = adao.selectThisMonthByCustomerWithContRank(customerId, ymNow);

    List<Assignment> thisMonth = new ArrayList<>();
    Map<UUID, Integer> contMap = new HashMap<>();
    for (AssignmentDTO d : thisMonthDtos) {
        thisMonth.add(conv.toDomain(d));
        if (d.getAssignmentId() != null) {
            contMap.put(d.getAssignmentId(),
                        d.getConsecutiveMonths() == null ? 0 : d.getConsecutiveMonths());
        }
    }
    req.setAttribute(A_ASSIGNMENTS_THIS, thisMonth);
    req.setAttribute(A_CONT_MONTHS, contMap);

    /** ④ 今までの請求合計（Summary） */
    CustomerMonthlyInvoiceDAO idao = new CustomerMonthlyInvoiceDAO(tm.getConnection());
    var summary = idao.selectSummaryUpToYm(customerId, ymNow);
    req.setAttribute(A_INVOICE_TOTAL_AMT,  summary.totalAmount);
    req.setAttribute(A_INVOICE_TOTAL_CNT,  summary.count);
    req.setAttribute(A_INVOICE_TOTAL_WORK, summary.totalWorkMinutes);

    /** ⑥ 直近1年の請求（DTOをそのまま渡す） */
    List<CustomerMonthlyInvoiceDTO> inv12 = idao.selectLast12UpToYm(customerId, ymNow);
    req.setAttribute(A_INVOICES_LAST12, inv12);

    /** ⑤ 今月までのアサイン履歴（最新→） */
    List<AssignmentDTO> historyDtos = adao.selectByCustomerUpToYearMonthDesc(customerId, ymNow);
    List<Assignment> history = new ArrayList<>();
    for (AssignmentDTO d : historyDtos) history.add(conv.toDomain(d));
    req.setAttribute(A_ASSIGNMENTS_HIST, history);

    req.setAttribute(A_TARGET_YM, ymNow);
    return VIEW_DETAIL;
} catch (RuntimeException e) {
    validation.addErrorMsg("顧客詳細の取得に失敗しました。");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ
- 複数のDAO（3種類）を1トランザクション内で連携

### DAO呼び出し

- **CustomerDAO**
  - `selectWithContactsByUuid(UUID id)`: 顧客情報と担当者一覧を取得
    - LEFT JOIN で contacts テーブルを結合
    - SQL: `SELECT c.*, ct.* FROM customers c LEFT JOIN contacts ct ON c.id = ct.customer_id WHERE c.id = ? AND c.deleted_at IS NULL`

- **AssignmentDAO**
  - `selectThisMonthByCustomerWithContRank(UUID customerId, String ym)`: 今月のアサインを継続月数付きで取得
    - CTE（Common Table Expression）で継続月数を計算
    - LEFT JOIN で secretaries, task_rank を結合
  - `selectByCustomerUpToYearMonthDesc(UUID customerId, String ym)`: 今月までのアサイン履歴を降順で取得
    - SQL: `SELECT * FROM assignments WHERE customer_id = ? AND target_year_month <= ? AND deleted_at IS NULL ORDER BY target_year_month DESC`

- **CustomerMonthlyInvoiceDAO**
  - `selectSummaryUpToYm(UUID customerId, String ym)`: 今月までの請求合計を取得
    - SQL: `SELECT SUM(total_amount) AS totalAmount, COUNT(*) AS count, SUM(total_work_minutes) AS totalWorkMinutes FROM customer_monthly_invoices WHERE customer_id = ? AND target_year_month <= ? AND deleted_at IS NULL`
  - `selectLast12UpToYm(UUID customerId, String ym)`: 直近12ヶ月の月別請求を取得
    - SQL: `SELECT * FROM customer_monthly_invoices WHERE customer_id = ? AND target_year_month <= ? AND deleted_at IS NULL ORDER BY target_year_month DESC LIMIT 12`

### セキュリティ

- **論理削除フィルタ**: 全てのDAO呼び出しで `deleted_at IS NULL` 条件を適用
- **UUID検証**: 不正なID形式をエラーとして処理
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **詳細画面**: [/WEB-INF/jsp/customer/admin/detail.jsp](../../../src/main/webapp/WEB-INF/jsp/customer/admin/detail.jsp)

### 画面表示項目

#### ①顧客情報（基本情報・連絡先）

| 項目 | 説明 |
|-----|------|
| **会社コード** | 顧客を識別するコード |
| **会社名** | 顧客企業名 |
| **メールアドレス** | 連絡先メールアドレス |
| **電話番号** | 連絡先電話番号 |
| **住所** | 郵便番号・住所1・住所2・建物名 |
| **登録日** | アカウント作成日時 |

#### ②担当者一覧

| 項目 | 説明 |
|-----|------|
| **担当者氏名** | 担当者の氏名 |
| **メールアドレス** | 担当者のメールアドレス |
| **電話番号** | 担当者の電話番号 |
| **主担当フラグ** | 主担当者かどうか |

#### ③今月のアサイン（継続月数付き）

| 項目 | 説明 |
|-----|------|
| **秘書名** | アサインされた秘書 |
| **業務ランク** | 割り当てられた業務ランク（A/B/C/D/E） |
| **基本単価（顧客）** | 顧客向け基本単価 |
| **基本単価（秘書）** | 秘書向け基本単価 |
| **単価増額（顧客）** | 顧客向け単価増額（ランク増額分） |
| **単価増額（秘書）** | 秘書向け単価増額（ランク増額分） |
| **継続月数** | 同一組み合わせ（顧客×秘書×ランク）の連続月数 |

#### ④請求サマリ

**通算集計**:
- **総請求額**: 顧客が支払った総額
- **総請求件数**: 請求された総件数
- **総稼働時間**: 請求対象の総稼働時間（分→時間換算）

**直近12ヶ月集計**（月別）:
- 年月
- 月別請求額
- 月別請求件数
- 月別稼働時間

#### ⑤アサイン履歴

今月までのアサイン履歴を降順（最新→過去）で表示

### 画面アクション

- **編集ボタン**: 顧客編集画面（`/admin/customer/edit?id={顧客ID}`）へ遷移
- **削除ボタン**: 削除確認後、削除処理実行（`/admin/customer/delete?id={顧客ID}`）
- **担当者管理ボタン**: 顧客担当者一覧画面（`/admin/contact?customerId={顧客ID}`）へ遷移
- **戻るボタン**: 顧客一覧画面へ戻る

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - 顧客の基本情報を格納
  - LEFT JOIN で担当者情報も含む

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報（秘書、業務ランク、単価等）
  - 継続月数（`consecutiveMonths`）フィールド含む

- **CustomerMonthlyInvoiceDTO** ([dto/CustomerMonthlyInvoiceDTO.java](../../../src/main/java/dto/CustomerMonthlyInvoiceDTO.java))
  - 月別請求データ（年月、請求額、件数、稼働時間）

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報（ネストした構造、担当者リストを含む）

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（ネストした構造）

### リクエスト属性

- **customer** (Customer): 顧客情報（担当者リスト含む）
- **targetYM** (String): 今月の年月（yyyy-MM）
- **assignmentsThisMonth** (List<Assignment>): 今月のアサイン（継続月数付き）
- **contMonths** (Map<UUID, Integer>): 継続月数マップ（アサインID → 継続月数）
- **invoiceTotalAmount** (BigDecimal): 総請求額
- **invoiceTotalCount** (Integer): 総請求件数
- **invoiceTotalWork** (Long): 総稼働時間（分）
- **invoicesLast12** (List<CustomerMonthlyInvoiceDTO>): 直近12ヶ月の月別請求
- **assignmentsHistory** (List<Assignment>): アサイン履歴（今月まで、降順）

## エラーハンドリング

### バリデーションエラー

- **ID形式エラー**: "不正な顧客IDです。"
  - エラーページへリダイレクト

### ビジネスロジックエラー

- **顧客不在エラー**: "顧客が見つかりません。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "顧客詳細の取得に失敗しました。"
- トランザクションは自動ロールバック

## 備考

- 読み取り専用画面のため、データの変更は行われない
- 担当者一覧は顧客情報と同時に取得（LEFT JOIN）
- 今月のアサインには継続月数が表示され、長期契約の把握が容易
- 請求サマリは `customer_monthly_invoices` テーブルから取得
  - 通算集計: 今月までの全期間の合計
  - 直近12ヶ月集計: 12ヶ月分の月別データ
- アサイン履歴は降順（最新→過去）で表示
- 詳細画面から直接編集・削除が可能（ワンクリックアクセス）
- 削除時は確認ダイアログが表示される（JavaScript: `confirm()`）
