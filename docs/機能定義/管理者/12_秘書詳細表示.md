# 12_秘書詳細表示（A04_07）

## 機能概要

指定した秘書の詳細情報を表示する機能です。秘書の基本情報、プロフィール、今月のアサイン（継続月数付き）、過去24ヶ月分のアサイン履歴、および通算・直近12ヶ月の集計データを1画面で確認できます。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/secretary/detail?id={秘書ID}` | 詳細画面表示 | 指定IDの秘書情報を取得し、詳細画面を表示 |

## 画面フロー

```
[秘書一覧画面]
    ↓ 詳細ボタンをクリック
    ↓ GET /admin/secretary/detail?id={UUID}
    ↓ データベースから秘書情報・プロフィール・アサイン・集計を取得
    ↓
[秘書詳細画面] - 5つのセクションを表示
    ①秘書情報（基本情報・連絡先・口座情報）
    ②プロフィール情報（対応可能時間帯・稼働時間・自己紹介等）
    ③今月のアサイン（継続月数付き）
    ④過去アサイン履歴（最大24ヶ月遡り）
    ⑤集計データ（通算・直近12ヶ月）
    ↓
    ├─ 編集ボタン → [秘書詳細編集画面] へ遷移
    └─ 削除ボタン → 削除処理実行
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [SecretaryService.java](../../../src/main/java/service/SecretaryService.java)
- **メソッド**: `secretaryDetail()` (275行目): 秘書詳細表示

### 処理フロー

#### 1. 秘書詳細画面表示（GET `/admin/secretary/detail?id={UUID}`）

1. **パラメータ取得・検証**
   - `id`: 秘書ID（UUID形式）
   - `validation.isUuid(idStr)` でUUID形式チェック
   - 不正な形式の場合: "不正なIDが指定されました。" エラー

2. **日時情報取得**
   - `LocalDate.now(ZoneId.of("Asia/Tokyo"))` で現在日付を取得
   - `ym`: 今月の年月（yyyy-MM形式）
   - `ymFrom12`: 12ヶ月前の年月（yyyy-MM形式）

3. **①秘書基本情報取得**
   - `SecretaryDAO.selectByUUId(secId)` で秘書情報を取得
   - DTO → Domainオブジェクトに変換
   - `secretary` 属性にセット

4. **①-2 プロフィール情報取得**
   - `ProfileDAO.selectBySecretaryId(secId)` でプロフィールを取得
   - プロフィールは任意（NULL可能）
   - DTO → Domainオブジェクトに変換
   - `profile` 属性にセット

5. **②今月のアサイン取得（継続月数付き）**
   - `AssignmentDAO.selectAssignmentsForMonthWithCont(ym, secId, null, null, false, contMap)` 呼び出し
   - 今月のアサインに継続月数を付与
   - `contMap`: 顧客×秘書×ランクごとの継続月数をマッピング
   - `assignThisMonth` 属性にセット

6. **④過去アサイン履歴取得（最大24ヶ月遡り）**
   - ループで過去24ヶ月分のアサインを取得
   - 各月ごとに `selectAssignmentsForMonthWithCont()` を呼び出し
   - データがある月のみリストに追加（最新→過去の降順）
   - 5年以上前で安全停止（過去5年まで）
   - `assignUptoMonth` 属性にセット

7. **③+⑤ 集計データ取得**
   - **通算集計**: `SecretaryMonthlySummaryDAO.selectTotals(secId)` で通算の売上・件数・稼働分を取得
     - `totals` 属性にセット（SecretaryTotals Domain）
   - **直近12ヶ月集計**: `SecretaryMonthlySummaryDAO.selectLast12Months(secId, ymFrom12, ym)` で月別サマリを取得
     - 年月昇順でリスト化
     - `last12` 属性にセット（List<SecretaryMonthlySummary>）

8. **ビューへフォワード**
   - 詳細画面（`secretary/admin/detail`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID secId = UUID.fromString(idStr);

    /** ① 秘書情報 */
    SecretaryDAO sdao = new SecretaryDAO(tm.getConnection());
    SecretaryDTO sDto = sdao.selectByUUId(secId);

    /** ①-2 プロフィール */
    ProfileDAO pdao = new ProfileDAO(tm.getConnection());
    ProfileDTO pDto = pdao.selectBySecretaryId(secId); // null可

    /** ② 今月アサイン */
    AssignmentDAO adao = new AssignmentDAO(tm.getConnection());
    Map<UUID, Integer> contMap = new HashMap<>();
    List<AssignmentDTO> assignThisMonth =
        adao.selectAssignmentsForMonthWithCont(ym, secId, null, null, false, contMap);

    /** ④ 過去アサイン（24ヶ月遡り） */
    List<AssignmentDTO> uptoList = new ArrayList<>();
    LocalDate cursor = today;
    for (int i = 0; i < 24; i++) {
        String ymLoop = cursor.format(DateTimeFormatter.ofPattern("yyyy-MM"));
        List<AssignmentDTO> rows = adao.selectAssignmentsForMonthWithCont(ymLoop, secId, null, null, false, null);
        if (rows != null && !rows.isEmpty()) {
            uptoList.addAll(rows);
        }
        cursor = cursor.minusMonths(1);
        if (cursor.isBefore(today.minusYears(5))) break; // 安全停止
    }

    /** ③+⑤ 集計 */
    SecretaryMonthlySummaryDAO smdao = new SecretaryMonthlySummaryDAO(tm.getConnection());
    SecretaryTotalsDTO totalsDto = smdao.selectTotals(secId);
    List<SecretaryMonthlySummaryDTO> last12Dto = smdao.selectLast12Months(secId, ymFrom12, ym);

    return "secretary/admin/detail";
} catch (RuntimeException e) {
    validation.addErrorMsg("データ取得に失敗しました。");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ
- 複数のDAO（4種類）を1トランザクション内で連携

### DAO呼び出し

- **SecretaryDAO**
  - `selectByUUId(UUID id)`: 秘書情報を取得
    - SQL: `SELECT * FROM secretaries WHERE id = ? AND deleted_at IS NULL`

- **ProfileDAO**
  - `selectBySecretaryId(UUID secretaryId)`: プロフィール情報を取得（NULL可能）
    - SQL: `SELECT * FROM profiles WHERE secretary_id = ? AND deleted_at IS NULL`

- **AssignmentDAO**
  - `selectAssignmentsForMonthWithCont(String ym, UUID secId, UUID custId, UUID taskRankId, boolean adminFlag, Map<UUID, Integer> contMap)`: 指定月のアサインを継続月数付きで取得
    - 複雑なCTE（Common Table Expression）を使用
    - WITH句で `eff`, `a_target`, `rank_months`, `streak`, `streak_count` を定義
    - 継続月数の計算ロジック:
      - 顧客×秘書×ランクの組み合わせごとに連続月を"島"として認識
      - 末尾が指定月（ym）の島の長さが継続月数
    - LEFT JOIN で customers, task_rank, secretaries, secretary_rank を結合
    - パラメータ: 年月（yyyy-MM）、秘書ID、顧客ID（任意）、ランクID（任意）、管理者フラグ、継続月数マップ

- **SecretaryMonthlySummaryDAO**
  - `selectTotals(UUID secretaryId)`: 秘書の通算集計を取得
    - SQL: `SELECT COALESCE(SUM(total_secretary_amount),0) AS amt, COALESCE(SUM(total_tasks_count),0) AS cnt, COALESCE(SUM(total_work_time),0) AS mins FROM secretary_monthly_summaries WHERE deleted_at IS NULL AND secretary_id = ?`
  - `selectLast12Months(UUID secretaryId, String fromYm, String toYm)`: 直近12ヶ月の月別サマリを取得
    - SQL: `SELECT * FROM secretary_monthly_summaries WHERE deleted_at IS NULL AND secretary_id = ? AND target_year_month BETWEEN ? AND ? ORDER BY target_year_month`

### セキュリティ

- **論理削除フィルタ**: 全てのDAO呼び出しで `deleted_at IS NULL` 条件を適用
- **UUID検証**: 不正なID形式をエラーとして処理
- **セッションチェック**: FrontControllerで管理者権限確認済み

## ビューファイル

- **詳細画面**: [/WEB-INF/jsp/secretary/admin/detail.jsp](../../../src/main/webapp/WEB-INF/jsp/secretary/admin/detail.jsp)

### 画面表示項目

#### ①秘書情報（基本情報・連絡先・口座情報）

| 項目 | 説明 |
|-----|------|
| **秘書コード** | 秘書を識別するコード |
| **氏名** | 秘書の氏名 |
| **ランク** | 秘書ランク（A/B/C/D/E） |
| **PM対応** | PM秘書かどうか（可/不可） |
| **連絡先** | メールアドレス・電話番号 |
| **住所** | 郵便番号・住所1・住所2・建物名 |
| **登録日** | アカウント作成日時 |
| **最終ログイン日時** | 最後にログインした日時 |
| **口座情報** | 銀行名・支店名・口座種別・口座番号・口座名義 |

#### ②プロフィール情報（対応可能時間帯・稼働時間・自己紹介等）

| 項目 | 説明 |
|-----|------|
| **対応可能時間帯** | 平日・土曜・日曜の朝・昼・夜の対応可否（◎/○/-） |
| **稼働時間** | 平日・土曜・日曜の月間稼働時間（時間数） |
| **月間稼働時間** | 月間の合計稼働時間 |
| **備考** | 自由記述欄 |
| **保有資格** | 資格情報 |
| **職務経歴** | 職務経歴 |
| **学歴** | 学歴情報 |
| **自己紹介** | 自己紹介文 |

**注意**: プロフィールが未登録の場合は「プロフィール未登録」と表示

#### ③今月のアサイン（継続月数付き）

| 項目 | 説明 |
|-----|------|
| **顧客企業名** | アサイン先の顧客企業 |
| **業務ランク** | 割り当てられた業務ランク（A/B/C/D/E） |
| **基本単価（顧客）** | 顧客向け基本単価 |
| **基本単価（秘書）** | 秘書向け基本単価 |
| **単価増額（顧客）** | 顧客向け単価増額（ランク増額分） |
| **単価増額（秘書）** | 秘書向け単価増額（ランク増額分） |
| **継続月数** | 同一組み合わせ（顧客×秘書×ランク）の連続月数 |

#### ④過去アサイン履歴（最大24ヶ月遡り）

今月のアサインと同様の項目を、過去24ヶ月分（データがある月のみ）表示

#### ⑤集計データ

**通算集計**:
- **総売上（取り分合計）**: 秘書が受け取った総額
- **総タスク件数**: 承認されたタスクの総件数
- **総稼働時間**: 稼働した総時間（分→時間換算）

**直近12ヶ月集計**（月別）:
- 年月
- 月別売上（取り分）
- 月別タスク件数
- 月別稼働時間

### 画面アクション

- **編集ボタン**: 秘書詳細編集画面（`/admin/secretary/edit?id={秘書ID}`）へ遷移
- **削除ボタン**: 削除確認後、削除処理実行（`/admin/secretary/delete?id={秘書ID}`）
- **戻るボタン**: 秘書一覧画面へ戻る

## データモデル

### 使用するDTO

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - 秘書の基本情報を格納

- **ProfileDTO** ([dto/ProfileDTO.java](../../../src/main/java/dto/ProfileDTO.java))
  - プロフィール情報（対応可能時間帯、稼働時間、自己紹介等）

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報（顧客、秘書、ランク、単価等）
  - LEFT JOINで関連テーブルのデータも含む

- **SecretaryTotalsDTO** ([dto/SecretaryTotalsDTO.java](../../../src/main/java/dto/SecretaryTotalsDTO.java))
  - 通算集計データ（総売上、総件数、総稼働時間）

- **SecretaryMonthlySummaryDTO** ([dto/SecretaryMonthlySummaryDTO.java](../../../src/main/java/dto/SecretaryMonthlySummaryDTO.java))
  - 月別サマリデータ（年月、月別売上、月別件数、月別稼働時間）

### 使用するDomainオブジェクト

- **Secretary** ([domain/Secretary.java](../../../src/main/java/domain/Secretary.java))
  - 秘書情報（ネストした構造、SecretaryRankオブジェクトを含む）

- **Profile** ([domain/Profile.java](../../../src/main/java/domain/Profile.java))
  - プロフィール情報

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（ネストした構造）

- **SecretaryTotals** ([domain/SecretaryTotals.java](../../../src/main/java/domain/SecretaryTotals.java))
  - 通算集計データ

- **SecretaryMonthlySummary** ([domain/SecretaryMonthlySummary.java](../../../src/main/java/domain/SecretaryMonthlySummary.java))
  - 月別サマリデータ

### リクエスト属性

- **secretary** (Secretary): 秘書情報
- **profile** (Profile): プロフィール情報（NULL可能）
- **yearMonth** (String): 今月の年月（yyyy-MM）
- **assignThisMonth** (List<AssignmentDTO>): 今月のアサイン（継続月数付き）
- **assignUptoMonth** (List<AssignmentDTO>): 過去アサイン履歴（最大24ヶ月）
- **totals** (SecretaryTotals): 通算集計データ
- **last12** (List<SecretaryMonthlySummary>): 直近12ヶ月の月別サマリ

## エラーハンドリング

### バリデーションエラー

- **ID形式エラー**: "不正なIDが指定されました。"
  - エラーページへリダイレクト

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データ取得に失敗しました。"
- トランザクションは自動ロールバック

## 備考

- 読み取り専用画面のため、データの変更は行われない
- プロフィール情報は任意のため、未登録の秘書も表示可能
- 今月のアサインには継続月数が表示され、長期契約の把握が容易
- 過去アサイン履歴は最大24ヶ月分（データがある月のみ）を表示
  - 5年以上前で安全停止（無限ループ防止）
- 集計データは `secretary_monthly_summaries` テーブルから取得
  - 通算集計: 全期間の合計
  - 直近12ヶ月集計: 12ヶ月前～今月までの月別データ
- 継続月数の計算はCTE（Common Table Expression）による複雑なSQL
  - 顧客×秘書×ランクの組み合わせごとに連続月を"島"として認識
  - 末尾が指定月の島の長さが継続月数として表示される
- 詳細画面から直接編集・削除が可能（ワンクリックアクセス）
- 削除時は確認ダイアログが表示される（JavaScript: `confirm()`）
