# 16_顧客新規登録（A04_11）

## 機能概要

新しい顧客企業を登録する機能です。入力→確認→確定の3画面構成で、会社コード、会社名、連絡先情報を登録します。会社コードの重複チェックを実施します。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/customer/register` | 登録フォーム表示 | 新規登録の入力フォームを表示 |
| POST | `/admin/customer/register_check` | 登録確認 | 入力内容をバリデーション後、確認画面を表示 |
| POST | `/admin/customer/register_done` | 登録確定 | データベースに登録し、完了画面を表示 |

## 画面フロー

```
[顧客一覧画面]
    ↓ 新規登録ボタンをクリック
    ↓ GET /admin/customer/register
    ↓
[登録入力画面] - 会社情報、連絡先を入力
    ↓ 確認ボタンをクリック
    ↓ POST /admin/customer/register_check
    |
    ├─ バリデーションエラー → [登録入力画面] へ戻る（エラーメッセージ・入力値保持）
    └─ バリデーションOK → [登録確認画面] へ遷移
        ↓ 確定ボタンをクリック
        ↓ POST /admin/customer/register_done
        |
        ├─ 会社コード重複エラー → [登録入力画面] へ戻る
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 登録成功 → [登録完了画面] を表示
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [CustomerService.java](../../../src/main/java/service/CustomerService.java)
- **メソッド**:
  - `customerRegister()` (235行目): 登録フォーム表示
  - `customerRegisterCheck()` (248行目): 登録確認
  - `customerRegisterDone()` (295行目): 登録確定

### 処理フロー

#### 1. 登録フォーム表示（GET `/admin/customer/register`）

1. **フォーム表示**
   - データベースアクセスなし
   - 空のフォームを表示
   - 登録ビュー（`customer/admin/register`）へフォワード

#### 2. 登録確認（POST `/admin/customer/register_check`）

1. **入力パラメータ取得**
   - `companyCode`: 会社コード（必須）
   - `companyName`: 会社名（必須）
   - `mail`: メールアドレス（任意）
   - `phone`: 電話番号（任意）
   - `postalCode`: 郵便番号（任意）

2. **バリデーション**
   - 必須チェック:
     - `validation.isNull("会社コード", companyCode)`
     - `validation.isNull("会社名", companyName)`
   - 形式チェック（入力がある場合のみ）:
     - `validation.isEmail(mail)` - メールアドレス形式
     - `validation.isPhoneNumber(phone)` - 電話番号形式
     - `validation.isPostalCode(postalCode)` - 郵便番号形式

3. **会社コード重複チェック**
   - バリデーションエラーがない場合のみ実施
   - `CustomerDAO.companyCodeExists(companyCode)` で重複確認
   - 重複時: "その会社コードは既に使われています。" エラー

4. **エラー時の処理**
   - `errorMsg` 属性にエラーメッセージを設定
   - 入力値を属性に戻す（フォーム再表示用）
   - 登録入力画面へ戻る

5. **成功時の処理**
   - 入力値を属性に設定
   - 確認画面（`customer/admin/register_check`）へフォワード

#### 3. 登録確定（POST `/admin/customer/register_done`）

1. **入力パラメータ取得・バリデーション**
   - 確認画面と同じパラメータを再取得
   - 追加パラメータ:
     - `address1`: 住所1（任意）
     - `address2`: 住所2（任意）
     - `building`: 建物名（任意）
   - 確認画面と同じバリデーションを再度実行
   - ブラウザバック対策、直接URL入力対策

2. **会社コード重複チェック（再実行）**
   - `CustomerDAO.companyCodeExists(companyCode)` で重複確認
   - 重複時: "その会社コードは既に使われています。" エラー
   - エラー時: 入力値を保持して登録入力画面へ戻る

3. **DTOオブジェクト作成**
   - `CustomerDTO` オブジェクト作成
   - 全ての入力値を設定

4. **データベース登録**
   - `CustomerDAO.insert(dto)` で登録実行
   - トランザクションコミット

5. **完了画面表示**
   - `message` 属性に "登録が完了しました（件数:1）" を設定
   - 完了画面（`customer/admin/register_done`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    CustomerDAO dao = new CustomerDAO(tm.getConnection());

    /** companyCode 重複の最終確認 */
    if (notBlank(companyCode) && dao.companyCodeExists(companyCode)) {
        validation.addErrorMsg("その会社コードは既に使われています。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        pushFormBackToRequest();
        return VIEW_REGISTER;
    }

    CustomerDTO dto = new CustomerDTO();
    dto.setCompanyCode(companyCode);
    dto.setCompanyName(companyName);
    dto.setMail(mail);
    dto.setPhone(phone);
    dto.setPostalCode(postalCode);
    dto.setAddress1(address1);
    dto.setAddress2(address2);
    dto.setBuilding(building);

    int num = dao.insert(dto);
    tm.commit();

    req.setAttribute(A_MESSAGE, "登録が完了しました（件数:" + num + "）");
    return VIEW_REGISTER_DONE;
} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    pushFormBackToRequest();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **CustomerDAO**
  - `companyCodeExists(String companyCode)`: 会社コード重複チェック
    - SQL: `SELECT COUNT(*) FROM customers WHERE company_code = ? AND deleted_at IS NULL`
  - `insert(CustomerDTO dto)`: 顧客情報を登録
    - SQL:
      ```sql
      INSERT INTO customers (
          id, company_code, company_name, mail, phone,
          postal_code, address1, address2, building,
          created_at, updated_at
      ) VALUES (
          gen_random_uuid(), ?, ?, ?, ?,
          ?, ?, ?, ?,
          CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
      )
      ```

### セキュリティ

- **会社コード重複チェック**: 同じ会社コードは登録不可
- **二重バリデーション**: 確認画面と確定処理で2回検証（改ざん対策）

## ビューファイル

- **登録入力画面**: [/WEB-INF/jsp/customer/admin/register.jsp](../../../src/main/webapp/WEB-INF/jsp/customer/admin/register.jsp)
- **登録確認画面**: [/WEB-INF/jsp/customer/admin/register_check.jsp](../../../src/main/webapp/WEB-INF/jsp/customer/admin/register_check.jsp)
- **登録完了画面**: [/WEB-INF/jsp/customer/admin/register_done.jsp](../../../src/main/webapp/WEB-INF/jsp/customer/admin/register_done.jsp)

### 画面表示項目（登録入力画面）

#### 会社情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **会社コード** | ○ | 顧客を識別するコード、重複不可 |
| **会社名** | ○ | 顧客企業名 |

#### 連絡先

| 項目 | 必須 | 説明 |
|-----|------|------|
| **メールアドレス** | - | 連絡先メールアドレス |
| **電話番号** | - | 連絡先電話番号（形式チェックあり） |
| **郵便番号** | - | 郵便番号（形式チェックあり） |
| **住所1** | - | 都道府県・市区町村 |
| **住所2** | - | 番地 |
| **建物名・部屋番号** | - | 建物名・部屋番号 |

### 画面アクション

- **確認ボタン**: POST `/admin/customer/register_check` でバリデーション実行
- **戻るボタン**: 一覧画面へ戻る

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - `id` (UUID): 自動生成（`gen_random_uuid()`）
  - `companyCode` (String): 会社コード
  - `companyName` (String): 会社名
  - `mail` (String): メールアドレス
  - `phone` (String): 電話番号
  - `postalCode` (String): 郵便番号
  - `address1` (String): 住所1
  - `address2` (String): 住所2
  - `building` (String): 建物名
  - `createdAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）
  - `updatedAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）

### リクエスト属性

- **errorMsg** (String): バリデーションエラーメッセージ
- **message** (String): 登録完了メッセージ
- **入力値の属性**（エラー時の再表示用）

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: "会社コード を入力してください" など
- **メール形式エラー**: "メールアドレス の形式が正しくありません"
- **郵便番号形式エラー**: "郵便番号 の形式が正しくありません"
- **電話番号形式エラー**: "電話番号 の形式が正しくありません"

### ビジネスロジックエラー

- **会社コード重複エラー**: "その会社コードは既に使われています。"
  - 登録入力画面へ戻り、入力値を保持

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

- IDはデータベース側で自動生成（UUID）
- 作成日時・更新日時も自動設定
- 削除日時（`deleted_at`）は初期値NULL（有効状態）
- 登録完了後、一覧画面へ戻るリンクが表示される
- 会社コードは必須項目で、重複不可
- メールアドレス、電話番号、住所は任意項目
- 主担当者ID（`primary_contact_id`）は登録時は設定されない（NULL）
  - 顧客担当者登録後、顧客編集画面で設定可能
