# 25_PM秘書アサイン登録(A05_02)

## 機能概要

PM秘書(is_pm_secretary = true)を特定の顧客にアサインする機能です。3画面構成(入力→確認→完了)で、顧客・PM秘書・対象月・基本単価を設定してアサインを登録します。通常秘書のアサイン登録と異なり、増額単価とインセンティブは0円固定、タスクランクは「P」固定です。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/assignment/pm_register?companyId={顧客ID}&companyName={顧客名}&targetYM={年月}` | PM秘書アサイン登録フォーム | PM秘書アサイン登録の入力画面 |
| POST | `/admin/assignment/pm_register_check` | PM秘書アサイン登録確認 | 入力内容の検証と確認画面表示 |
| POST | `/admin/assignment/pm_register_done` | PM秘書アサイン登録完了 | アサインのDB登録と完了画面表示 |

## 画面フロー

```
[アサイン一覧画面]
    ↓ PM秘書アサイン登録ボタンクリック
    ↓ GET /admin/assignment/pm_register?companyId={顧客ID}&companyName={顧客名}&targetYM={年月}
    ↓
[PM秘書アサイン登録画面] (pm_register.jsp)
    - 顧客名: 固定表示（変更不可）
    - PM秘書: セレクトボックス（is_pm_secretary = true の秘書のみ）
    - タスクランク: 「P」固定表示
    - 対象月: yyyy-MM形式（デフォルトは当月）
    - 単価（顧客）: 金額入力
    - 単価（秘書）: 金額入力
    - ステータス: テキスト入力（省略可）
    ↓ 次へボタン
    ↓ POST /admin/assignment/pm_register_check
    ↓
[PM秘書アサイン登録確認画面] (pm_register_check.jsp)
    - 入力内容の確認表示
    - 増額単価とインセンティブは非表示（内部的に0円）
    - hidden フィールドで値を保持
    ↓ 登録ボタン
    ↓ POST /admin/assignment/pm_register_done
    ↓ 重複チェック実施
    ↓
[PM秘書アサイン登録完了画面] (pm_register_done.jsp)
    - 登録完了メッセージ表示
    ↓ アサイン一覧へ戻るボタン
    ↓ GET /admin/assignment?targetYM={年月}
    ↓
[アサイン一覧画面]
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [AssignmentService.java](../../../src/main/java/service/AssignmentService.java)
- **メソッド**:
  - `assignmentPMRegister()` (352行目): PM秘書アサイン登録フォーム表示
  - `assignmentPMRegisterCheck()` (448行目): 入力内容検証と確認画面表示
  - `assignmentPMRegisterDone()` (593行目): アサイン登録実行

### 処理フロー

#### 1. PM秘書アサイン登録フォーム表示（GET `/admin/assignment/pm_register`）

1. **パラメータ取得・検証**
   - `companyId`: 顧客ID（UUID形式、必須）
   - `companyName`: 顧客名（必須）
   - `targetYM`: 対象月（yyyy-MM形式、省略時は当月）
   - バリデーション: `isNull()` で必須チェック、エラー時はエラーページへ

2. **データ準備**
   - 顧客情報をリクエスト属性に設定（`customer`）
   - PM秘書一覧を取得（`loadSecretariesToRequest(tm, true)`）
     - `is_pm_secretary = true` の秘書のみ
     - リクエスト属性 `secretaries` にセット
   - タスクランク「P」を取得（`loadPMTaskRankToRequest(tm)`）
     - `TaskRankDAO.selectPM()` で取得
     - リクエスト属性 `taskRank` にセット

3. **ビューへフォワード**
   - PM秘書登録フォーム（`assignment/admin/pm_register`）へフォワード

#### 2. PM秘書アサイン登録確認（POST `/admin/assignment/pm_register_check`）

1. **パラメータ取得**
   - `customerId`: 顧客ID（UUID）
   - `secretaryId`: PM秘書ID（UUID）
   - `taskRankId`: タスクランクID（UUID、ランクP）
   - `targetYM`: 対象月（yyyy-MM）
   - `basePayCustomer`: 単価（顧客）
   - `basePaySecretary`: 単価（秘書）
   - `status`: ステータス（省略可）

2. **バリデーション**
   - 必須チェック: 顧客、PM秘書、タスクランク、対象月
   - UUID形式チェック: `isUuid()` で検証
   - 年月形式チェック: `isYearMonth()` で検証（yyyy-MM形式）
   - 金額チェック: `mustBeMoneyOrZero()` で検証（カンマ除去対応）

3. **バリデーションエラー時**
   - エラーメッセージをリクエスト属性にセット
   - 顧客情報、PM秘書一覧、タスクランクPを再取得
   - 入力フォーム（`pm_register`）へ戻す

4. **バリデーション成功時**
   - 顧客、PM秘書、タスクランクPの名称をDBから取得
   - 確認画面用にhidden値をリクエスト属性に設定
     - `h_customerId`, `h_secretaryId`, `h_taskRankId`
     - `h_basePayCustomer`, `h_basePaySecretary`
   - 確認ビュー（`assignment/admin/pm_register_check`）へフォワード

#### 3. PM秘書アサイン登録完了（POST `/admin/assignment/pm_register_done`）

1. **パラメータ取得・再検証**
   - hidden値から全パラメータを取得
   - 必須チェック、UUID形式チェック、金額チェックを再実施

2. **AssignmentDTO組み立て**
   - `buildAssignmentDto()` ヘルパーメソッドで組み立て
   - 増額単価とインセンティブは "0" を渡す（PM秘書固定仕様）
     - `increaseBasePayCustomer`: 0
     - `increaseBasePaySecretary`: 0
     - `customerBasedIncentiveForCustomer`: 0
     - `customerBasedIncentiveForSecretary`: 0

3. **重複チェック**
   - `AssignmentDAO.existsDuplicate(dto)` で重複確認
   - 重複条件: 同月・同顧客・同秘書・同ランク
   - 重複時: エラーメッセージを設定し、入力フォーム（`pm_register`）へ戻す

4. **DB登録**
   - `AssignmentDAO.insert(dto)` でINSERT実行
   - トランザクションコミット（`tm.commit()`）

5. **完了処理**
   - 完了メッセージをリクエスト属性に設定
   - 完了ビュー（`assignment/admin/pm_register_done`）へフォワード

### トランザクション管理

#### 登録フォーム表示

```java
try (TransactionManager tm = new TransactionManager()) {
    Customer customer = new Customer();
    customer.setId(UUID.fromString(companyIdStr));
    customer.setCompanyName(companyName);
    req.setAttribute(A_CUSTOMER, customer);

    loadSecretariesToRequest(tm, true);  // PMのみ
    loadPMTaskRankToRequest(tm);         // ランクP固定

    return VIEW_PM_REGISTER;
} catch (RuntimeException e) {
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ

#### 登録実行

```java
try (TransactionManager tm = new TransactionManager()) {
    AssignmentDTO dto = buildAssignmentDto(
            customerIdStr, secretaryIdStr, taskRankIdStr, targetYM,
            basePayCustomerStr, basePaySecretaryStr,
            "0", "0", "0", "0", status  /** PM 固定 */
    );

    AssignmentDAO dao = new AssignmentDAO(tm.getConnection());
    if (dao.existsDuplicate(dto)) {
        validation.addErrorMsg("同月・同顧客・同秘書・同ランクのアサインは既に登録済みです。");
        // エラー処理（入力フォームへ戻す）
        return VIEW_PM_REGISTER;
    }

    dao.insert(dto);
    tm.commit();  // 明示的コミット

    req.setAttribute(A_MESSAGE, "PMアサインの登録が完了しました。");
    return VIEW_PM_REGISTER_DONE;
} catch (RuntimeException e) {
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

**特徴**:
- 書き込み処理のため、明示的に `tm.commit()` を呼ぶ必要あり
- コミット前に例外が発生した場合、自動ロールバック

### DAO呼び出し

- **AssignmentDAO**
  - `existsDuplicate(AssignmentDTO dto)`: 重複チェック（同月・同顧客・同秘書・同ランク）
    - SQL: `SQL_EXISTS_DUPLICATE`（417行目）
  - `insert(AssignmentDTO dto)`: アサイン新規登録
    - SQL: `SQL_INSERT`（406行目）
    - RETURNING句でIDを取得

- **CustomerDAO**
  - `selectByUUId(UUID id)`: 顧客情報取得（確認画面用）

- **SecretaryDAO**
  - `selectAllPM()`: PM秘書一覧取得（is_pm_secretary = true）
  - `selectByUUId(UUID id)`: 秘書情報取得（確認画面用）

- **TaskRankDAO**
  - `selectPM()`: タスクランク「P」を取得

### セキュリティ

- **セッションチェック**: FrontControllerで管理者権限確認済み
- **必須パラメータ検証**: 顧客ID、PM秘書ID、対象月の必須チェック
- **UUID形式検証**: 不正なUUID形式を拒否
- **重複防止**: ユニーク制約（月×顧客×秘書×ランク）で二重登録を防止
- **トランザクション管理**: エラー時の自動ロールバック

## ビューファイル

- **入力画面**: [/WEB-INF/jsp/assignment/admin/pm_register.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/pm_register.jsp)
- **確認画面**: [/WEB-INF/jsp/assignment/admin/pm_register_check.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/pm_register_check.jsp)
- **完了画面**: [/WEB-INF/jsp/assignment/admin/pm_register_done.jsp](../../../src/main/webapp/WEB-INF/jsp/assignment/admin/pm_register_done.jsp)

### 入力画面 (pm_register.jsp)

| 項目 | 種別 | 説明 |
|-----|------|------|
| **顧客名** | 固定表示 | パラメータから受け取った顧客名を表示（変更不可） |
| **PM秘書** | セレクトボックス | is_pm_secretary = true の秘書のみ表示 |
| **タスクランク** | 固定表示 | 「P」固定（変更不可） |
| **対象月** | テキスト入力 | yyyy-MM形式（デフォルトは当月） |
| **単価（顧客）** | テキスト入力 | 金額（カンマ区切り可） |
| **単価（秘書）** | テキスト入力 | 金額（カンマ区切り可） |
| **ステータス** | テキスト入力 | 任意入力 |

### 確認画面 (pm_register_check.jsp)

| 項目 | 説明 |
|-----|------|
| **顧客名** | 入力内容の確認表示 |
| **PM秘書名** | 入力内容の確認表示 |
| **タスクランク** | 「P」固定 |
| **対象月** | 入力内容の確認表示 |
| **単価（顧客）** | 入力内容の確認表示 |
| **単価（秘書）** | 入力内容の確認表示 |
| **ステータス** | 入力内容の確認表示 |
| **hidden値** | 顧客ID、PM秘書ID、タスクランクID、単価等をPOST用に保持 |

### 完了画面 (pm_register_done.jsp)

- 登録完了メッセージ表示
- アサイン一覧へ戻るボタン

## データモデル

### 使用するDTO

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報
  - PM秘書アサインの場合の固定値:
    - `increaseBasePayCustomer`: 0
    - `increaseBasePaySecretary`: 0
    - `customerBasedIncentiveForCustomer`: 0
    - `customerBasedIncentiveForSecretary`: 0

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - 顧客情報（入力フォーム用）

- **SecretaryDTO** ([dto/SecretaryDTO.java](../../../src/main/java/dto/SecretaryDTO.java))
  - PM秘書情報（is_pm_secretary = true）

- **TaskRankDTO** ([dto/TaskRankDTO.java](../../../src/main/java/dto/TaskRankDTO.java))
  - タスクランク情報（ランクP）

### 使用するDomainオブジェクト

- **Customer** ([domain/Customer.java](../../../src/main/java/domain/Customer.java))
  - 顧客情報（JSP表示用）

- **Secretary** ([domain/Secretary.java](../../../src/main/java/domain/Secretary.java))
  - PM秘書情報（JSP表示用）

- **TaskRank** ([domain/TaskRank.java](../../../src/main/java/domain/TaskRank.java))
  - タスクランク情報（JSP表示用）

### リクエスト属性

#### 入力画面

- **customer** (Customer): 顧客情報
- **secretaries** (List<Secretary>): PM秘書一覧（is_pm_secretary = true）
- **taskRank** (TaskRank): タスクランクP
- **targetYM** (String): 対象月（yyyy-MM）
- **status** (String): ステータス
- **errorMsg** (List<String>): エラーメッセージ（バリデーションエラー時）

#### 確認画面

- **customer** (Customer): 顧客情報
- **secretary** (Secretary): 選択されたPM秘書
- **taskRank** (TaskRank): タスクランクP
- **targetYM** (String): 対象月
- **h_customerId** (String): 顧客ID（hidden用）
- **h_secretaryId** (String): PM秘書ID（hidden用）
- **h_taskRankId** (String): タスクランクID（hidden用）
- **h_basePayCustomer** (String): 単価（顧客）（hidden用）
- **h_basePaySecretary** (String): 単価（秘書）（hidden用）

#### 完了画面

- **message** (String): 完了メッセージ

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: 顧客、PM秘書、対象月の未入力
- **形式エラー**: UUID形式不正、年月形式不正（yyyy-MM以外）
- **金額エラー**: 数値以外の入力

**処理**:
- エラーメッセージをリクエスト属性にセット
- 入力フォーム（`pm_register`）へ戻す
- 入力値を保持して再表示

### 重複エラー

- **条件**: 同月・同顧客・同秘書・同ランクのアサインが既に存在
- **処理**: エラーメッセージを表示し、入力フォームへ戻す

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

## 備考

### PM秘書アサインの特徴

- **増額単価とインセンティブは0円固定**: PM秘書には増額やインセンティブが適用されない
- **タスクランクは「P」固定**: PM専用のランクを使用
- **PM秘書のみ選択可能**: is_pm_secretary = true の秘書のみプルダウンに表示
- **通常秘書と同じテーブルに登録**: assignmentsテーブルに登録、is_pm_secretaryフラグで区別

### ユニーク制約

- 月（target_year_month）× 顧客（customer_id）× 秘書（secretary_id）× ランク（task_rank_id）の組み合わせで一意
- 同じ組み合わせは重複登録不可

### 関連機能

- **アサイン一覧表示** (24_アサイン一覧表示.md): 登録後の一覧表示
- **秘書アサイン登録** (26_秘書アサイン登録.md): 通常秘書のアサイン登録
