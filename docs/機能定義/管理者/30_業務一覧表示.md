# 30_業務一覧表示（A05_06）

## 機能概要

指定月のタスク（業務）を一覧表示する機能です。タブ切り替え（全件/未承認/承認済み/差戻し）、ソート機能（秘書名・顧客名による絞り込み）を提供します。未承認タブでは一括承認が可能です。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/task/list_all?yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 全件一覧表示 | 全タスクを表示 |
| GET | `/admin/task/list_unapproved?yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 未承認一覧表示 | 未承認タスクを表示 |
| GET | `/admin/task/list_approved?yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 承認済み一覧表示 | 承認済みタスクを表示 |
| GET | `/admin/task/list_remanded?yearMonth={年月}&sec={秘書名}&cust={顧客名}` | 差戻し一覧表示 | 差戻しタスクを表示 |

## 画面フロー

```
[管理者ホーム画面] または [ナビゲーションメニュー]
    ↓ 業務一覧リンククリック
    ↓ GET /admin/task/list_all?yearMonth={yyyy-MM}
    ↓ クエリパラメータで制御：
    |   - yearMonth: 対象月（省略時は当月）
    |   - sec: 秘書名検索（部分一致）
    |   - cust: 顧客名検索（部分一致）
    ↓
[業務一覧画面]
    - タブ切り替え（全件/未承認/承認済み/差戻し）
    - 秘書名・顧客名による絞り込み
    - 業務詳細情報の表示
    ↓
    ├─ 全件タブ
    |   └─ 全タスクを表示
    |       └─ 差戻しボタン → [差戻し確認ダイアログ]
    |
    ├─ 未承認タブ
    |   └─ 未承認タスクのみ表示
    |       ├─ チェックボックスで一括選択
    |       └─ 一括承認ボタン → 承認処理実行
    |
    ├─ 承認済みタブ
    |   └─ 承認済みタスクのみ表示
    |       ├─ チェックボックスで一括選択
    |       └─ 承認取消ボタン → 承認取消処理実行
    |
    └─ 差戻しタブ
        └─ 差戻しタスクのみ表示
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [TaskService.java](../../../src/main/java/service/TaskService.java)
- **メソッド**:
  - `adminTaskListAll()` (590行目): 全件一覧表示
  - `adminTaskListUnapproved()` (609行目): 未承認一覧表示
  - `adminTaskListApproved()` (628行目): 承認済み一覧表示
  - `adminTaskListRemanded()` (647行目): 差戻し一覧表示

### 処理フロー

#### 1. 業務一覧画面表示（GET `/admin/task/list_{タブ名}`）

1. **パラメータ取得**
   - `yearMonth`: 対象月（yyyy-MM形式）
     - 省略時は当月（Asia/Tokyo）
   - `sec`: 秘書名検索（部分一致、任意）
   - `cust`: 顧客名検索（部分一致、任意）

2. **データ取得（共通ヘルパー：loadAdminList）**
   - `TaskDAO.selectByMonth(yearMonth, status, secLike, custLike)` でタスク一覧を取得
   - status は以下のいずれか:
     - `"all"`: 全件
     - `"unapproved"`: 未承認（`approved_at IS NULL AND remanded_at IS NULL`）
     - `"approved"`: 承認済み（`approved_at IS NOT NULL`）
     - `"remanded"`: 差戻し（`remanded_at IS NOT NULL`）
   - 秘書名・顧客名の部分一致検索（ILIKE）を適用

3. **集計値の計算**
   - `sumCustomer`: 顧客側の合計金額（`base_pay_customer + increase_base_pay_customer + customer_based_incentive_for_customer`）× 時間
   - `sumSecretary`: 秘書側の合計金額（`base_pay_secretary + increase_base_pay_secretary + customer_based_incentive_for_secretary`）× 時間
   - `totalMinute`: 合計作業時間（分）
   - `count`: タスク件数

4. **画面用属性設定**
   - `tasks`: タスクリスト（Task Domainオブジェクト）
   - `sumCustomer`: 顧客側合計金額
   - `sumSecretary`: 秘書側合計金額
   - `totalMinute`: 合計作業時間
   - `count`: タスク件数
   - `yearMonth`: 対象月
   - `sec`: 秘書名検索値（フォーム再表示用）
   - `cust`: 顧客名検索値（フォーム再表示用）

5. **ビューへフォワード**
   - タブごとに異なるビューへフォワード:
     - 全件: `task/admin/list_all`
     - 未承認: `task/admin/list_unapproved`
     - 承認済み: `task/admin/list_approved`
     - 差戻し: `task/admin/list_remanded`

### トランザクション管理

```java
private List<Task> loadAdminList(String yearMonth, String status, String secLike, String custLike,
                                 HttpServletRequest req) {
    try (TransactionManager tm = new TransactionManager()) {
        TaskDAO dao = new TaskDAO(tm.getConnection());
        List<TaskDTO> dtos = dao.selectByMonth(yearMonth, status, secLike, custLike);

        List<Task> tasks = new ArrayList<>(dtos.size());
        BigDecimal sumCustomer = BigDecimal.ZERO;
        BigDecimal sumSecretary = BigDecimal.ZERO;
        int totalMinute = 0;

        for (TaskDTO d : dtos) {
            Task t = conv.toDomain(d);
            totalMinute += (t.getWorkMinute() == null ? 0 : t.getWorkMinute());
            if (t.getFee() != null)         sumSecretary = sumSecretary.add(t.getFee());
            if (t.getFeeCustomer() != null) sumCustomer  = sumCustomer.add(t.getFeeCustomer());
            tasks.add(t);
        }

        // setAttribute 名は既存 JSP に合わせる
        req.setAttribute(A_TASKS, tasks);
        req.setAttribute("sumSecretary", sumSecretary);
        req.setAttribute("sumCustomer", sumCustomer);
        req.setAttribute(A_TOTAL_MINUTE, totalMinute);
        req.setAttribute(A_COUNT, tasks.size());
        return tasks;
    }
}
```

**特徴**:
- 読み取り専用処理のため、明示的なコミット不要
- try-with-resourcesで自動クローズ
- DTO→Domain変換はConvertUtilを使用

### DAO呼び出し

- **TaskDAO**
  - `selectByMonth(String yearMonth, String status, String secretaryNameLike, String customerNameLike)`: タスク一覧取得
    - SQL: `SQL_SELECT_BY_MONTH_BASE`（78行目）+ 動的WHERE句
    - 状態フィルタ: `approved_at`, `remanded_at` の NULL判定
    - 文字列フィルタ: `ILIKE` による部分一致検索（大文字小文字無視）
    - ソート: `work_date, customer_id, start_time`
    - JOIN: `tasks → assignments → customers, secretaries, task_rank`

### セキュリティ

- **論理削除フィルタ**: 削除済みタスクは表示されない（`t.deleted_at IS NULL`）
- **セッションチェック**: FrontControllerで管理者権限確認済み
- **SQLインジェクション対策**: PreparedStatementによるパラメータバインディング

## ビューファイル

- **全件一覧画面**: [/WEB-INF/jsp/task/admin/list_all.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_all.jsp)
- **未承認一覧画面**: [/WEB-INF/jsp/task/admin/list_unapproved.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_unapproved.jsp)
- **承認済み一覧画面**: [/WEB-INF/jsp/task/admin/list_approved.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_approved.jsp)
- **差戻し一覧画面**: [/WEB-INF/jsp/task/admin/list_remanded.jsp](../../../src/main/webapp/WEB-INF/jsp/task/admin/list_remanded.jsp)

### 画面表示項目

#### タスク一覧

リクエスト属性 `tasks` (List<Task>) から以下の情報を表示：

| 項目 | 説明 |
|-----|------|
| **チェックボックス** | 一括操作用（未承認・承認済みタブのみ） |
| **業務日** | 作業日（work_date） |
| **開始時刻** | 開始時刻（start_time） |
| **終了時刻** | 終了時刻（end_time） |
| **作業時間** | 作業時間（work_minute、分単位） |
| **顧客名** | 顧客企業名 |
| **秘書名** | 秘書氏名 |
| **ランク** | 業務ランク（A/B/C/D/E） |
| **業務内容** | 作業内容（work_content） |
| **金額（秘書）** | 秘書への支払額（時給×時間） |
| **金額（顧客）** | 顧客からの請求額（時給×時間） |
| **承認日時** | 承認日時（approved_at、承認済みのみ） |
| **差戻日時** | 差戻日時（remanded_at、差戻しのみ） |
| **差戻コメント** | 差戻理由（remand_comment、差戻しのみ） |
| **アクション** | 差戻しボタン（全件タブ）、承認ボタン（未承認タブ）、承認取消ボタン（承認済みタブ） |

#### 集計情報

| 項目 | 説明 |
|-----|------|
| **件数** | タスク件数（count） |
| **合計時間** | 合計作業時間（totalMinute、時:分形式） |
| **合計金額（秘書）** | 秘書側合計金額（sumSecretary） |
| **合計金額（顧客）** | 顧客側合計金額（sumCustomer） |

#### フィルタリング機能

| 機能 | 説明 |
|-----|------|
| **対象月選択** | 年月を指定（yyyy-MM形式） |
| **秘書名検索** | 秘書名で部分一致検索（ILIKE） |
| **顧客名検索** | 顧客名で部分一致検索（ILIKE） |

### 画面アクション

- **全件タブ**: 全タスクを表示、差戻しボタン（`/admin/task/remand_done`）
- **未承認タブ**: 未承認タスクのみ表示、一括承認ボタン（`/admin/task/approve_bulk`）
- **承認済みタブ**: 承認済みタスクのみ表示、一括承認取消ボタン（`/admin/task/unapprove_bulk`）
- **差戻しタブ**: 差戻しタスクのみ表示

## データモデル

### 使用するDTO

- **TaskDTO** ([dto/TaskDTO.java](../../../src/main/java/dto/TaskDTO.java))
  - タスク情報
  - `assignment` フィールドでアサイン情報を保持

- **AssignmentDTO** ([dto/AssignmentDTO.java](../../../src/main/java/dto/AssignmentDTO.java))
  - アサイン情報
  - 顧客名、秘書名、ランク名、単価情報を保持

### 使用するDomainオブジェクト

- **Task** ([domain/Task.java](../../../src/main/java/domain/Task.java))
  - タスク情報（ネストした構造）
  - `assignment` フィールドでAssignmentオブジェクトを保持

- **Assignment** ([domain/Assignment.java](../../../src/main/java/domain/Assignment.java))
  - アサイン情報（ネストした構造）

### リクエスト属性

- **tasks** (List<Task>): タスクリスト
- **sumCustomer** (BigDecimal): 顧客側合計金額
- **sumSecretary** (BigDecimal): 秘書側合計金額
- **totalMinute** (Integer): 合計作業時間（分）
- **count** (Integer): タスク件数
- **yearMonth** (String): 対象月（yyyy-MM）
- **sec** (String): 秘書名検索値（フォーム再表示用）
- **cust** (String): 顧客名検索値（フォーム再表示用）

## エラーハンドリング

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
- トランザクションは自動ロールバック

### 正常系

- データが0件の場合でも正常に表示（空リスト）
- フィルタ条件に一致するデータがない場合も正常表示

## 備考

### タブ切り替えの仕様

- 4つのタブ（全件/未承認/承認済み/差戻し）が用意されている
- 各タブは独立したURL（`/admin/task/list_{タブ名}`）を持つ
- タブ切り替え時もフィルタ条件（yearMonth, sec, cust）は維持される

### フィルタリングの仕様

- 秘書名・顧客名は部分一致検索（大文字小文字無視、ILIKE）
- 複数条件の組み合わせが可能（yearMonth + sec + cust）
- フィルタ条件はフォームに再表示される

### ソート順

- 作業日（work_date）→ 顧客ID（customer_id）→ 開始時刻（start_time）の昇順
- DAOレベルで固定（変更不可）

### 一括操作

- **未承認タブ**: チェックボックスで選択したタスクを一括承認
- **承認済みタブ**: チェックボックスで選択したタスクを一括承認取消
- 詳細は関連機能（32_業務承認.md、34_承認済み業務取消し.md）を参照

### 差戻し機能

- 全件タブから個別に差戻し可能
- 差戻しコメントの入力が必要
- 詳細は関連機能（33_業務差戻し.md）を参照

### 金額計算式

- **顧客支払額** = `(base_pay_customer + increase_base_pay_customer + customer_based_incentive_for_customer) × (work_minute / 60)`
- **秘書受取額** = `(base_pay_secretary + increase_base_pay_secretary + customer_based_incentive_for_secretary) × (work_minute / 60)`

### 使用場面

- 月次の業務確認
- 未承認業務の承認作業
- 承認済み業務の確認・取消
- 差戻し業務の再確認

### 関連機能

- **業務承認** (32_業務承認.md): 未承認タスクの一括承認
- **業務差戻し** (33_業務差戻し.md): タスクの差戻し
- **承認済み業務取消し** (34_承認済み業務取消し.md): 承認済みタスクの承認取消
- **請求サマリー表示** (39_請求サマリー表示.md): 承認済みタスクの集計表示
- **支払サマリー表示** (40_支払サマリー表示.md): 秘書への支払額集計表示
