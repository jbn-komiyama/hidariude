# 21_顧客担当者新規登録（A04_16）

## 機能概要

新しい顧客担当者を登録する機能です。入力→確認→確定の3画面構成で、氏名、メールアドレス、パスワード、連絡先、部署、主担当フラグを登録します。メールアドレスの重複チェック（グローバル）を実施します。主担当フラグを設定した場合、同顧客の他の担当者の主担当フラグは自動的にOFFになります。

## 実装状況

**実装済み**

## URL一覧

| HTTPメソッド | URL | 画面/処理名 | 説明 |
|---|---|---|---|
| GET | `/admin/contact/register?customerId={顧客ID}` | 登録フォーム表示 | 新規登録の入力フォームを表示 |
| POST | `/admin/contact/register_check` | 登録確認 | 入力内容をバリデーション後、確認画面を表示 |
| POST | `/admin/contact/register_done` | 登録確定 | データベースに登録し、完了画面を表示 |

## 画面フロー

```
[担当者一覧画面]
    ↓ 新規登録ボタンをクリック
    ↓ GET /admin/contact/register?customerId={UUID}
    ↓
[登録入力画面] - 担当者情報を入力
    ↓ 確認ボタンをクリック
    ↓ POST /admin/contact/register_check
    |
    ├─ バリデーションエラー → [登録入力画面] へ戻る（エラーメッセージ・入力値保持）
    └─ バリデーションOK → [登録確認画面] へ遷移
        ↓ 確定ボタンをクリック
        ↓ POST /admin/contact/register_done
        |
        ├─ メール重複エラー → [登録入力画面] へ戻る
        ├─ システムエラー → [エラー画面] へリダイレクト
        └─ 登録成功 → [登録完了画面] を表示
```

## バックエンド処理詳細

### サービスクラス

- **クラス**: [ContactService.java](../../../src/main/java/service/ContactService.java)
- **メソッド**:
  - `contactRegister()` (148行目): 登録フォーム表示
  - `contactRegisterCheck()` (163行目): 登録確認
  - `contactRegisterDone()` (205行目): 登録確定

### 処理フロー

#### 1. 登録フォーム表示（GET `/admin/contact/register?customerId={UUID}`）

1. **顧客情報取得・検証**
   - `ensureCustomerOnRequest()` ヘルパーメソッドを使用
   - `customerId`: 顧客ID（UUID形式）
   - `validation.isUuid(customerId)` でUUID形式チェック
   - 不正な形式の場合: "不正な顧客IDが指定されました。" エラー

2. **フォーム表示**
   - `customer` 属性に顧客情報を設定（ヘッダー表示用）
   - 登録ビュー（`contact/admin/register`）へフォワード

#### 2. 登録確認（POST `/admin/contact/register_check`）

1. **入力パラメータ取得**
   - `customerId`: 顧客ID（hidden、必須）
   - `name`: 氏名（必須）
   - `mail`: メールアドレス（必須）
   - `password`: パスワード（必須）
   - `phone`: 電話番号（任意）

2. **バリデーション**
   - 必須チェック:
     - `validation.isNull("顧客ID", customerId)`
     - `validation.isNull("氏名", name)`
     - `validation.isNull("メール", mail)`
     - `validation.isNull("パスワード", password)`
   - 形式チェック:
     - `validation.isEmail(mail)` - メールアドレス形式
     - `validation.isPhoneNumber(phone)` - 電話番号形式（入力がある場合のみ）

3. **メール重複チェック（グローバル）**
   - バリデーションエラーがない場合のみ実施
   - `CustomerContactDAO.mailExists(mail)` でグローバルに重複確認
   - 重複時: "このメールアドレスは既に登録されています。" エラー

4. **エラー時の処理**
   - `errorMsg` 属性にエラーメッセージを設定
   - 入力値を属性に戻す（フォーム再表示用）
   - 顧客情報を再取得して設定
   - 登録入力画面へ戻る

5. **成功時の処理**
   - 入力値を属性に設定
   - 顧客情報を再取得して設定
   - 確認画面（`contact/admin/register_check`）へフォワード

#### 3. 登録確定（POST `/admin/contact/register_done`）

1. **入力パラメータ取得・バリデーション（再実行）**
   - 確認画面と同じパラメータを再取得
   - 追加パラメータ:
     - `nameRuby`: ふりがな（任意）
     - `department`: 部署（任意）
     - `isPrimary`: 主担当フラグ（"true"/"false"）
   - 確認画面と同じバリデーションを再度実行
   - ブラウザバック対策、直接URL入力対策
   - **追加**: パスワード強度チェック `validation.isStrongPassword(password)`

2. **DTOオブジェクト作成**
   - `CustomerContactDTO` に全ての入力値を設定
   - パスワードをBCryptでハッシュ化: `PasswordUtil.hashPassword(password)`
   - 顧客IDを設定: `CustomerDTO` オブジェクトをセット
   - 主担当フラグを boolean に変換

3. **メール重複チェック（再実行）**
   - `CustomerContactDAO.mailExists(mail)` でグローバルに重複確認
   - 重複時: "このメールアドレスは既に登録されています。" エラー

4. **エラー時の処理**
   - エラー時: 入力値を保持して登録入力画面へ戻る
   - 顧客情報を再取得して設定

5. **データベース登録**
   - `CustomerContactDAO.insertReturningId(dto)` で登録実行
   - IDは自動生成（`gen_random_uuid()`）
   - 生成されたIDを取得

6. **主担当フラグ処理**
   - 主担当フラグがONの場合:
     - `CustomerContactDAO.clearPrimaryForCustomer(customerId)` で同顧客の全担当者の主担当フラグをOFF
     - `CustomerContactDAO.setPrimaryById(newId, true)` で自分の主担当フラグをON
   - トランザクションコミット

7. **完了画面表示**
   - `message` 属性に "担当者の登録が完了しました。" を設定
   - 顧客情報を再取得して設定
   - 完了画面（`contact/admin/register_done`）へフォワード

### トランザクション管理

```java
try (TransactionManager tm = new TransactionManager()) {
    UUID customerId = UUID.fromString(cidStr);
    CustomerContactDAO dao = new CustomerContactDAO(tm.getConnection());

    if (dao.mailExists(mail)) {
        validation.addErrorMsg("このメールアドレスは既に登録されています。");
        req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
        pushFormBackToRequest();
        ensureCustomerOnRequest();
        return VIEW_REGISTER;
    }

    CustomerDTO c = new CustomerDTO();
    c.setId(customerId);

    CustomerContactDTO dto = new CustomerContactDTO();
    dto.setCustomerDTO(c);
    dto.setName(name);
    dto.setNameRuby(req.getParameter(P_NAME_RUBY));
    dto.setDepartment(req.getParameter(P_DEPT));
    dto.setMail(mail);
    dto.setPassword(PasswordUtil.hashPassword(pass));
    dto.setPhone(phone);
    dto.setPrimary("true".equalsIgnoreCase(isPrimary));

    UUID newId = dao.insertReturningId(dto);

    if (dto.isPrimary()) {
        dao.clearPrimaryForCustomer(customerId);
        dao.setPrimaryById(newId, true);
    }

    tm.commit();
    req.setAttribute(A_MESSAGE, "担当者の登録が完了しました。");
    ensureCustomerOnRequest();
    return VIEW_REGISTER_DN;

} catch (RuntimeException e) {
    validation.addErrorMsg("データベースに不正な操作が行われました");
    req.setAttribute(A_ERROR_MSG, validation.getErrorMsg());
    ensureCustomerOnRequest();
    return req.getContextPath() + req.getServletPath() + "/error";
}
```

### DAO呼び出し

- **CustomerDAO**
  - `selectByUUId(UUID id)`: 顧客情報を取得（ヘッダー表示用）
    - SQL: `SELECT c.* FROM customers c WHERE c.deleted_at IS NULL AND c.id = ?`

- **CustomerContactDAO**
  - `mailExists(String mail)`: メールアドレス重複チェック（グローバル）
    - SQL: `SELECT COUNT(*) FROM customer_contacts WHERE deleted_at IS NULL AND mail = ?`
    - 戻り値: `boolean`（既に存在すれば true）
  - `insertReturningId(CustomerContactDTO dto)`: 担当者情報を登録し、生成されたIDを返す
    - SQL:
      ```sql
      INSERT INTO customer_contacts (
          id, mail, password, customer_id, name, name_ruby, phone, department, is_primary,
          created_at, updated_at
      ) VALUES (
          gen_random_uuid(), ?, ?, ?, ?, ?, ?, ?, ?,
          CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
      ) RETURNING id
      ```
    - 戻り値: 生成されたID（UUID）
  - `clearPrimaryForCustomer(UUID customerId)`: 指定顧客の全担当者の主担当フラグをOFF
    - SQL: `UPDATE customer_contacts SET is_primary = FALSE, updated_at = CURRENT_TIMESTAMP WHERE customer_id = ?`
  - `setPrimaryById(UUID contactId, boolean isPrimary)`: 指定担当者の主担当フラグを更新
    - SQL: `UPDATE customer_contacts SET is_primary = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`

### セキュリティ

- **パスワード強度チェック**: 8文字以上、英大小数字を含む必要がある（確定処理で実施）
- **パスワードハッシュ化**: BCrypt（コストファクタ10）で保存
- **メール重複チェック**: 同じメールアドレスは登録不可（全顧客の担当者でグローバルに重複チェック）
- **二重バリデーション**: 確認画面と確定処理で2回検証（改ざん対策）
- **主担当正規化**: 1顧客につき1名のみ主担当として設定可能

## ビューファイル

- **登録入力画面**: [/WEB-INF/jsp/contact/admin/register.jsp](../../../src/main/webapp/WEB-INF/jsp/contact/admin/register.jsp)
- **登録確認画面**: [/WEB-INF/jsp/contact/admin/register_check.jsp](../../../src/main/webapp/WEB-INF/jsp/contact/admin/register_check.jsp)
- **登録完了画面**: [/WEB-INF/jsp/contact/admin/register_done.jsp](../../../src/main/webapp/WEB-INF/jsp/contact/admin/register_done.jsp)

### 画面表示項目（登録入力画面）

#### 顧客情報ヘッダー

| 項目 | 説明 |
|------|------|
| **会社コード** | 顧客の会社コード（読み取り専用） |
| **会社名** | 顧客の会社名（読み取り専用） |

#### 担当者情報

| 項目 | 必須 | 説明 |
|-----|------|------|
| **氏名** | ○ | 担当者の氏名 |
| **ふりがな** | - | 氏名のふりがな |
| **部署** | - | 担当者の部署 |
| **メールアドレス** | ○ | ログインIDとして使用、重複不可（グローバル） |
| **パスワード** | ○ | 8文字以上、英大小数字含む |
| **電話番号** | - | 連絡先電話番号（形式チェックあり） |
| **主担当** | - | 主担当フラグ（チェックボックス） |

### 画面アクション

- **確認ボタン**: POST `/admin/contact/register_check` でバリデーション実行
- **戻るボタン**: 担当者一覧画面へ戻る

## データモデル

### 使用するDTO

- **CustomerDTO** ([dto/CustomerDTO.java](../../../src/main/java/dto/CustomerDTO.java))
  - `id` (UUID): 顧客ID

- **CustomerContactDTO** ([dto/CustomerContactDTO.java](../../../src/main/java/dto/CustomerContactDTO.java))
  - `id` (UUID): 自動生成（`gen_random_uuid()`）
  - `customerId` (UUID): 顧客ID（FK）
  - `mail` (String): メールアドレス（UNIQUE, NOT NULL）
  - `password` (String): BCryptハッシュ化パスワード
  - `name` (String): 氏名
  - `nameRuby` (String): ふりがな
  - `phone` (String): 電話番号
  - `department` (String): 部署
  - `isPrimary` (Boolean): 主担当フラグ
  - `createdAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）
  - `updatedAt` (Timestamp): 自動設定（`CURRENT_TIMESTAMP`）

### リクエスト属性

- **customer** (Customer): 顧客情報（ヘッダー表示用）
- **errorMsg** (String): バリデーションエラーメッセージ
- **message** (String): 登録完了メッセージ
- **入力値の属性**（エラー時の再表示用）

## エラーハンドリング

### バリデーションエラー

- **必須チェックエラー**: "氏名 を入力してください" など
- **メール形式エラー**: "メールアドレス の形式が正しくありません"
- **電話番号形式エラー**: "電話番号 の形式が正しくありません"
- **パスワード強度エラー**: "パスワードは8文字以上で、英大文字・小文字・数字を含む必要があります"

### ビジネスロジックエラー

- **メール重複エラー**: "このメールアドレスは既に登録されています。"
  - 登録入力画面へ戻り、入力値を保持

### システムエラー

- **RuntimeException**: エラーページ（`/admin/error`）へリダイレクト
  - エラーメッセージ: "データベースに不正な操作が行われました"
- トランザクションは自動ロールバック

## 備考

### 機能の仕様

- IDはデータベース側で自動生成（UUID）
- 作成日時・更新日時も自動設定
- 削除日時（`deleted_at`）は初期値NULL（有効状態）
- 最終ログイン日時（`last_login_at`）は初期値NULL
- 登録完了後、担当者一覧画面へ戻るリンクが表示される
- パスワードは平文で保存されず、必ずBCryptハッシュで保存される

### 主担当フラグの仕組み

- **1顧客1主担当**: 1つの顧客につき主担当は1名のみ
- **主担当ON時の処理**:
  1. 同顧客の全担当者の主担当フラグをOFFにする（`clearPrimaryForCustomer`）
  2. 新規登録した担当者の主担当フラグをONにする（`setPrimaryById`）
- **主担当OFF時**: 何もしない（他の担当者の主担当フラグは変更されない）
- **トランザクション内で処理**: 主担当の正規化はトランザクション内で実施されるため、途中でエラーが発生した場合はロールバックされる

### メール重複チェックの範囲

- **グローバル重複チェック**: 全顧客の全担当者でメールアドレスの重複をチェック
- 他の顧客の担当者と同じメールアドレスは登録不可
- 秘書（secretaries）とは別管理（重複しても問題ない）

### その他

- 顧客IDは登録画面でhiddenフィールドとして引き継がれる
- 顧客情報ヘッダーは全画面で表示される（どの顧客の担当者を登録しているか明示）
- 電話番号は任意項目で、形式チェックのみ実施
- ふりがな、部署は任意項目で、形式チェックなし
